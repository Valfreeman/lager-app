
<!DOCTYPE html>

<html lang="de">
<head>
  <style>
    .hyphenated {
      hyphens: auto;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      display: inline-block;
    }

        #barcodeVideo video, #barcodeVideo canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    aspect-ratio: 1 / 1 !important;
    background: #222;
    display: block;
    }
    </style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="pageTitle">üì¶ LagerApp</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- üí† –õ–æ–∫–µ—Ä --> 
<div id="globalLoadingOverlay" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center transition-opacity duration-300 hidden">
    <div class="bg-white rounded-2xl px-6 py-4 shadow-xl text-center flex flex-col items-center gap-2">
        <span class="text-3xl animate-spin">‚è≥</span>
        <span id="globalLoadingStatus" class="block text-base font-semibold text-gray-700 mt-2">Bitte warten‚Ä¶</span>
    </div>
    </div>

<!-- üí† –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="mainCardContainer" class="relative max-w-xl mx-auto bg-white rounded-2xl shadow p-6 mt-2 space-y-6">


<!-- üß≠ 0. –•–µ–¥–µ—Ä –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è -->

<div id="loginHeader" class="relative flex justify-between items-center mb-4 relative">
    <h1 class="text-2xl font-bold text-center w-full">üì¶ Lager App v<span id="ver"></span></h1>
    <div class="absolute top-0 right-0 ">
      <button class="text-gray-600 text-2xl" onclick="window.toggleMenu()">‚ãÆ</button>
      <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-lg hidden z-100" id="menu">
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='index.html'">üîç Waren Suche</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='bestellungen.html'">üìÑ Bestellungen</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='warenannahme.html'">üì¶ Warenannahme</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="loginButton" onclick="window.toggleAuthForm()">üîê Anmelden</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 hidden" id="logoutButton" onclick="window.logout()">üö™ Abmelden</button>
      </div>
    </div>
  </div>

  <!-- üì¶ UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
  <div id="mainUIWrapper">

    <!-- üîí 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <section id="authBlock" class="space-y-4">
      <input id="email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <input id="password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <label class="flex items-center mb-2">
        <input id="rememberMe" type="checkbox" class="mr-2" />
        Eingeloggt bleiben
      </label>
      <button onclick="window.login()" class="w-full bg-blue-500 text-white py-2 rounded-xl hover:bg-blue-600">
        Einloggen
      </button>
      <!-- üîÑ –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è -->
      <div class="text-center text-sm text-blue-600 cursor-pointer hover:underline"
      id="switchAuthForms" onclick="window.toggleAuthForm()">
        Noch kein Konto? Registrieren
        </div>
      <p id="authStatus" class="mt-2 text-sm text-gray-500"></p>
    </section>

    <!--—Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏  -->
    <section id="registerBlock" class="space-y-4 hidden">
        <input id="reg_email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_code" type="text" placeholder="Firmen-Code" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <button onclick="window.doRegister()" class="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600">
          Registrieren
        </button>
        <div class="mt-2 text-center text-sm text-blue-600 cursor-pointer hover:underline"
            onclick="window.toggleAuthForm()">
          Bereits registriert? Einloggen
        </div>
        <p id="registerStatus" class="mt-2 text-sm text-gray-500"></p>
      </section>



<!-- üéõÔ∏è –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <section id="mainUI" class="hidden space-y-6">

        <!-- üé≤ 1.5 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞) -->
        <section id="orderGeneratorHeader" class="space-y-2">
            <button id="randomButton" class="w-full bg-yellow-300 text-black py-2 rounded-xl hover:bg-yellow-400">üé≤ Zuf√§lliger Auftrag</button>
          <button class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">‚öôÔ∏è Generator-Einstellungen</button>
        </section>
  
        <!-- üîç 2 –ü–æ–∏—Å–∫ -->
        <section id="searchBlock" class="space-y-4">
          <div class="relative">
            <h2 class="text-xl font-bold mb-2">üîç Artikel suchen & hinzuf√ºgen</h2>
            <input id="searchInput" type="text" placeholder="Artikelnummer oder Name oder Ort..." class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" />
            <div id="suggestions" class="absolute top-full left-0 w-full rounded-xl shadow border bg-white mt-2 hidden z-50">
                <ul id="suggestionsList" class="max-h-60 overflow-y-auto"></ul>
              </div>
          </div>
          <button id="openQRButton" onclick="window.openQRScanner()" class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">
            üì∑ Qr/Barcode scannen
          </button>
          
          <!-- ZXing Browser —Å–∫–∞–Ω–µ—Ä ‚Äî –ú–û–î–£–õ–¨–ù–û! -->
          <script type="module" id="zxingScript">
            // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –ø–æ–∑–∂–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
          </script>



          <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ —Ü–∏—Ñ—Ä -->
            <div id="barcodeScannerModal" class="fixed inset-0 z-[1200] flex items-center justify-center bg-black bg-opacity-70 hidden">
                <div class="relative bg-white rounded-2xl shadow-xl p-4 w-[360px] max-w-full flex flex-col items-center">
                <h2 class="text-lg font-bold mb-4">Digitaler Scanner</h2>
                <div id="barcodeVideo"
                        class="mx-auto rounded-2xl overflow-hidden bg-gray-200 flex items-center justify-center relative aspect-square"
                        style="width: 260px; max-width: 90vw;">

                        <!-- –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –≤–∏–¥–µ–æ -->
                        <div id="qrOverlay"
                            style="position:absolute;left:0;top:0;width:100%;height:100%;
                                border: 3px solid #FFF;
                                border-radius: 24px;
                                box-sizing: border-box;
                                pointer-events:none;
                                z-index:2;">
                        </div>

                        <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –Ω–∞–≤–µ–¥–µ–Ω–∏—è –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É (—Ç–æ–Ω–∫–∞—è –ø–æ–ª–æ—Å–∞/–ª–∏–Ω–∏—è) -->
                        <div
                            style="position:absolute;left:10%;width:80%;top:48%;height:4%;background:rgba(255,255,255,0.19);border-radius:4px;
                            border:1.5px dashed #B0B0B0;z-index:3;pointer-events:none;"></div>
                    </div>
                        <div class="flex gap-2 w-full mt-2 mb-0 items-stretch">
                        <button id="photoOCRButton"
                        class="flex-1 min-w-0 px-4 py-2 bg-green-400 text-white rounded-xl hover:bg-green-600 whitespace-nowrap min-h-12">
                        Foto erkennen
                        </button>
                        <button id="switchCameraButton"
                          class="flex-1 min-w-0 px-4 py-2 bg-blue-400 text-white rounded-xl hover:bg-blue-600 whitespace-nowrap min-h-12">
                          Kamera wechseln
                        </button>
                        <button id="closeBarcodeScanner"
                        class="flex-1 min-w-0 px-4 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 whitespace-nowrap min-h-12">
                        Schlie√üen
                        </button>
                        </div>
                <p class="text-xs text-gray-500 mt-2">Richten Sie die Kamera auf eine 13-stellige Zahlenreihe</p>
                <p class="text-xs text-gray-500 mt-2">Vergessen Sie nicht, diesem wunderbaren Menschen zu l√§cheln.</p> 
                </div>
            </div>

        </section>

        <!-- üìã 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <section id="searchResultsBlock">
          <label class="flex items-center gap-2 mb-2 select-none">
            <input type="checkbox" id="sortByOrtCheckbox" class="h-4 w-4" checked>
            <span>Sortieren nach Ort</span>
            </label>
        </section>
        <!-- Dev: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <div id="volumeToggleContainer" class="flex items-center gap-2 mb-2 select-none">
            <input type="checkbox" id="toggleVolumeBlock" class="h-4 w-4" checked />
            <label for="toggleVolumeBlock" class="text-sm text-gray-600 cursor-pointer">
            üì¶ 
            </label>
        </div>
        <!-- üõí 4 –ö–æ—Ä–∑–∏–Ω–∞ -->
        <section id="cartBlock" class="space-y-2">
          <h2 class="text-xl font-bold mb-2">üßæ Ausgew√§hlte Artikel</h2>
          <div id="cartItems"><p class="text-gray-500 italic">Noch keine Artikel</p></div>
          <div id="cartItems" style="min-height: 8px;"></div>
        </section>
  
        <!-- üì¶ 5 –ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å -->
        <section id="volumeInfoBlock" class="text-sm text-gray-600">
          <div id="boxSummary">üì¶ Mittel Box ‚Äì 0% voll</div>
          <div id="initialBoxInfo">üì¶ Gesch√§tzte Box ‚Äì 0% geplant</div>
        </section>
  
        <!-- üöö 6. –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <section id="actionButtonsBlock">
            <div class="flex justify-between gap-2 mb-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ‚ûï Automatisch auff√ºllen
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                üóëÔ∏è Unreservierte Artikel entfernen
              </button>
            </div>
            <div class="flex justify-between gap-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ‚úîÔ∏è Pr√ºfen & reservieren
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                üö´ Alle Reservierungen aufheben
              </button>
            </div>
          </section>
  
      </section>
    </div>

        <!-- ‚ûï 7. –ú–æ–¥–∞–ª–∫–∞ Menge -->
        <div id="mengeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ -->
      </div>
  
      <!-- ‚ùó 8. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
      <div id="confirmationModals" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- TODO: –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ -->
      </div>
  
      <!-- üí¨ 9. UI-—Å–æ–æ–±—â–µ–Ω–∏—è -->
      <div id="notificationArea" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-300 text-red-800 p-3 rounded-xl shadow-md hidden">
    <!-- TODO: –û—à–∏–±–∫–∏ / –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  </div>
  <div class="bg-orange-400 hidden">purge-keep</div>

  <script type="module">
    
    // –∞–≤—Ç–æ –º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
    window.appVersion = " 6.36"; // ‚Üê –ú–µ–Ω—è–µ—à—å —Ç–æ–ª—å–∫–æ —Ç—É—Ç

    const FC64 = "TEFHRVIyMDI1"; 

    function decodeBase64(str) {
    try {
        return atob(str);
    } catch {
        return "";
    }
    }


    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
document.addEventListener("click", function (e) {
  const menu = document.getElementById("menu");
  const toggleBtn = document.querySelector("button[onclick*='toggleMenu']");
  if (
    menu &&
    !menu.classList.contains("hidden") &&
    !menu.contains(e.target) &&
    e.target !== toggleBtn
  ) {
    menu.classList.add("hidden");
  }
});

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
  // –§–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.isCatalogReady = false;       // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ (Google –¢–∞–±–ª–∏—Ü–∞)
  window.isUserReady = false;          // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.tryRestoreExecuted = false;   // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞

  // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –í–°–Å –≥–æ—Ç–æ–≤–æ!
  window.tryRestoreCart = function () {
    //–∫–æ–Ω—Å–æ–ª—å
    console.warn("üí° –í–•–û–î –≤ tryRestoreCart", {
  isCatalogReady: window.isCatalogReady,
  isUserReady: window.isUserReady,
  currentUser: window.currentUser
    });


    if (window.tryRestoreExecuted) return; // –£–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏
    if (window.isCatalogReady && window.isUserReady && window.currentUser) {
      console.log("‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É...");
      window.tryRestoreExecuted = true;
      window.restoreCartFromFirestore(window.currentUser.uid)
      .then(() => window.hideGlobalLoading());
    } else {
      console.log("‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ", {
        isCatalogReady: window.isCatalogReady,
        isUserReady: window.isUserReady,
        currentUser: window.currentUser
      });
    }
  };



    // ================================
    // üß≠ JS 0. –•–µ–¥–µ—Ä –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è
    // ================================
  
    

    /*
  ===============================================
  ‚ùóÔ∏è –ü–∞–º—è—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã: –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ OK/Cancel

  - –í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∫–∞–∂–¥–∞—è –º–æ–¥–∞–ª–∫–∞ (–ª–æ–≥–∏–Ω, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Menge –∏ –¥—Ä.)
  —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ ‚Äî —Å–æ —Å–≤–æ–∏–º–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∫–Ω–æ–ø–æ–∫ OK –∏ Cancel.
  - –£–Ω–∏–≤–µ—Ä—Å–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤—ã–Ω–æ—Å –≤ –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è!
  - –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–ª–∏ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ok/cancel) –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö
  –º–æ–¥–∞–ª–∫–∞—Ö, —ç—Ç–æ –ù–ï —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è.
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —É—Å—Ç–æ–π—á–∏–≤–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∂–¥–æ–π –º–æ–¥–∞–ª–∫–∏, –¥–∞–∂–µ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–¥–∞.
  - –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–∞–ª–æ–∫ ‚Äî –æ–±—Å—É–∂–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ.
  ===============================================
  */

  /*
  ‚Äú–í –ª—é–±–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –≥–¥–µ –º–µ–Ω—è–µ—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã, –ø–æ—Å–ª–µ renderCart() –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–æ–≤ updateCartButtons(). 
  –ù–µ —ç–∫–æ–Ω–æ–º–∏–º —Å—Ç—Ä–æ—á–∫–∏, –Ω–µ –≤—ã–Ω–æ—Å–∏–º –≤ –æ–±—â–∏–π renderCart, –Ω–µ –¥–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫–µ!‚Äù –Ω–µ –º–µ–Ω—è–µ–º –∏ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç! 
  –≠—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–µ, –∏–¥—É—Ç –ª–æ–≥–∏—á–Ω–æ –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º. –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–∫, –µ—Å–ª–∏ —á—Ç–æ –æ–±—Å—É–∂–¥–∞–µ–º!
*/
/*
‚ùóÔ∏è –ü–∞–º—è—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã:
–∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ firebase setup.JS
*/

//=============================================================================
// === —Ñ–ª–∞–≥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ—Ä—Ç true
//=============================================================================
window.sortByOrt = true;

//—Ñ—É–Ω–∫—Ü–∏—è –ª–æ–∫–µ—Ä–æ–≤
window.showGlobalLoading = function (msg) {
  const overlay = document.getElementById("globalLoadingOverlay");
  const status = document.getElementById("globalLoadingStatus");
  if (overlay) overlay.classList.remove("hidden");
  if (status && msg) status.textContent = msg || "";
};
window.hideGlobalLoading = function () {
  const overlay = document.getElementById("globalLoadingOverlay");
  if (overlay) overlay.classList.add("hidden");
};


window.toggleMenu = function () {
  // –ü–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é ‚Äî —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");

  if (window.currentUser) {
    loginBtn?.classList.add("hidden");
    logoutBtn?.classList.remove("hidden");
  } else {
    loginBtn?.classList.remove("hidden");
    logoutBtn?.classList.add("hidden");
  }

  // –ü–æ—Ç–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–º–æ –º–µ–Ω—é
  const menu = document.getElementById("menu");
  if (menu) menu.classList.toggle("hidden");
};


// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é!
// –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∞–º–∏ "Anmelden"/"Abmelden" —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ toggleMenu,
// –∏–Ω–∞—á–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≤ DOM (menu –µ—â–µ —Å–∫—Ä—ã—Ç–æ).


  // ========================
  // üîí JS 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  // ========================
  // === –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ "—É—Ö–æ–¥–∏—Ç—å –≤ –º–∏–Ω—É—Å" –ø–æ —Å–∫–ª–∞–¥—É ===
    window.infiniteMode = true; // true ‚Äî –≤–∫–ª—é—á–µ–Ω–æ (–º–æ–∂–Ω–æ —É—Ö–æ–¥–∏—Ç—å –≤ –º–∏–Ω—É—Å), false ‚Äî –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º

  window.appState = window.appState || {};
    //=============================================================================
    // === –≥–ª–æ–±–∞–ª—å–Ω—ã–π –Ω–∞–±–ª—é–¥–∞–ª–∫
    //=============================================================================
    Object.defineProperty(window.appState, 'selectedItems', {
        set(value) {
            console.warn('selectedItems SET:', value);
            this._selectedItems = value;
        },
        get() {
            return this._selectedItems;
        },
        configurable: true
        });
        window.appState._selectedItems = [];


  window.login = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const remember = document.getElementById("rememberMe").checked;
  const persistence = remember ? window.browserSessionPersistence : window.inMemoryPersistence;

  try {
    await window.setPersistence(window.auth, persistence);
    const result = await window.signInWithEmailAndPassword(window.auth, email, password);
    document.getElementById("authStatus").textContent = `‚úÖ Eingeloggt als ${result.user.email}`;


    // ‚¨áÔ∏è –ß–∏—Å—Ç–∏–º –ø–æ–ª—è
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";


  } catch (err) {
    document.getElementById("authStatus").textContent = `‚ùå Fehler: ${err.message}`;
  }
};

window.logout = async function () {
  try {
    await window.signOut(window.auth);
    console.info("üö™ Benutzer wurde abgemeldet.");
    document.getElementById("authStatus").textContent = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";

    const menu = document.getElementById("menu");
    if (menu) menu.classList.add("hidden");
  } catch (err) {
    console.error("Fehler beim Logout:", err);
  }
};

// –∫–æ–Ω—Å–æ–ª—å –∫ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ —è–≤–Ω–æ —á—Ç–æ —Ç–æ –µ—â–µ 
window.restoreCartFromFirestore = async function(userId) {
  console.warn("=== –í–•–û–î –≤ restoreCartFromFirestore, userId:", userId);
  // –≤–æ—Ç —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì

  console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  const userCartRef = window.doc(window.db, "user_cart", userId);
  const cartSnap = await window.getDoc(userCartRef);

  if (cartSnap.exists()) {
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ –∏–∑ Firestore:', cartSnap.data());
    window.appState.selectedItems = cartSnap.data().items || [];
    // === –í–û–¢ –°–Æ–î–ê –í–°–¢–ê–í–¨ –ö–û–ù–°–û–õ–¨! ===
    console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  } else {
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ –∏–∑ Firestore: –ø—É—Å—Ç–æ');
    window.appState.selectedItems = [];
    // –ò —Å—é–¥–∞ —Ç–æ–∂–µ –¥–ª—è –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã:
    console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};

// –£–¥–∞–ª—è–µ—Ç –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –≤—Å–µ –ø–æ–ª—è —Å –ø—É—Å—Ç—ã–º –∫–ª—é—á–æ–º
function cleanItem(item) {
  return Object.fromEntries(
    Object.entries(item).filter(([key]) => key && key.trim() !== "")
  );
}


window.saveReservedCartToFirestore = async function(userId) {
  const reservedItems = window.appState.selectedItems
    .filter(item => item.status === 'reserved')
    .map(cleanItem); // <--- –≤–æ—Ç —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!

  const userCartRef = window.doc(window.db, "user_cart", userId);
  console.log('‚Üí reservedItems:', reservedItems);
reservedItems.forEach((item, idx) => {
  console.log('item', idx, item);
});
  await window.setDoc(userCartRef, {
    items: reservedItems
  });
};

// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–µ–∂–¥—É —Ñ–æ—Ä–º–æ–π –≤—Ö–æ–¥–∞ –∏ —Ñ–æ—Ä–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
window.toggleAuthForm = function () {
  // üö¶ –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —é–∑–µ—Ä –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –∑–∞–ø—Ä–µ—â–∞–µ–º –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ª—é–±—ã–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!
  if (window.currentUser) {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, "–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã".
    return;
  }
  const authBlock = document.getElementById('authBlock');
  const registerBlock = document.getElementById('registerBlock');
  if (!authBlock || !registerBlock) return;

  authBlock.classList.toggle('hidden');
  registerBlock.classList.toggle('hidden');
  // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ç—É—Å—ã –æ—à–∏–±–æ–∫/—É—Å–ø–µ—Ö–∞
  const authStatus = document.getElementById('authStatus');
  const registerStatus = document.getElementById('registerStatus');
  if (authStatus) authStatus.textContent = "";
  if (registerStatus) registerStatus.textContent = "";
};

// üåü –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Firebase Auth
window.doRegister = async function () {
  const email = document.getElementById("reg_email").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const code = document.getElementById("reg_code").value.trim();

  const FIRMA_CODE = decodeBase64(FC64);
  if (code !== FIRMA_CODE) {
    document.getElementById("registerStatus").textContent = "‚ùå Ung√ºltiger Firmen-Code!";
    return;
  }

  if (!email || !password) {
    document.getElementById("registerStatus").textContent = "‚ùå Email und Passwort erforderlich";
    return;
  }
  try {
    const result = await window.createUserWithEmailAndPassword(window.auth, email, password);
    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –≤—ã–¥–∞—ë–º –ø—Ä–∞–≤–∞ –≤ user_meta
    const userMetaRef = window.doc(window.db, "user_meta", result.user.uid);
    await window.setDoc(userMetaRef, { allowed: true });
    document.getElementById("registerStatus").textContent = "‚úÖ Registrierung erfolgreich! Bitte einloggen.";
    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    document.getElementById("reg_email").value = "";
    document.getElementById("reg_password").value = "";
    document.getElementById("reg_code").value = "";
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞)
    window.toggleAuthForm();

  } catch (err) {
    document.getElementById("registerStatus").textContent = "‚ùå Fehler: " + err.message;
  }
};


// ========================
// üßæ JS 1.1 –ü–æ–≤–µ–¥–µ–Ω–∏–µ Enter –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞
// ========================
document.addEventListener("keydown", function (e) {
  const authBlock = document.getElementById("authBlock");
  const isVisible = authBlock && !authBlock.classList.contains("hidden");

  if (!isVisible) return;

  const activeElement = document.activeElement;

  if (e.key === "Enter") {
    if (activeElement.id === "email") {
      e.preventDefault();
      document.getElementById("password")?.focus();
    } else if (activeElement.id === "password") {
      e.preventDefault();
      window.login();
    }
  }
});
    
    // ============================
    // üé≤ JS 1.5 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤
    // ============================
    window.handleRandomButtonClick = function () {
  // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  const items = window.appState.selectedItems || [];
  if (items.length > 0) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å —Ç—Ä–µ–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
    const modal = document.getElementById("confirmationModals");
    if (modal) {
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen">
          <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
            <h2 class="text-xl font-bold mb-3">Warenkorb ist nicht leer!</h2>
            <div class="text-lg text-gray-800 mb-4">
              Neue Bestellung generieren?<br>
              <span class="text-xs text-gray-500">Die alten Artikel werden entfernt.</span>
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="window.generateSmartOrder(true)" class="px-4 py-2 rounded-xl bg-blue-500 text-white hover:bg-blue-600">√úberschreiben</button>
              <button onclick="window.generateSmartOrder(false)" class="px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">Zum Warenkorb hinzuf√ºgen</button>
              <button onclick="window.hideDeleteConfirm()" class="px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove("hidden");
      window.appState.modalOpen = true;
    }
  } else {
    // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ ‚Äî —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
    window.generateSmartOrder(true);
  }
};

// === JS 1.6 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–æ–±–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –≥—Ä—É–ø–ø ===
window.generateSmartOrder = function (replace) {
  window.hideDeleteConfirm?.();

  // 1. –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –µ—Å–ª–∏ replace
  if (replace) {
    window.appState.selectedItems = [];
    console.log("üîÑ –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∑–∞–∫–∞–∑–∞");
  } else {
    console.log("‚ûï –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç —Ç–æ–≤–∞—Ä—ã –∫ —Ç–µ–∫—É—â–µ–π –∫–æ—Ä–∑–∏–Ω–µ");
  }

  if (!window.artikelListe || window.artikelListe.length === 0) {
    window.showNotification?.("–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!", "error");
    return;
  }

  // 2. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –∫–æ—Ä–æ–±–∫—É: gross –∏–ª–∏ mittel
  const boxType = Math.random() < 0.5 ? "gross" : "mittel";
  const boxVolumes = { gross: 31635, mittel: 9720 };
  const boxNames = { gross: "Gro√üe Box", mittel: "Mittel Box" };
  const boxVol = boxVolumes[boxType];
  console.log("üü© –í—ã–±—Ä–∞–Ω–∞ –∫–æ—Ä–æ–±–∫–∞:", boxType, "| –æ–±—ä—ë–º:", boxVol);

  // 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º —Ä–∞–Ω–¥–æ–º)
  const structure = boxType === "gross"
    ? { big: 0.6, mittel: 0.3, klein: 0.1 }
    : { big: 0.4, mittel: 0.4, klein: 0.2 };
  console.log("üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (big/mittel/klein):", structure);

  // 4. –†–∞–∑–±–∏–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –≥—Ä—É–ø–ø–∞–º
  const groups = window.splitArtikelByGroups(boxType);


  // 5. –ó–∞–≥–æ—Ç–æ–≤–∫–∞ ‚Äî –≤—ã–≤–µ—Å—Ç–∏ info –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
  console.log("üì¶ –¢–æ–≤–∞—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º:", {
    big: groups.big.length,
    mittel: groups.mittel.length,
    klein: groups.klein.length
  });
  // === 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∑–∞–∫–∞–∑–∞ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ ===

  // –í—Å–ø–æ–º–æ–≥–∞–ª–∫–∞: –≤–∑—è—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞
  function getRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  // 1. –ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–∫–∞–∑–∞ (–±—É–¥—É—â–∏–π –º–∞—Å—Å–∏–≤ –¥–ª—è selectedItems)
  let draft = [];
  console.log("–ß–µ—Ä–Ω–æ–≤–∏–∫ draft –ò–ó–ù–ê–ß–ê–õ–¨–ù–û:", draft);
  let usedArtikelNummern = new Set();

  // 2. –°—á–∏—Ç–∞–µ–º –Ω—É–∂–Ω—ã–µ –æ–±—ä—ë–º—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
  const targetBig = boxVol * structure.big;
  const targetMittel = boxVol * structure.mittel;
  const targetKlein = boxVol * structure.klein;

  // 3. –°—á—ë—Ç—á–∏–∫ –Ω–∞–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ (–ø–æ –≥—Ä—É–ø–ø–∞–º)
  let volBig = 0, volMittel = 0, volKlein = 0;

  // === BIG ===
  let tryBig = [...groups.big];
  while (tryBig.length && volBig < targetBig) {
    let artikel = getRandom(tryBig);
    tryBig = tryBig.filter(x => x.Artikelnummer !== artikel.Artikelnummer); // –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
    let menge = 1 + Math.floor(Math.random() * 3); // 1‚Äì3
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volBig + sumVol > targetBig * 1.12) break; // –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ–º!
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volBig += sumVol;
  }

  // === MITTEL ===
  let tryMittel = [...groups.mittel];
  while (tryMittel.length && volMittel < targetMittel) {
    let artikel = getRandom(tryMittel);
    tryMittel = tryMittel.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = 2 + Math.floor(Math.random() * 3); // 2‚Äì4
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volMittel + sumVol > targetMittel * 1.15) break;
    if (usedArtikelNummern.has(artikel.Artikelnummer)) continue; // —É–∂–µ –µ—Å—Ç—å –≤ –∑–∞–∫–∞–∑–µ
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volMittel += sumVol;
  }

  // === KLEIN ===
  let tryKlein = [...groups.klein];
  while (tryKlein.length && volKlein < targetKlein) {
    let artikel = getRandom(tryKlein);
    tryKlein = tryKlein.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = 3 + Math.floor(Math.random() * 5); // 3‚Äì7
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volKlein + sumVol > targetKlein * 1.3) break;
    if (usedArtikelNummern.has(artikel.Artikelnummer)) continue;
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volKlein += sumVol;
  }
  // === –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ ===
  let totalVol = draft.reduce((sum, x) => sum + x.Volumen * x.Menge, 0);
    let filledPercent = Math.round((totalVol / boxVol) * 100);

  /// === –î–û–ó–ê–ü–û–õ–ù–Ø–ï–ú –∫–æ—Ä–∑–∏–Ω—É –¥–æ 90% mittel/klein, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ, –ù–û –Ω–µ –±–æ–ª—å—à–µ 12 –ø–æ–∑–∏—Ü–∏–π ===
if (filledPercent < 90 && draft.length < 12) {
  // –°–Ω–∞—á–∞–ª–∞ mittel, –ø–æ—Ç–æ–º klein, –æ–±–∞ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã
  let tryExtra = [
    ...[...groups.mittel, ...groups.klein].filter(x => !draft.some(y => y.Artikelnummer === x.Artikelnummer))
  ];
  while (filledPercent < 110 && tryExtra.length && draft.length < 12) {
    let artikel = getRandom(tryExtra);
    tryExtra = tryExtra.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = artikel.Volumen > 600
      ? (1 + Math.floor(Math.random() * 2))
      : (2 + Math.floor(Math.random() * 4));
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    draft.push({
      Artikelnummer: artikel.Artikelnummer,
      Artikelbezeichnung: artikel.Artikelbezeichnung,
      Menge: menge,
      Ort: artikel.Ort,
      Volumen: artikel.Volumen,
      status: "unverified"
    });
    totalVol += sumVol;
    filledPercent = Math.round((totalVol / boxVol) * 100);
  }
}
  // 6. –ö–ª–∞–¥—ë–º draft –≤ –∫–æ—Ä–∑–∏–Ω—É
  if (!replace && window.appState.selectedItems.length > 0) {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É
    draft = [...window.appState.selectedItems, ...draft];
  }
  window.appState.selectedItems = draft;

  // 7. –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å—é –∫–æ—Ä–æ–±–∫–∏
  const boxSummary = document.getElementById("boxSummary");
  if (boxSummary) {
    boxSummary.textContent = `üì¶ ${boxNames[boxType]} ‚Äì ${filledPercent}% voll (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: big ${Math.round(volBig)}, mittel ${Math.round(volMittel)}, klein ${Math.round(volKlein)})`;
  }
  console.log("–ß–µ—Ä–Ω–æ–≤–∏–∫ draft –ü–û–°–õ–ï –ù–ê–ü–û–õ–ù–ï–ù–ò–Ø:", draft);
  window.appState.selectedItems = draft;

  window.renderCart?.();
  window.updateCartButtons?.(window.appState.selectedItems);
  window.renderActionButtons?.();
};


// === JS 1.7 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ ‚Äî —Ä–∞–∑–º–µ—Ç–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º ===
window.splitArtikelByGroups = function (boxType) {
  // boxType: 'gross' –∏–ª–∏ 'mittel'
  const TOO_BIG_LIMITS = { gross: 31635, mittel: 9720 };
  const LIMITS = {
    gross: { big: 3500, mittel: 800 },
    mittel: { big: 1166, mittel: 583 }
  };

  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (–µ—Å—Ç—å Volumen > 0, –Ω–µ—Ç oversize)
  const artikelValid = window.artikelListe.filter(row => {
    const v = parseFloat(String(row.Volumen || "").replace(",", "."));
    const isOversize = String(row.L || "").toLowerCase() === "true";
    return v > 0 && !isOversize &&
      (!TOO_BIG_LIMITS[boxType] || v <= TOO_BIG_LIMITS[boxType]);
  });

  // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –≥—Ä—É–ø–ø–∞–º
  let groups = { big: [], mittel: [], klein: [] };
  for (const row of artikelValid) {
    const v = parseFloat(String(row.Volumen || "").replace(",", "."));
    if (boxType === "gross") {
      if (v > LIMITS.gross.big) groups.big.push(row);
      else if (v > LIMITS.gross.mittel) groups.mittel.push(row);
      else groups.klein.push(row);
    } else {
      if (v > LIMITS.mittel.big) groups.big.push(row);
      else if (v > LIMITS.mittel.mittel) groups.mittel.push(row);
      else groups.klein.push(row);
    }
  }
  // –õ–æ–≥ –¥–ª—è –¥–µ–±–∞–≥–∞
  console.log(`üì¶ ${boxType} —Ä–∞–∑–º–µ—Ç–∫–∞: big=${groups.big.length}, mittel=${groups.mittel.length}, klein=${groups.klein.length}`);
  return groups;
};
/*
// === JS 1.8 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–æ–±–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –≥—Ä—É–ø–ø ===
window.generateSmartOrderv666 = function (replace) {
  window.hideDeleteConfirm?.();

  // 1. –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –µ—Å–ª–∏ replace
  if (replace) {
    window.appState.selectedItems = [];
    console.log("üîÑ –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∑–∞–∫–∞–∑–∞");
  } else {
    console.log("‚ûï –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç —Ç–æ–≤–∞—Ä—ã –∫ —Ç–µ–∫—É—â–µ–π –∫–æ—Ä–∑–∏–Ω–µ");
  }

  if (!window.artikelListe || window.artikelListe.length === 0) {
    window.showNotification?.("–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!", "error");
    return;
  }

  // 2. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –∫–æ—Ä–æ–±–∫—É: gross –∏–ª–∏ mittel
  const boxType = Math.random() < 0.5 ? "gross" : "mittel";
  const boxVolumes = { gross: 31635, mittel: 9720 };
  const boxNames = { gross: "Gro√üe Box", mittel: "Mittel Box" };
  const boxVol = boxVolumes[boxType];
  console.log("üü© –í—ã–±—Ä–∞–Ω–∞ –∫–æ—Ä–æ–±–∫–∞:", boxType, "| –æ–±—ä—ë–º:", boxVol);

  // 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–µ–º —Ä–∞–Ω–¥–æ–º)
  const structure = boxType === "gross"
    ? { big: 0.6, mittel: 0.3, klein: 0.1 }
    : { big: 0.4, mittel: 0.4, klein: 0.2 };
  console.log("üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (big/mittel/klein):", structure);

  // 4. –†–∞–∑–±–∏–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –≥—Ä—É–ø–ø–∞–º
  const groups = window.splitArtikelByGroups(boxType);

  // 5. –ó–∞–≥–æ—Ç–æ–≤–∫–∞ ‚Äî –≤—ã–≤–µ—Å—Ç–∏ info –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
  console.log("üì¶ –¢–æ–≤–∞—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º:", {
    big: groups.big.length,
    mittel: groups.mittel.length,
    klein: groups.klein.length
  });
  // --- –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ù–ê –°–õ–ï–î–£–Æ–©–ï–ú –®–ê–ì–ï!) ---

  // 6. –í–Ω–∏–∑—É –≤—ã–≤–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ—Ä–æ–±–∫—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—Ç–µ—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥)
  const boxSummary = document.getElementById("boxSummary");
  if (boxSummary) {
    boxSummary.textContent = `üì¶ ${boxNames[boxType]} ‚Äì 0% voll (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: ${Math.round(structure.big*100)}/${Math.round(structure.mittel*100)}/${Math.round(structure.klein*100)})`;
  }
  // –ú–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –µ—â—ë debug-—Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–∞–¥–æ
  window.renderCart?.();
  window.renderActionButtons?.();
};

*/





// === –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (randomButton) ===
document.addEventListener("DOMContentLoaded", function () {
  const randomBtn = document.getElementById("randomButton");
  if (randomBtn) {
    randomBtn.onclick = window.handleRandomButtonClick;
  }
  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "‚ùå –ó–∞–∫—Ä—ã—Ç—å" –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤
  const closeBtn = document.getElementById('closeBarcodeScanner');
  if (closeBtn) {
    closeBtn.onclick = window.closeBarcodeScanner;
  }
});
    // TODO: generateOrder(), openSettingsPanel(), applyRandomOrder()

    // ========================
    // üîç JS 2. –ü–æ–∏—Å–∫ + QR
    // ========================
    // TODO: handleSearchInput(), openQRScanner(), onQRScanResult()
    window.openQRScanner = async function () {
  if (window._qrTransitioning) return;
  window._qrTransitioning = true;

  // Disable –∫–Ω–æ–ø–∫—É –æ—Ç–∫—Ä—ã—Ç–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const openBtn = document.getElementById('openQRButton');
  if (openBtn) openBtn.disabled = true;

  try {
    const modal = document.getElementById('barcodeScannerModal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    const videoElem = document.getElementById('barcodeVideo');
    videoElem.innerHTML = "";
    videoElem.style.display = 'block';

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (window._html5QrcodeScanner) {
      try {
        await window._html5QrcodeScanner.stop();
        await window._html5QrcodeScanner.clear();
      } catch (e) {
        // –¥–∞–∂–µ –µ—Å–ª–∏ stop –Ω–µ—É—Å–ø–µ—à–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å
        try { await window._html5QrcodeScanner.clear(); } catch {}
      }
      window._html5QrcodeScanner = null;
    }

    // –ü–æ–¥–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å, –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –Ω–æ–≤–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
    let started = false;
    window._html5QrcodeScanner = new Html5Qrcode("barcodeVideo");
    if (!window._qrCameras) window._qrCameras = [];
    if (typeof window._qrCurrentCamIndex !== 'number') window._qrCurrentCamIndex = 0;

    await Html5Qrcode.getCameras().then(async cameras => {
      window._qrCameras = cameras || [];
      if (!cameras.length) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞!");

      if (typeof window._qrCurrentCamIndex !== 'number' || window._qrCurrentCamIndex >= cameras.length) {
        window._qrCurrentCamIndex = 0;
      }

      let camId = cameras[window._qrCurrentCamIndex].id;

      await window._html5QrcodeScanner.start(
        camId,
        { fps: 12, qrbox: 220 },
        (decodedText, decodedResult) => {
          // ... 
        },
        (errorMessage) => { /* ignore */ }
      ).then(() => {
        started = true;
        window._qrTransitioning = false;
        if (openBtn) openBtn.disabled = false;
      }).catch(err => {
        window._qrTransitioning = false;
        if (openBtn) openBtn.disabled = false;
        alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞: " + (err?.message || err));
        window.closeBarcodeScanner();
      });

      const switchBtn = document.getElementById('switchCameraButton');
      if (switchBtn) {
        switchBtn.onclick = async function () {
          try {
            if (window._html5QrcodeScanner) {
              await window._html5QrcodeScanner.stop();
              await window._html5QrcodeScanner.clear();
            }
          } catch (e) {}
          window._html5QrcodeScanner = null;
          window._qrCurrentCamIndex = (window._qrCurrentCamIndex + 1) % cameras.length;
          window.openQRScanner();
        };
      }
    }).catch(err => {
      window._qrTransitioning = false;
      if (openBtn) openBtn.disabled = false;
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É");
      window.closeBarcodeScanner();
    });
    // <<-- –≠–¢–ê –°–ö–û–ë–ö–ê –ó–ê–ö–†–´–í–ê–ï–¢ .then().catch()

  } catch (err) {
    window._qrTransitioning = false;
    const openBtn = document.getElementById('openQRButton');
    if (openBtn) openBtn.disabled = false;
    alert("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞: " + (err?.message || err));
    window.closeBarcodeScanner();
  }
};


/// ===========================
// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–∫—Ä—ã–≤–∞–ª–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å"
// ===========================
window.closeBarcodeScanner = async function () {
  if (window._qrClosing) return;
  window._qrClosing = true;

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å" –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É–ª–¥–∞—É–Ω
  const closeBtn = document.getElementById('closeBarcodeScanner');
  let cooldown = 5;
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.classList.add('opacity-60', 'cursor-not-allowed');
    const origText = closeBtn.textContent;
    closeBtn.textContent = `‚è≥ Bitte warten  (${cooldown})`;
    // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
    const timer = setInterval(() => {
      cooldown--;
      if (cooldown > 0) {
        closeBtn.textContent = `‚è≥ Bitte warten  (${cooldown})`;
      } else {
        clearInterval(timer);
        closeBtn.textContent = origText || "‚ùå Schlie√üen";
        closeBtn.disabled = false;
        closeBtn.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    }, 1000);
  }

  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º —Å–∫–∞–Ω–µ—Ä
  try {
    if (window._html5QrcodeScanner) {
      await window._html5QrcodeScanner.stop();
      await window._html5QrcodeScanner.clear();
      window._html5QrcodeScanner = null;
    }
  } catch (e) {
    try { await window._html5QrcodeScanner.clear(); } catch {}
    window._html5QrcodeScanner = null;
  }

  // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª—å
  const modal = document.getElementById('barcodeScannerModal');
  if (modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
  const videoElem = document.getElementById('barcodeVideo');
  if (videoElem) {
    videoElem.innerHTML = "";
    videoElem.style.display = 'none';
  }

  // –ü–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥ —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥–∏
  setTimeout(() => {
    window._qrTransitioning = false;
    window._qrClosing = false;
    const openBtn = document.getElementById('openQRButton');
    if (openBtn) openBtn.disabled = false;
  }, 5000);
};



    //–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–ª–∫–∞ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
    if (searchInput) {
        searchInput.addEventListener("click", function () {
            setTimeout(() => {
            // –°–∫—Ä–æ–ª–ª–∏–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –±—ã–ª–∞ ~32px –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const rect = searchInput.getBoundingClientRect();
            const absoluteY = window.scrollY + rect.top;
            window.scrollTo({
                top: absoluteY - 32, // 32px ‚Äî –∂–µ–ª–∞–µ–º—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
                behavior: "smooth"
            });
            }, 50);
        });
        }


    const suggestionsBox = document.getElementById("suggestions");
    const suggestionsList = document.getElementById("suggestionsList");

    searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase().replace(/\//g, "").trim();
  if (!query || !window.appState.artikelListe) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const matches = window.appState.artikelListe.filter(row => {
  if (!row.Artikelnummer || !row.Artikelbezeichnung || !row.Ort) return false;

  const ort = String(row.Ort).toLowerCase().replace(/\//g, '');
  const nummer = String(row.Artikelnummer).toLowerCase();
  const name = String(row.Artikelbezeichnung).toLowerCase();
  return ort.includes(query) || nummer.includes(query) || name.includes(query);
});


  if (matches.length === 0) {
    suggestionsList.innerHTML = `<li class="px-4 py-2 text-gray-500 italic">Keine Ergebnisse</li>`;
  } else {
    suggestionsList.innerHTML = matches.map(row => `
      <li class="flex justify-between items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
        <span>${row.Ort} ‚Äî ${row.Artikelnummer} ‚Äî ${row.Artikelbezeichnung}</span>
        <button onclick="window.openMengeModal(${JSON.stringify(row).replace(/"/g, '&quot;')})" class="text-green-600 text-xl ml-2">‚ûï</button>
      </li>
    `).join("");
  }

  suggestionsBox.classList.remove("hidden");
  document.addEventListener("click", (e) => {
  const inside = searchInput.contains(e.target) || suggestionsBox.contains(e.target);
  if (!inside && !window.appState.modalOpen) {
    suggestionsBox.classList.add("hidden");
    searchInput.value = "";
  }
});


});
    // ========================
    // üìã JS 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    // ========================
    // TODO: renderSearchResults()

    // ========================
    // üõí JS 4. –ö–æ—Ä–∑–∏–Ω–∞
    // ========================

    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–æ–≤–∞—Ä–∞ (–¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã)
    function getStatusIcon(status) {
  if (status === 'reserved') return 'üü¢'; // –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω
  if (status === 'unavailable') return '‚ö™Ô∏è'; // –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
  return 'üü°'; // —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω (unverified)
    }
    // —Å—Ç–∞—Ç—É—Å–Ω—ã–π —Ñ–æ–Ω –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ç—É—Å–∞. –Ω–æ–≤—ã–π, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π, –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ
    function getBgClassByStatus(status) {
  if (status === 'reserved') return 'bg-green-100';       // –Ω–µ–∂–Ω–æ-–∑–µ–ª—ë–Ω—ã–π
  if (status === 'unavailable') return 'bg-yellow-100';   // –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π
  return 'bg-gray-100';                                   // –æ–±—ã—á–Ω—ã–π —Å–µ—Ä—ã–π (–Ω–æ–≤—ã–π)
    }
    //============================
    //—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    //============================
    window.addItemToCart = async function () {
  const mengeInput = document.getElementById("mengeInput");
  const menge = parseInt(mengeInput?.value, 10);
  const item = window.appState.selectedItem;

  if (!item || isNaN(menge) || menge < 1) {
    console.warn("‚ùå Ung√ºltige Eingabe oder kein Artikel ausgew√§hlt.");
    return;
  }

  // üß† –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "reserved" –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É –Ω–µ—Ç/–¥–∞
  const existingReservedItem = window.appState.selectedItems.find(
  (el) => el.Artikelnummer === item.Artikelnummer && el.status === "reserved"
);

if (existingReservedItem) {
  // === –ú–û–î–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–†–ò –î–û–ë–ê–í–õ–ï–ù–ò–ò –£–ñ–ï –ó–ê–†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ù–û–ì–û –¢–û–í–ê–†–ê ===
  window.appState.pendingAddItem = {
    artikel: item,
    menge: menge,
    oldMenge: existingReservedItem.Menge
  };
  window.showAddReservedConfirm();
  return;
}

  // üÜï –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –±—ã–ª–æ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—ã–π
  const existing = window.appState.selectedItems.find(
    (i) =>
        i.Artikelnummer === item.Artikelnummer &&
        i.Artikelbezeichnung === item.Artikelbezeichnung &&
        i.Ort === item.Ort
    );

  if (existing) {
    existing.Menge += menge;
    existing.status = 'unverified'; // <--- —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  } else {
    window.appState.selectedItems.push({
      ...item,
      Menge: menge,
      status: 'unverified' // <--- –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –≤—Å–µ–≥–¥–∞ unverified
    });
  }

  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};
// –≠–∫–ª–∏—Å–ø ) —Å–µ—Ä–µ–¥–∏–Ω–æ–≤—ã—Ä–µ–∑–∞–ª–∫–∞ middeelelips    
window.middleEllipsis = function(str, maxLen = 22) {
  if (!str || str.length <= maxLen) return str;
  const sep = '‚Ä¶';
  const keep = Math.floor((maxLen - sep.length) / 2);
  return str.slice(0, keep) + sep + str.slice(-keep);
}


    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
window.getCartItemKey = function(item) {
  return `${item.Artikelnummer}__${item.Artikelbezeichnung}__${item.Ort}`;
}

window.renderCart = function () {
  const cart = document.getElementById("cartItems");
  const items = window.appState.selectedItems;
  if (!cart) return;

  if (items.length === 0) {
    cart.innerHTML = `<p class="text-gray-500 italic">Noch keine Artikel</p>`;
    window.updateBoxInfo();
    return;
  }

/* // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –Ω–µ reserved, –ø–æ—Ç–æ–º reserved
  const sortedItems = [...items].sort((a, b) => {
    if (a.status === 'reserved' && b.status !== 'reserved') return 1;
    if (a.status !== 'reserved' && b.status === 'reserved') return -1;
    return 0;
  }); */ //–≤—Å–ø–ª—ã—Ç–∏–µ —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
  const sortedItems = window.sortByOrt
  ? [...items].sort((a, b) => (a.Ort || '').localeCompare(b.Ort || ''))
  : [...items]; 

  // üß™ –í—Å—Ç–∞–≤–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤:
  items.forEach((item, i) => {
    if (!String(item.Artikelnummer || "").trim()) {
      console.warn(`‚ùó –ù–µ—Ç –∞—Ä—Ç–∏–∫—É–ª–∞ —É –ø–æ–∑–∏—Ü–∏–∏ ${i}:`, item);
    } else {
      console.log(`‚úÖ –ê—Ä—Ç–∏–∫—É–ª ${i}:`, item.Artikelnummer);
    }
    
  });


// üõí window.checkAndReserveAll
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –≤ –∫–æ—Ä–∑–∏–Ω–µ –∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º —Å—Ç–∞—Ç—É—Å:
// reserved ‚Äî —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ, unavailable ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç


//=============================================================================================
// üü¢ –ü–æ—Å–ª–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (lager) –¥–ª—è –≤—Å–µ—Ö reserved
//=============================================================================================
window.checkAndReserveAll = async function () {
// === –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É "Pr√ºfen & reservieren" –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ===
const actionBlock = document.getElementById("actionButtonsBlock");
    if (actionBlock) {
    // –ù–∞—Ö–æ–¥–∏–º –∏–º–µ–Ω–Ω–æ –∫–Ω–æ–ø–∫—É "Pr√ºfen & reservieren" –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É (–∏–ª–∏ –ø–æ –∫–ª–∞—Å—Å—É –µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ!)
    const reserveBtn = Array.from(actionBlock.getElementsByTagName('button')).find(
        btn => btn.textContent.includes("Pr√ºfen") || btn.textContent.includes("reservieren")
    );
    if (reserveBtn) {
        reserveBtn.disabled = true;
        reserveBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        reserveBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        reserveBtn.innerHTML = `<span class="animate-pulse mr-1">‚è≥</span>Bitte warten...`;
      }
    }

    //–°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Artikelnummer –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è batch-–∑–∞–ø—Ä–æ—Å–∞ –∫ Firestore
    const artikelNummern = window.appState.selectedItems.map(item => String(item.Artikelnummer));

    // –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Firestore –ø–æ —Å–ø–∏—Å–∫—É –∞—Ä—Ç–∏–∫—É–ª–æ–≤
    // –ó–∞–ø—Ä–æ—Å –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'lager' –ø–æ —Å–ø–∏—Å–∫—É –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (where in ...)
    // (–í –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—é Firestore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ in-–∑–∞–ø—Ä–æ—Å–µ, —Ç–∞–∫ —á—Ç–æ –¥–µ–ª–∏–º –Ω–∞ —á–∞–Ω–∫–∏ –µ—Å–ª–∏ —á—Ç–æ)

    const db = window.db;
    const CHUNK_SIZE = 10;
    const artikelChunks = [];
    for (let i = 0; i < artikelNummern.length; i += CHUNK_SIZE) {
    artikelChunks.push(artikelNummern.slice(i, i + CHUNK_SIZE));
    }

    let firestoreItems = [];
    for (const chunk of artikelChunks) {
    const q = window.query(
        window.collection(db, "lager"),
        window.where("Artikelnummer", "in", chunk)
    );
    const querySnapshot = await window.getDocs(q);
    querySnapshot.forEach((doc) => {
        firestoreItems.push({ id: doc.id, ...doc.data() });
    });
    }

    // üü¢ –ú–ò–ö–†–û–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ Firestore
    window.appState.selectedItems.forEach(cartItem => {
    // –ò—â–µ–º stockItem –≤ Firestore –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
    const stockItem = firestoreItems.find(
        a => String(a.Artikelnummer) === String(cartItem.Artikelnummer)
    );
    cartItem.stock = stockItem ? Number(stockItem.Menge) : 0;

    if (stockItem) {
    // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç Reserviert
    const reserviertObj = stockItem.Reserviert && typeof stockItem.Reserviert === "object"
      ? { ...stockItem.Reserviert }
      : {};
    const uid = window.currentUser?.uid || "testuid";
    const oldReserve = Number(reserviertObj[uid]) || 0;
    // –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è: –æ—Å—Ç–∞—Ç–æ–∫ + —Å–≤–æ—è –±—Ä–æ–Ω—å
    const available = Number(stockItem.Menge) + oldReserve;

    // === –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî —Ä–µ–∑–µ—Ä–≤ –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω ===
    if (window.infiniteMode || available >= cartItem.Menge) {
      cartItem.status = 'reserved';
    } else {
      cartItem.status = 'unavailable';
    }
    } else {
        cartItem.status = 'unavailable';
    }
    });



  // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±–Ω–æ–≤–ª—è–µ–º Firestore –¥–ª—è –≤—Å–µ—Ö reserved ===
  for (const item of window.appState.selectedItems) {
  if (item.status === 'reserved') {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();

      // 1. –¢–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç Reserviert –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};

      // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const uid = window.currentUser?.uid || "testuid";
      const oldReserve = Number(reserviertObj[uid]) || 0;
      const newReserve = Number(item.Menge);
      const diff = newReserve - oldReserve;

      // 3. –í—ã—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ diff! –í —Ä–µ–∂–∏–º–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É—Ö–æ–¥–∏—Ç—å –≤ –º–∏–Ω—É—Å
    const neueMenge = window.infiniteMode
    ? (Number(artikelData.Menge) || 0) - diff
    : Math.max((Number(artikelData.Menge) || 0) - diff, 0);

      // 4. –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤
      if (newReserve > 0) {
        reserviertObj[uid] = newReserve;
      } else {
        delete reserviertObj[uid];
      }

      // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç Reserviert –∏ Menge
      await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMenge,
        Reserviert: reserviertObj,
      });
      }
    }
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ user_cart
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }
}; // ‚Üê‚Üê‚Üê –≤–æ—Ç –∑–¥–µ—Å—å –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏, –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Å–∫–æ–±–∫–∞!

//==========================================
//–¥–æ–ø—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è —Å —Ç–æ–≤–∞—Ä–æ–≤ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
//==========================================
window.showUnreserveAllConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Reservierungen aufheben?</h2>
        <div class="text-lg text-gray-800 mb-4">
          Wirklich <b>alle Reservierungen</b> im Warenkorb entfernen und Waren zur√ºck auf Lager geben?
        </div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmUnreserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};
//==========================================
//–µ—â–µ –æ–¥–Ω–∞ –¥–æ–ø —Ñ—É–Ω–∫—Ü–∏—è
//==========================================
window.confirmUnreserveAll = async function () {
  // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–≤–æ—é –¥–ª–∏–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é!
  await window.unreserveAll();
};


// üö´ –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ –≤–µ—Ä–Ω—É—Ç—å –∏—Ö –Ω–∞ —Å–∫–ª–∞–¥ –≤ –±–∞–∑–µ
window.unreserveAll = async function () {
  // 1. –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ reserved –¥–æ —Å–±—Ä–æ—Å–∞
  const reservedItems = window.appState.selectedItems.filter(item => item.status === 'reserved');

  // 2. –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å –ª–æ–∫–∞–ª—å–Ω–æ
  window.appState.selectedItems.forEach(cartItem => {
    cartItem.status = 'unverified';
  });

  // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∫–Ω–æ–ø–∫–∏
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. –û—á–∏—â–∞–µ–º user_cart (—Ä–µ–∑–µ—Ä–≤—ã)
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ reserved —Ç–æ–≤–∞—Ä–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º Menge –∏ –æ–±–Ω—É–ª—è–µ–º Reserviert –Ω–∞ —Å–∫–ª–∞–¥–µ
  for (const item of reservedItems) {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();
      const neueMenge = (Number(artikelData.Menge) || 0) + Number(item.Menge);
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Menge –∏ Reserviert
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};
        const uid = window.currentUser?.uid || "testuid";
        // –£–º–µ–Ω—å—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –±—Ä–æ–Ω—å
        const altMenge = Number(reserviertObj[uid]) || 0;
        const neueMengeFinal = (Number(artikelData.Menge) || 0) + altMenge;
        delete reserviertObj[uid]; // –°–Ω–∏–º–∞–µ–º –±—Ä–æ–Ω—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è

        await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMengeFinal,
        Reserviert: reserviertObj,
        });
    }
  }
};


// üõí window.unreserveItem
// üö´ –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ —Å–∫–ª–∞–¥
window.unreserveItem = async function (artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item || item.status !== 'reserved') return;

  // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞
  const menge = item.Menge;

  // 2. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ unverified
  item.status = 'unverified';

  // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∫–Ω–æ–ø–∫–∏
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ reserved –≤ Firestore
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (lager)
  const artikelRef = window.doc(window.db, "lager", String(artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
      ? { ...artikelData.Reserviert }
      : {};
    const uid = window.currentUser?.uid || "testuid";
    // –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    const altMenge = Number(reserviertObj[uid]) || 0;
    const neueMenge = (Number(artikelData.Menge) || 0) + altMenge;
    // –£–¥–∞–ª—è–µ–º —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤
    delete reserviertObj[uid];

    await window.setDoc(artikelRef, {
      ...artikelData,
      Menge: neueMenge,
      Reserviert: reserviertObj,
    });
  }
};



// –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã, –∫—Ä–æ–º–µ —Ç–µ—Ö, —É –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç–∞—Ç—É—Å 'reserved'
window.clearUnavailable = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Nicht reservierte Artikel entfernen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle nicht reservierten Artikel</b> aus dem Warenkorb l√∂schen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmClearUnavailable()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
//  —Å—Ç–∞—Ä—ã–π–ì–µ–Ω–µ—Ä–∞—Ü–∏—è LieferscheinNummer: LS-TAGMONATJAHR-XYZ
//=============================================================================
window.generateLieferscheinNummer = function () {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, "0");
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const year = String(now.getFullYear()).slice(-2);
  const random3 = String(Math.floor(Math.random() * 1000)).padStart(3, "0");
  const seconds = String(now.getSeconds()); // 0..59
  const lastSec = seconds.length > 1 ? seconds[seconds.length - 1] : seconds; // –ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞ —Å–µ–∫—É–Ω–¥

  return `L-${day}${month}${year}-${random3}${lastSec}`;
};

/*
//=============================================================================
// === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è superLieferscheinNummer: LS-TAGMONATJAHR-XYZSecunde
//=============================================================================
window.generateUniqueLieferscheinNummer = async function () {
    let numAttempts = 0;
  let lieferscheinNummer = "";
  while (numAttempts < 5) {
    // 4 —Å–ª—É—á–∞–π–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
    lieferscheinNummer = "L-" + String(Math.floor(Math.random() * 10000)).padStart(4, "0");
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ –±–∞–∑–µ
    const docRef = window.doc(window.db, "lieferscheine", lieferscheinNummer);
    const docSnap = await window.getDoc(docRef);
    if (!docSnap.exists()) {
      return lieferscheinNummer;
    }
    numAttempts++;
  }
  // –ï—Å–ª–∏ –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Å—ë –∑–∞–Ω—è—Ç–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å < 0.001%)
  return lieferscheinNummer;
};
*/
//=============================================================================
// –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ 
//=============================================================================
window.sendOrder = async function () {
  const user = window.currentUser;
  const uid = user?.uid || "unbekannt";

  const lieferscheinNummer = window.generateLieferscheinNummer();

  const versendeteArtikel = (window.appState.selectedItems || []).filter(
    (item) => item.status === "reserved"
  ).map(item => ({
    Artikelnummer: item.Artikelnummer,
    Artikelbezeichnung: item.Artikelbezeichnung,  
    Menge: item.Menge
  }));

  const docRef = window.doc(window.db, "lieferscheine", lieferscheinNummer);
  await window.setDoc(docRef, {
    lieferscheinNummer,
    user: uid,
    createdAt: new Date(),
    status: "versendet",
    items: versendeteArtikel
  });


  // üßπ –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º user_cart –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (window.auth.currentUser) {
    const userId = window.auth.currentUser.uid;
    const userRef = window.doc(window.db, "user_cart", userId);
    await window.setDoc(userRef, { items: [] }); // <--- –≤–æ—Ç —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –û–ß–ò–©–ê–ï–¢ –∫–æ—Ä–∑–∏–Ω—É –Ω–∞–ø—Ä–æ—á—å!
    console.log("üßπ user_cart –æ—á–∏—â–µ–Ω –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞");
    }

// üßπ –°–Ω–∏–º–∞–µ–º —Ä–µ–∑–µ—Ä–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–∂–¥–æ–º —Ç–æ–≤–∞—Ä–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
const userId = window.currentUser?.uid || "testuid";
const reservedItems = (window.appState.selectedItems || []).filter(item => item.status === "reserved");

for (const item of reservedItems) {
  const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
      ? { ...artikelData.Reserviert }
      : {};

    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –±—Ä–æ–Ω—å
    delete reserviertObj[userId];

    await window.setDoc(artikelRef, {
      ...artikelData,
      Reserviert: reserviertObj,
    });
  }
}


  // ‚úÖ –ß–∏—Å—Ç–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  window.appState.selectedItems = [];
  window.renderCart();
  window.updateCartButtons([]);

  // ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ
    const modal = document.getElementById("confirmationModals");
    if (modal) {
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-green-200">
            <h2 class="text-xl font-bold mb-3">Bestellung abgeschickt!</h2>
            <div class="text-lg text-gray-800 mb-4">
            Ihr Lieferschein:<br>
            <b class="text-green-700 text-xl">${lieferscheinNummer}</b>
            </div>
            <div class="flex justify-center pt-2 gap-2">
            <button onclick="document.getElementById('confirmationModals').classList.add('hidden')" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
            </div>
        </div>
        </div>
    `;
    modal.classList.remove("hidden");
    window.appState.modalOpen = true;
}
};

//==========================
//  –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
//==========================
console.log("–†–µ–Ω–¥–µ—Ä –∫–æ—Ä–∑–∏–Ω—ã, –ø—Ä–∏–º–µ—Ä item:", sortedItems && sortedItems[0]);
cart.innerHTML = sortedItems
.map((item, i) => {
const isSelected = item._selected;
const selectedClass = isSelected ? 'ring-2 ring-blue-400' : '';
const bgClass = getBgClassByStatus(item.status);
const key = window.getCartItemKey(item);

return `
  <div class="${bgClass} ${selectedClass} cart-card rounded-xl px-4 py-2 mb-2 flex justify-between items-start gap-2"
    data-key="${key}" onclick="window.toggleCartSelection('${key}')">

    <div class="grid grid-cols-[56px_16px_1fr] gap-y-1">
      <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
      <div class="text-lg text-gray-800 col-start-1 font-semibold row-start-1 flex justify-center items-center">${item.Ort}</div>
      <div class="col-start-2 row-start-1 w-4 h-px"></div>
      <div class="text-lg text-gray-800 font-semibold col-start-3 row-start-1">
        ${String(item.Artikelnummer || '').trim().match(/^\d/) ? window.formatArtikelnummer(item.Artikelnummer) : '‚Äî'}
      </div>
      <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ -->
      <div class="col-start-1 row-start-2 flex justify-center items-center">
        <span class="inline-block align-middle text-sm" style="line-height: 1;">${getStatusIcon(item.status)}</span>
      </div>
      <div class="col-start-2 row-start-2 w-4 h-px"></div>
      <div class="col-start-3 row-start-2 flex items-center gap-2 min-w-0">
        <span 
          class="text-lg text-gray-800 hyphenated min-w-0 cursor-pointer"
          style="max-width:100%; ${(item._expanded ? 'white-space:normal; word-break:break-word; hyphens:auto;' : 'text-overflow: ellipsis; overflow: hidden; white-space: nowrap; direction: ltr;')}"
          title="${item.Artikelbezeichnung || ''}"
          onclick="window.toggleCartExpand('${key}'); event.stopPropagation();"
          tabindex="0"
        >
          ${item._expanded ? item.Artikelbezeichnung : window.middleEllipsis(item.Artikelbezeichnung || '', 22)}
        </span>
      </div>
    </div>
    <div class="flex flex-col items-end text-right ml-2">
      <div class="font-semibold text-base flex items-center gap-2 justify-end">
        ${item.status === 'unavailable'
          ? `<span class="text-base text-red-600">Auf Lager: ${item.stock ?? 0}</span>`
          : ''
        }
        <span class="ml-2">√ó ${item.Menge}</span>
      </div>
      <div class="flex gap-1 mt-1">
        ${
          item.status === 'reserved'
            ? `<button onclick="event.stopPropagation(); unreserveItem('${item.Artikelnummer}')" title="Reservierung aufheben" class="text-yellow-600 text-lg">üö´</button>`
            : `
              <button onclick="event.stopPropagation(); window.editItem('${item.Artikelnummer}')" title="Bearbeiten" class="text-blue-600 text-lg">‚úèÔ∏è</button>
              <button onclick="event.stopPropagation(); window.showDeleteConfirm('${item.Artikelnummer}')" title="L√∂schen" class="text-red-600 text-lg">üóëÔ∏è</button>
            `
        }
      </div>
    </div>
  </div>
`;
})
.join("");
  window.updateBoxInfo();
  window.updateCartButtons(window.appState.selectedItems);
};

//—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
window.editItem = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –Ω–æ –≤ –ø–æ–ª–µ value –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ Menge
  const modal = document.getElementById("mengeModal");
  if (!modal) return;

  window.appState.modalOpen = true;
  window.appState.selectedItem = item;

  modal.innerHTML = `
  <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-200px;">
    <h2 class="text-xl font-bold">Artikel hinzuf√ºgen</h2>
    <div class="text-left px-2">
      <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
      <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
    </div>
    <input id="mengeInput" type="number" min="1" value="${item.Menge || 1}"
          class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
    <div class="flex justify-between pt-2 px-2 gap-2">
      <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
      <button onclick="saveEditedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
    </div>
  </div>
`;

  modal.classList.remove("hidden");
  setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input) {
    input.focus();
    input.select();
    input.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}, 200);




//–¥–ª—è Ios

setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input && document.activeElement !== input) {
      input.focus();
      input.select();
    }
  }, 500);
};



window.hideDeleteConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.confirmDeleteArtikelnummer = null;
};

window.confirmDeleteItem = function () {
  const artikelnummer = window.appState.confirmDeleteArtikelnummer;
  if (!artikelnummer) return;
  const index = window.appState.selectedItems.findIndex(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (index !== -1) {
    window.appState.selectedItems.splice(index, 1);
  }
  window.hideDeleteConfirm();
  window.updateCartButtons(window.appState.selectedItems);
  window.renderCart();
  window.appState.confirmDeleteArtikelnummer = null;
};
//================================
// —É–¥–∞–ª—è–ª–∫–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–≤–∞—Ä–∞
//================================
window.showDeleteConfirm = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º Artikelnummer –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  window.appState.confirmDeleteArtikelnummer = item.Artikelnummer;

  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Artikel l√∂schen?</h2>
        <div class="text-lg text-gray-800 mb-4">"${item.Artikelbezeichnung}" wirklich entfernen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmDeleteItem()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};
//=============================================================================
// —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
//=============================================================================
window.saveEditedItem = function () {
  const input = document.getElementById("mengeInput");
  if (!input) return;

  const neueMenge = parseInt(input.value, 10);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  if (!Number.isInteger(neueMenge) || neueMenge < 1) {
    input.classList.add("border-red-400");
    input.focus();
    return;
  }

  // üü¢ –ú–µ–Ω—è–µ–º Menge —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞!
  if (window.appState.selectedItem) {
    window.appState.selectedItem.Menge = neueMenge;
  }

  // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  window.appState.selectedItem = null;
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};
//=============================================================================
//  —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –∫—Ä–∞—Å–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
//=============================================================================
window.confirmClearUnavailable = function () {
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
  window.appState.selectedItems = (window.appState.selectedItems || []).filter(item => item.status === "reserved");
  window.renderCart();

  // –ü—Ä—è—á–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;
};

//–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–µ/—Å–Ω—è—Ç–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (—Å–∏–Ω–∏–π
window.toggleCartSelection = function(key) {
  const items = window.appState.selectedItems || [];
  const item = items.find(i => window.getCartItemKey(i) === key);
  if (!item) return;
  item._selected = !item._selected;
  window.renderCart?.();
};

// === –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ —Ç–∞–ø—É (–≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–∏–Ω–∏–º)
window.toggleCartExpand = function(key) {
  const items = window.appState.selectedItems || [];
  const item = items.find(i => window.getCartItemKey(i) === key);
  if (!item) return;
      // –¢–æ–≥–≥–ª–∏–º _selected: –µ—Å–ª–∏ —É–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç–æ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º
  item._expanded = !item._expanded;
  window.renderCart?.();
};




//=============================================================================
    // ========================
    // üì¶ JS 5. –ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –∫–æ—Ä–æ–±–∫–∏
    // ========================

  // ==================================================== 
  // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –æ–±—ä—ë–º–∞ –∏ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–æ–±–∫–∏
  // ==================================================== 
  // –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: —Å—á–∏—Ç–∞–µ—Ç –∑–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è gross –∏ mittel
window.calculateBoxVolumes = function () {
  // –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ—Ä–æ–±–æ–∫ (–º–æ–∂–µ—à—å –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
  const boxSizes = {
    mittel: { name: "Mittel Box", maxVolumen: 10260 },
    gross: { name: "Gro√üe Box", maxVolumen: 31635 }
  };

  const items = window.appState.selectedItems || [];

  // –û–±—â–∏–π –æ–±—ä—ë–º —Ç–æ–≤–∞—Ä–æ–≤
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    if (!v) {
      const l = Number(item.L√§nge || item.L√§nge_cm || item.L);
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.H√∂he || item.H√∂he_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞
  if (missingVolumen.length > 0) {
  alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä—ë–º —É " + missingVolumen.length + " –ø–æ–∑–∏—Ü–∏–π! –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
    console.warn("–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞:", missingVolumen);
  }

  // 95% –æ–±—ä—ë–º–∞ ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
  const mittelMax = boxSizes.mittel.maxVolumen * 0.95;
  const grossMax = boxSizes.gross.maxVolumen * 0.95;

  // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
  const mittelPercent = mittelMax ? Math.round((totalVol / mittelMax) * 100) : 0;
  const grossPercent = grossMax ? Math.round((totalVol / grossMax) * 100) : 0;

  return {
    mittel: {
      boxName: boxSizes.mittel.name,
      percent: Math.min(mittelPercent, 100),
      totalVol,
      maxVolumeForBox: mittelMax
    },
    gross: {
      boxName: boxSizes.gross.name,
      percent: Math.min(grossPercent, 100),
      totalVol,
      maxVolumeForBox: grossMax
    }
  };
};
  
/*
  window.calculateCurrentBoxVolume = function () {
  // 1. –ö–æ—Ä–æ–±–∫–∏ –∏ –∏—Ö –æ–±—ä—ë–º—ã
  const boxSizes = {
    klein: { name: "Kleine Box", maxVolumen: 1728 },
    mittel: { name: "Mittel Box", maxVolumen: 9720 },
    gross: { name: "Gro√üe Box", maxVolumen: 29970 }
  };

  // 2. –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  const items = window.appState.selectedItems || [];

  // 3. –°—É–º–º–∏—Ä—É–µ–º –æ–±—â–∏–π –æ–±—ä—ë–º –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ (volumen * menge)
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    // –ï—Å–ª–∏ Volumen –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ—Å—á–∏—Ç–∞—Ç—å
    if (!v) {
      const l = Number(item.L√§nge || item.L√§nge_cm || item.L); // –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—è
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.H√∂he || item.H√∂he_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // 4. –ï—Å–ª–∏ –Ω–µ —É –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å—Ç—å Volumen ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert (–æ–¥–∏–Ω —Ä–∞–∑)
  if (missingVolumen.length > 0) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä—ë–º —É " + missingVolumen.length + " –ø–æ–∑–∏—Ü–∏–π! –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
    console.warn("–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞:", missingVolumen);
  }

  // 5. –î–ª—è —Ä–∞—Å—á—ë—Ç–∞: —Ç–æ–ª—å–∫–æ 95% –æ–±—ä—ë–º–∞ –∫–æ—Ä–æ–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥ —Ç–æ–≤–∞—Ä—ã
  function fitBoxKey(vol) {
    if (vol <= boxSizes.mittel.maxVolumen * 0.95) return "mittel";
    if (vol <= boxSizes.gross.maxVolumen * 0.95) return "gross";
    return "gross"; // –±–æ–ª—å—à–µ gross ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ gross
  }

  // 6. –í—ã–±–æ—Ä –∫–æ—Ä–æ–±–∫–∏
  let boxKey = fitBoxKey(totalVol);

  // 7. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è mittel ‚Üî gross (–≥—Ä–∞–Ω–∏—Ü—ã)
  if (boxKey === "gross" && totalVol <= boxSizes.mittel.maxVolumen * 0.85) {
    boxKey = "mittel";
  }

  // 8. % –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
  const maxVolumeForBox = boxSizes[boxKey].maxVolumen * 0.95;
  const percent = maxVolumeForBox === 0 ? 0 : Math.round((totalVol / maxVolumeForBox) * 100);

  // 9. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç
  return {
    boxKey,
    boxName: boxSizes[boxKey].name,
    percent: Math.min(percent, 100),
    totalVol,
    maxVolumeForBox
  };
};
*/


//===================================================
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å—é –∫–æ—Ä–æ–±–∫–∏
//===================================================
window.updateBoxInfo = function () {
  const volumeSection = document.getElementById("volumeInfoBlock");
  if (!volumeSection) return;

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–æ–º –ø–æ —Ñ–ª–∞–≥—É
  if (window.appState.showVolumeBlock === false) {
    volumeSection.classList.add("hidden");
    return;
  } else {
    volumeSection.classList.remove("hidden");
  }

  const infoBlock = document.getElementById("boxSummary");
  if (!infoBlock) return;

  const result = window.calculateBoxVolumes();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (gross –∏ mittel)
  infoBlock.innerHTML =
    `üì¶ ${result.gross.boxName} ‚Äì ${result.gross.percent}% voll<br>` +
    `<span style="color:#a3a3a3;">üì¶ ${result.mittel.boxName} ‚Äì ${result.mittel.percent}% voll</span>`;

  // --- "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Ä–∞—Å—á—ë—Ç —Ç–æ–∂–µ –≤—ã–≤–æ–¥–∏–º –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å ---
  const initialBox = document.getElementById("initialBoxInfo");
  if (!initialBox) return;

  const initial = window.appState.initialVolumeInfo;
  if (
    initial &&
    typeof initial.gross === "object" &&
    typeof initial.mittel === "object"
  ) {
    initialBox.innerHTML =
      `üì¶ ${initial.gross.boxName} ‚Äì ${initial.gross.percent}% geplant<br>` +
      `<span style="color:#bdbdbd;">üì¶ ${initial.mittel.boxName} ‚Äì ${initial.mittel.percent}% geplant</span>`;
  } else {
    initialBox.textContent = "";
  }
};



    // ========================
    // üöö JS 6. –î–µ–π—Å—Ç–≤–∏—è —Å –∫–æ—Ä–∑–∏–Ω–æ–π
    // ========================

    // TODO: reserveItems(), confirmShipment(), 

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã (—É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É)
window.clearCart = function () {
  window.appState.selectedItems = [];
  window.renderCart();
  window.hideClearCartConfirm();
  window.updateCartButtons(window.appState.selectedItems);
};

// –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥ –∫–æ—Ä–∑–∏–Ω–æ–π
window.updateCartButtons = function (cartItems) {
  const actionBlock = document.getElementById("actionButtonsBlock");
  if (!actionBlock) return;

  // === 1. –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
  const allUnverified = cartItems.length > 0 && cartItems.every(item => item.status === 'unverified');
  const allReserved = cartItems.length > 0 && cartItems.every(item => item.status === 'reserved');
  const anyReserved = cartItems.some(item => item.status === 'reserved');
  const anyUnreserved = cartItems.some(item => item.status !== 'reserved');
  const onlyUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const anyUnavailable = cartItems.some(item => item.status === 'unavailable');
  const allUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const cartIsEmpty = cartItems.length === 0;
  
    // === 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
  // "Alle Reservierungen aufheben" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å reserved
  const unreserveActive = anyReserved;
  // "Nicht reservierte Artikel entfernen" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ-reserved –∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω reserved
  const clearUnreservedActive = anyReserved && anyUnreserved;
  // "Warenkorb leeren" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞ –≤—Å–µ–≥–¥–∞, –∫—Ä–æ–º–µ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã
  const clearCartActive = !cartIsEmpty;
  // "Bestellung abschicken" ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ reserved
  const sendOrderActive = allReserved && !cartIsEmpty;
  // "Pr√ºfen & reservieren" ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ-reserved
  const checkActive = anyUnreserved;



  // === 3. –ö–Ω–æ–ø–∫–∏ ‚Äî –ø–µ—Ä–≤—ã–π —Ä—è–¥
  let row1 = `
  <button class="flex-1 bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300"
    onclick="window.autoFillCart()">‚ûï Automatisch auff√ºllen</button>
  <button class="flex-1 ${anyUnreserved ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
    ${anyUnreserved ? 'onclick="window.clearUnavailable()"' : 'disabled'}>üóëÔ∏è Unreservierte Artikel entfernen</button>
`;

  // === 4. –ö–Ω–æ–ø–∫–∏ ‚Äî –≤—Ç–æ—Ä–æ–π —Ä—è–¥
  let row2 = "";

if (cartIsEmpty) {
  // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞: —Å–ª–µ–≤–∞ "Pr√ºfen & reservieren", —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å (–æ–±–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã)
  row2 = `
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      ‚úîÔ∏è Pr√ºfen & reservieren
    </button>
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      üö´ Alle Reservierungen aufheben
    </button>
  `;
} else if (allReserved) {
  // –í—Å—ë reserved: —Å–ª–µ–≤–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞, —Å–ø—Ä–∞–≤–∞ —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
  row2 = `
    <button class="flex-1 bg-blue-500 text-white hover:bg-blue-600 py-2 rounded-xl"
      onclick="window.sendOrder()">üì¶ Bestellung abschicken</button>
    <button class="flex-1 bg-yellow-500 text-white hover:bg-yellow-600 py-2 rounded-xl"
      onclick="window.showUnreserveAllConfirm()">üö´ Alle Reservierungen aufheben</button>
  `;
} else {
  // –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–ª—É—á–∞–∏: —Å–ª–µ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
  row2 = `
    <button class="flex-1 bg-green-500 text-white hover:bg-green-600 py-2 rounded-xl"
      onclick="window.checkAndReserveAll()">‚úîÔ∏è Pr√ºfen & reservieren</button>
    <button class="flex-1 ${unreserveActive ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
      ${unreserveActive ? 'onclick="window.showUnreserveAllConfirm()"' : 'disabled'}>üö´ Alle Reservierungen aufheben</button>
  `;
}

  // === 6. –ò—Ç–æ–≥–æ–≤–∞—è –≤—ë—Ä—Å—Ç–∫–∞
  actionBlock.innerHTML = `
    <div class="flex justify-between gap-2 mb-2">${row1}</div>
    <div class="flex justify-between gap-2">${row2}</div>
  `;
};

// –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ç–æ–≤–∞—Ä—ã  –≤ –ø–æ–∏—Å–∫–æ–≤–æ–º –º–µ–Ω—é
window.addMoreItems = function () {
  // –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ —Å–∫—Ä–æ–ª–ª–∏—Ç –∫ –ø–æ–∏—Å–∫—É, –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => searchInput.focus(), 400);
  }
};

    // ========================
    // ‚ûï JS 7. –ú–æ–¥–∞–ª–∫–∞ Menge
    // ========================
    window.openMengeModal = function (item) {
  const modal = document.getElementById("mengeModal");
  if (!modal) return;
  
  window.appState.selectedItem = item;

  modal.innerHTML = `
  <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-200px;">
    <h2 class="text-xl font-bold">Artikel hinzuf√ºgen</h2>
    <div class="text-left px-2">
      <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
      <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
    </div>
    <input id="mengeInput" type="number" min="1" value="1"
          class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
    <div class="flex justify-between pt-2 px-2 gap-2">
      <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
      <button onclick="window.addItemToCart()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
    </div>
  </div>
`;


  modal.classList.remove("hidden");

  setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input) {
    input.blur();    // üëà –∏–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—à–ª—ã–π —Ñ–æ–∫—É—Å
    input.focus();
    input.select();
  }
}, 200);
// —á—É—Ç—å –±–æ–ª—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è iOS
setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input && document.activeElement !== input) {
    input.blur();
    input.focus();
    input.select();
  }
}, 500);
};



    window.closeMengeModal = function () {
    const modal = document.getElementById("mengeModal");
    if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
    window.appState.modalOpen = false;
      window.appState.selectedItem = null;
      }
    };

    document.addEventListener("keydown", (e) => {
  const mengeModal = document.getElementById("mengeModal");
  const confirmModal = document.getElementById("confirmationModals");

  // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ Menge –æ—Ç–∫—Ä—ã—Ç–∞
  if (mengeModal && !mengeModal.classList.contains("hidden")) {
  if (e.key === "Escape") window.closeMengeModal();
  if (e.key === "Enter") {
    if (window.appState.selectedItem && window.appState.modalOpen) {
      window.saveEditedItem();
    } else {
      window.addItemToCart();
    }
  }
  return;
}
// –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ Menge ‚Äî –º–æ–¥–∞–ª–∫–∞ "–ø—Ä–∏–ª–∏–ø–∞–µ—Ç" –∫ –Ω–∏–∑—É.
const mengeInput = document.getElementById("mengeInput");


  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  if (confirmModal && !confirmModal.classList.contains("hidden")) {
    if (e.key === "Escape") window.hideDeleteConfirm();
    if (e.key === "Enter") window.confirmDeleteItem();
  }
});
  
    // ========================
    // ‚ùóÔ∏è JS 8. –ú–æ–¥–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    // ========================
    // TODO: showConfirmation(type), handleConfirm()

// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã ("Alles l√∂schen")
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É üóëÔ∏è Alles l√∂schen
window.showClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Artikel l√∂schen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle Artikel aus der Liste entfernen</b>?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.clearCart()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

window.hideClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
};

//=====================================================================================
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É  –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏ –Ω–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
//=====================================================================================
window.showAddReservedConfirm = function () {
  window.closeMengeModal();
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  // –î–æ—Å—Ç–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ window.appState.pendingAddItem
  const { artikel, menge, oldMenge } = window.appState.pendingAddItem || {};

  // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  if (!artikel || !menge || !oldMenge) {
    window.hideAddReservedConfirm();
    return;
  }

  const artikelName = artikel.Artikelbezeichnung || "Artikel";
  const total = Number(menge) + Number(oldMenge);

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
        <div class="block text-center text-lg font-bold mb-2">${artikelName}</div>
        <div class="text-gray-700 mb-2">ist bereits im Warenkorb.</div>
        <div class="text-gray-800 mb-2">M√∂chten Sie noch <b>${menge} St√ºck</b> hinzuf√ºgen?<br/>
        Insgesamt wird es <b>${total} St√ºck</b> sein.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideAddReservedConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmAddReservedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

// —Å–∫—Ä—ã–≤–∞–ª–∫–∞ —É—Ç–æ—á–Ω–∏—Ç—å
window.hideAddReservedConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.pendingAddItem = null;
};

// –∫—É—Å–æ–∫ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–∑–µ—Ä–≤+–Ω–æ–≤—ã–π"–û–ö"
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ OK ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∑–µ—Ä–≤
window.confirmAddReservedItem = async function () {
  const data = window.appState.pendingAddItem;
  if (!data) {
    window.hideAddReservedConfirm();
    return;
  }
  // üü¢ Disable OK-–∫–Ω–æ–ø–∫—É + –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
  const modal = document.getElementById("confirmationModals");
    if (modal) {
      const okBtn = modal.querySelector('button.bg-green-500');
      if (okBtn) {
        okBtn.disabled = true;
        okBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        okBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        okBtn.innerHTML = `<span class="animate-pulse mr-1">‚è≥</span>Bitte warten...`;
      }
    }
  const { artikel, menge, oldMenge } = data;

  // 1. –ù–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π reserved-—ç–ª–µ–º–µ–Ω—Ç
  const existingReservedItem = window.appState.selectedItems.find(
    (el) => el.Artikelnummer === artikel.Artikelnummer && el.status === "reserved"
  );
  if (!existingReservedItem) {
    // –ù–µ—Ç —Ç–∞–∫–æ–≥–æ ‚Äî –∞–≤–∞—Ä–∏–π–Ω–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å
    window.hideAddReservedConfirm();
    return;
  }

  // 2. –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —á–µ—Ä–µ–∑ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
  await window.unreserveItem(existingReservedItem.Artikelnummer);

  // 3. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  existingReservedItem.Menge = Number(oldMenge) + Number(menge);
  // 4. –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "new"
  existingReservedItem.status = "new";

  // 5. –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Å–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
  window.hideAddReservedConfirm();
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
    }

    // ========================
    // üí¨ JS 9. UI-—Å–æ–æ–±—â–µ–Ω–∏—è / –û—à–∏–±–∫–∏
    // –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –∑–∞—Ä–∞–Ω–µ–µ
    // ========================

    // ========================
    // üåê JS 10. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    // ========================

    // ========================
    // üåê JS 10.05 —É–º–Ω–π –ø–æ–∏—Å–∫ —Ä–∞–∑–±–∏–≤–∞–ª–∫–∞ –Ω–æ–º–µ—Ä–∞
    // ========================
    window.formatArtikelnummer = function (nummer) {
  const str = String(nummer).trim();
  const thinSpace = "\u2009";

  const prefixMatch = str.match(/^[A-Z]+/i); // –ü—Ä–µ—Ñ–∏–∫—Å –∏–∑ –±—É–∫–≤ –≤ –Ω–∞—á–∞–ª–µ
  const prefix = prefixMatch ? prefixMatch[0] + " " : "";

  const raw = str.replace(/\D/g, ""); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

  if (raw.length === 13) {
    return prefix + raw.replace(/(\d{3})(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3${thinSpace}$4`);
  }

  if (raw.length === 12) {
    return prefix + raw.replace(/(\d{4})(\d{4})(\d{4})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 10) {
    return prefix + raw.replace(/(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 8) {
    return prefix + raw.replace(/(\d{4})(\d{4})/, `$1${thinSpace}$2`);
  }

  if (raw.length === 6) {
    return prefix + raw.replace(/(\d{3})(\d{3})/, `$1${thinSpace}$2`);
  }

  // fallback: –∫–∞–∂–¥—ã–µ 3‚Äì4 —Ü–∏—Ñ—Ä—ã
  return prefix + raw.replace(/(\d{3,4})(?=\d)/g, `$1${thinSpace}`);
};



    // ========================
    // üåê JS 10.1 –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã
    // ========================
    
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzKtilIhFbMNl5zlQL5XsQHI7WPKnTNmgzh3xgniyPx49pJJ1OjwbfuViFm86y0zYQ/exec";
    
    fetch(GOOGLE_SHEET_URL)
  .then((res) => res.json())
  .then((data) => {
    window.appState.artikelListe = data;
    window.artikelListe = data;
    console.info("üì• Google Tabelle geladen:", data.length, "Eintr√§ge");
    window.isCatalogReady = true;        // –ø–æ–¥–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ "—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ç–æ–≤"
    window.tryRestoreCart();             // –ø—Ä–æ–≤–µ—Ä—è–µ–º ‚Äî –º–æ–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
  })
    .catch((err) => {
        console.error("‚ùå Fehler beim Laden der Google Tabelle:", err);
        const notification = document.getElementById("notificationArea");
    if (notification) {
        notification.textContent = "‚ùå Fehler beim Laden der Artikelliste";
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 4000);
    }
  });


// window.renderCart(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
//–º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
document.addEventListener("DOMContentLoaded", function() {
  // –ú–µ–Ω—è–µ–º <title>
  const pageTitle = document.getElementById("pageTitle");
  if (pageTitle) {
    pageTitle.textContent = `üì¶ LagerApp v${window.appVersion} Reset`;
  } else {
    document.title = `üì¶ LagerApp v${window.appVersion} Reset`;
  }

  // –ú–µ–Ω—è–µ–º h1
  const verElem = document.getElementById("ver");
  if (verElem) verElem.textContent = window.appVersion;

// –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
  const sortCheckbox = document.getElementById("sortByOrtCheckbox");
if (sortCheckbox) {
// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage, –µ—Å–ª–∏ –±—ã–ª–æ
const saved = localStorage.getItem("sortByOrt");
if (saved !== null) {
  window.sortByOrt = saved === "true";
  sortCheckbox.checked = window.sortByOrt;
} else {
  window.sortByOrt = true;
  sortCheckbox.checked = true;
}
sortCheckbox.addEventListener("change", function () {
  window.sortByOrt = sortCheckbox.checked;
  localStorage.setItem("sortByOrt", window.sortByOrt ? "true" : "false");
  window.renderCart?.();
});
}

});



function waitForFirebaseAuth(cb) {
  if (window.onAuthStateChanged && window.auth) {
    cb();
  } else {
    setTimeout(() => waitForFirebaseAuth(cb), 30);
  }
}
// ====================================================== 
// === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ ===
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("toggleVolumeBlock");
  if (!toggle) return;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ –∏–∑ appState
  toggle.checked = window.appState.showVolumeBlock !== false;

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –≥–∞–ª–æ—á–∫–∏
  toggle.addEventListener("change", function () {
    window.appState.showVolumeBlock = toggle.checked;
    window.updateBoxInfo();
  });
});

// ======================================================
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é



document.addEventListener("DOMContentLoaded", function() {
  waitForFirebaseAuth(function() {
    window.onAuthStateChanged(window.auth, function(user) {
      console.warn("üí• –í–•–û–î –≤ waitForFirebaseAuth CB!");

      console.log("user –≤ onAuthStateChanged:", user);
      window.isUserReady = !!user;
      console.log("isUserReady –ø–æ—Å–ª–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è:", window.isUserReady);

      //—Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–µ—Ä–∞
      window.showGlobalLoading("Bitte warten‚Ä¶");

      window.currentUser = user || null;
      window.isUserReady = !!user;
      window.tryRestoreExecuted = false;
      window.tryRestoreCart();

      console.warn("==> AUTH STATE CHANGED, user:", user ? user.uid : null);

      // === –í–°–¢–ê–í–¨ –í–û–¢ –ó–î–ï–°–¨ ===
      const authBlock = document.getElementById("authBlock");
      const mainUI = document.getElementById("mainUI");

      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");
      const registerBlock = document.getElementById("registerBlock");

      if (user) {
        authBlock?.classList.add("hidden");
        registerBlock?.classList.add("hidden");
        mainUI?.classList.remove("hidden");
        window.showGlobalLoading("Bitte warten‚Ä¶");

      } else {
        window.hideGlobalLoading();
        authBlock?.classList.remove("hidden");
        registerBlock?.classList.add("hidden"); // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä—É—á–Ω–æ–º—É –∫–ª–∏–∫—É
        mainUI?.classList.add("hidden");
      }
      // === –ö–û–ù–ï–¶ –í–°–¢–ê–í–ö–ò ===

      if (!user) {
        window.appState.selectedItems = [];
        window.renderCart();
        window.updateCartButtons([]);
      }
    });
  });
});
//=============================================================================
// === ‚ûï Automatisch auff√ºllen –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
//=============================================================================
window.autoFillCart = function () {
  const MAX_ITEMS = 12;
  const MIN_FILL = 0.95;
  const MAX_FILL = 1.10;

  let current = [...(window.appState.selectedItems || [])];
  const currentArtikels = new Set(current.map(i => i.Artikelnummer));

  const BOXES = {
    mittel: { name: "Mittel Box", max: 9720 },
    gross: { name: "Gro√üe Box", max: 31635 }
  };

  let totalVol = current.reduce((sum, x) => sum + (Number(x.Volumen) || 0) * Number(x.Menge || 1), 0);

  // === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω—É—é –∫–æ—Ä–æ–±–∫—É –ø–æ –æ–±—ä—ë–º—É
  function pickBoxByVolume(vol) {
    if (vol <= BOXES.mittel.max * 0.95) return "mittel";
    return "gross";
  }

  const boxType = pickBoxByVolume(totalVol);
  const boxVol = BOXES[boxType].max;

  let fill = totalVol / boxVol;

  if (fill >= MIN_FILL) {
    alert(`–ö–æ—Ä–∑–∏–Ω–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${Math.round(fill * 100)}% (${BOXES[boxType].name})!`);
    return;
  }

  const allItems = window.artikelListe || [];
  const candidates = allItems.filter(
  row =>
    !currentArtikels.has(row.Artikelnummer) &&
    Number(row.Volumen) > 0
);
  const shuffled = candidates.sort(() => Math.random() - 0.5);

  let i = 0;
  while (fill < MIN_FILL && current.length < MAX_ITEMS && i < shuffled.length) {
  const row = shuffled[i];
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä—ë–º–∞ —Ç–æ–≤–∞—Ä–∞:
  let menge = 1;
  const v = Number(row.Volumen) || 0;
  if (v > 3000) menge = 1;           // –æ—á–µ–Ω—å –∫—Ä—É–ø–Ω—ã–π ‚Äî —Ç–æ–ª—å–∫–æ 1
  else if (v > 800) menge = 2;       // —Å—Ä–µ–¥–Ω–∏–π ‚Äî 2
  else if (v > 300) menge = 3;       // –º–µ–ª–∫–∏–π ‚Äî 3
  else menge = 4;                    // –æ—á–µ–Ω—å –º–µ–ª–∫–∏–π ‚Äî 4

  // –ù–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–æ—Ä–æ–±–∫–∏!
  let addVol = v * menge;
  // –ï—Å–ª–∏ –ø–µ—Ä–µ–±–æ—Ä, —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ
  while (addVol > 0 && (totalVol + addVol) / boxVol > MAX_FILL) {
    menge--;
    addVol = v * menge;
  }
  if (menge < 1) { i++; continue; }

  current.push({
    Artikelnummer: row.Artikelnummer,
    Artikelbezeichnung: row.Artikelbezeichnung,
    Ort: row.Ort,
    Volumen: row.Volumen,
    Menge: menge,
    status: "unverified"
  });

  totalVol += addVol;
  fill = totalVol / boxVol;
  i++;
}

  window.appState.selectedItems = current;
  window.renderCart();
};
  // –ü–æ–∑–∂–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø–æ–¥–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ –ø–æ–ª–Ω–æ–π –∫–æ—Ä–æ–±–∫–∏.


/* 
// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
window._startZXingBarcodeScan = async function () {
  const ZXing = window._zxingLoaded;
  if (!ZXing) return;

  const videoElem = document.getElementById('barcodeVideo');
  if (!videoElem) return;

  // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∫–∞–Ω–µ—Ä ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º!
  if (window._barcodeScanner) {
    try { window._barcodeScanner.stop(); } catch {}
    window._barcodeScanner = null;
  }

  // –í–µ—Å—å UI –¥–µ–ª–∞–µ–º –≤–∏–¥–∏–º—ã–º
  videoElem.style.display = 'block';

  // –°–æ–∑–¥–∞—ë–º —Å–∫–∞–Ω–µ—Ä
  const codeReader = new ZXing.BrowserMultiFormatReader();
  window._barcodeScanner = codeReader;

  // –ò—â–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–∞–º–µ—Ä—É
  let devices = [];
  try {
    devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
  } catch (e) {
    alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ");
    window.closeBarcodeScanner();
    return;
  }

  const deviceId = devices && devices[0] ? devices[0].deviceId : null;
  if (!deviceId) {
    alert("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞–º–µ—Ä–∞");
    window.closeBarcodeScanner();
    return;
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–∫–æ–¥–µ—Ä
  codeReader.decodeFromVideoDevice(deviceId, videoElem, (result, err, controls) => {
    if (result && result.getText) {
      const code = result.getText();
      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ EAN-13 (13 —Ü–∏—Ñ—Ä)
      if (/^\d{13}$/.test(code)) {
        // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞!
        const input = document.getElementById('searchInput');
        if (input) {
          input.value = code;
          // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
          // window.handleSearchInput?.();
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä –∏ –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
        setTimeout(() => {
          window.closeBarcodeScanner();
        }, 300);
      }
    }
  });
};
*/
// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
const prevCloseBarcodeScanner = window.closeBarcodeScanner;
window.closeBarcodeScanner = function () {
  // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
  if (window._barcodeScanner) {
    try { window._barcodeScanner.reset(); } catch {}
    window._barcodeScanner = null;
  }
  // –°–ø—Ä—è—Ç–∞—Ç—å –≤–∏–¥–µ–æ
  const videoElem = document.getElementById('barcodeVideo');
  if (videoElem) {
    videoElem.srcObject = null;
    videoElem.style.display = 'none';
  }
  // –í—ã–∑–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π close
  if (prevCloseBarcodeScanner) prevCloseBarcodeScanner();
};

/* –º–µ–Ω–≥–µ–º–æ–¥–∞–ª –æ–≤–µ—Ä–ª–µ–π –ø–æ–∫–∞ –Ω–µ–Ω—É–∂–Ω–∞—è
//–µ—â–µ –æ–¥–Ω–∞ –º–µ–Ω–≥–µ –º–æ–¥–∞–ª —É–∂–µ –¥–ª—è —Å–∫–∞–Ω–µ—Ä–æ–≤
window.showMengeModal = function (artikelnummer, item) {
  // –°–æ–∑–¥–∞—ë–º –æ–≤–µ—Ä–ª–µ–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  let modal = document.getElementById('mengeModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'mengeModal';
    modal.style = 'position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:#fff;padding:20px 28px 16px 28px;border-radius:18px;min-width:230px;box-shadow:0 8px 24px #0002">
        <div style="font-weight:bold;margin-bottom:10px;">–¢–æ–≤–∞—Ä: ${item?.Artikelbezeichnung || artikelnummer}</div>
        <input id="mengeInput" type="number" min="1" max="999" value="1" style="font-size:18px;padding:6px 12px;width:80px;border-radius:8px;border:1px solid #ccc;" autofocus>
        <div style="margin-top:12px;display:flex;gap:10px;">
          <button id="mengeOk" style="background:#22c55e;color:#fff;padding:7px 14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">OK</button>
          <button id="mengeCancel" style="background:#eee;padding:7px 14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  } else {
    modal.style.display = "flex";
    modal.querySelector('input#mengeInput').value = "1";
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  modal.querySelector('#mengeOk').onclick = function () {
    const menge = parseInt(modal.querySelector('#mengeInput').value) || 1;
    // –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –≤—ã–∑—ã–≤–∞–π —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é:
    window.addToCart?.(artikelnummer, menge, item);
    modal.style.display = "none";
  };
  modal.querySelector('#mengeCancel').onclick = function () {
    modal.style.display = "none";
  };
};
*/

</script>

<!-- 
//=============================================================================
// ====== –ú–æ–¥–∞–ª–∫–∞ –º–µ–Ω–≥–µ ===
//================================================================================ -->
<div id="mengeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white p-6 rounded-2xl shadow-xl w-[320px] flex flex-col items-stretch">
    <h3 class="text-lg font-bold mb-2" id="mengeModalTitle">Artikel</h3>
    <label class="mb-2 text-sm text-gray-600">Menge:
      <input id="mengeInput" type="number" min="1" value="1"
            class="w-full mt-1 px-3 py-2 border rounded-xl text-lg" />
    </label>
    <div class="flex gap-2 mt-4 justify-end">
      <button onclick="window.closeMengeModal()" class="px-4 py-1 bg-gray-200 rounded-xl">Abbrechen</button>
      <button onclick="window.confirmMenge()" class="px-4 py-1 bg-blue-500 text-white rounded-xl">OK</button>
    </div>
  </div>
</div>

<!-- 
//=============================================================================
// ====== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ ===
//================================================================================ -->
<div id="globalLoadingOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-60 transition-opacity duration-300 hidden">
    <div class="rounded-2xl bg-white/80 px-6 py-8 shadow-2xl flex flex-col items-center">
      <div class="animate-spin h-10 w-10 mb-4 border-4 border-blue-500 border-t-transparent rounded-full"></div>
      <div class="text-lg font-semibold text-gray-800">Loading...</div>
      <div class="text-sm text-gray-500 mt-2" id="globalLoadingStatus"></div>
    </div>
  </div>

  

  




</div> <!-- –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π –¥–∏–≤ -->
<footer class="text-center text-sm text-gray-300 mt-4">
  üî© Alle Rechte an Muttern und Schrauben vorbehalten :) 
</footer>
<script src="firebase-setup.js" type="module"></script>
<!-- Tesseract.js-—á–∏—Ç–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<!-- HTML5 QR + BARCODE -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

</body>
</html>
