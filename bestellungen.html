
<!DOCTYPE html>

<html lang="de">
<head>
  <style>
    .hyphenated {
      hyphens: auto;
      word-break: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      display: inline-block;
    }

        #barcodeVideo video, #barcodeVideo canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    aspect-ratio: 1 / 1 !important;
    background: #222;
    display: block;
    }
    </style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="pageTitle">📦 LagerApp</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- 💠 Локер --> 
<div id="globalLoadingOverlay" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center transition-opacity duration-300 hidden">
    <div class="bg-white rounded-2xl px-6 py-4 shadow-xl text-center flex flex-col items-center gap-2">
        <span class="text-3xl animate-spin">⏳</span>
        <span id="globalLoadingStatus" class="block text-base font-semibold text-gray-700 mt-2">Bitte warten…</span>
    </div>
    </div>

<!-- 💠 Основной контейнер -->
<div id="mainCardContainer" class="relative max-w-xl mx-auto bg-white rounded-2xl shadow p-6 mt-2 space-y-6">


<!-- 🧭 0. Хедер и Навигация -->

<div id="loginHeader" class="relative flex justify-between items-center mb-4 relative">
    <h1 class="text-2xl font-bold text-center w-full">📦 Lager App v<span id="ver"></span></h1>
    <div class="absolute top-0 right-0 ">
      <button class="text-gray-600 text-2xl" onclick="window.toggleMenu()">⋮</button>
      <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-lg hidden z-100" id="menu">
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='index.html'">🔍 Waren Suche</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='bestellungen.html'">📄 Bestellungen</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='warenannahme.html'">📦 Warenannahme</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="loginButton" onclick="window.toggleAuthForm()">🔐 Anmelden</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 hidden" id="logoutButton" onclick="window.logout()">🚪 Abmelden</button>
      </div>
    </div>
  </div>

  <!-- 📦 UI переключатель -->
  <div id="mainUIWrapper">

    <!-- 🔒 1. Авторизация -->
    <section id="authBlock" class="space-y-4">
      <input id="email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <input id="password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <label class="flex items-center mb-2">
        <input id="rememberMe" type="checkbox" class="mr-2" />
        Eingeloggt bleiben
      </label>
      <button onclick="window.login()" class="w-full bg-blue-500 text-white py-2 rounded-xl hover:bg-blue-600">
        Einloggen
      </button>
      <!-- 🔄 Кнопка переключения -->
      <div class="text-center text-sm text-blue-600 cursor-pointer hover:underline"
      id="switchAuthForms" onclick="window.toggleAuthForm()">
        Noch kein Konto? Registrieren
        </div>
      <p id="authStatus" class="mt-2 text-sm text-gray-500"></p>
    </section>

    <!--скрытый блок регистрации  -->
    <section id="registerBlock" class="space-y-4 hidden">
        <input id="reg_email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_code" type="text" placeholder="Firmen-Code" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <button onclick="window.doRegister()" class="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600">
          Registrieren
        </button>
        <div class="mt-2 text-center text-sm text-blue-600 cursor-pointer hover:underline"
            onclick="window.toggleAuthForm()">
          Bereits registriert? Einloggen
        </div>
        <p id="registerStatus" class="mt-2 text-sm text-gray-500"></p>
      </section>



<!-- 🎛️ Основной интерфейс -->
    <section id="mainUI" class="hidden space-y-6">

        <!-- 🎲 1.5 Генератор заказов (заглушка) -->
        <section id="orderGeneratorHeader" class="space-y-2">
            <button id="randomButton" class="w-full bg-yellow-300 text-black py-2 rounded-xl hover:bg-yellow-400">🎲 Zufälliger Auftrag</button>
          <button class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">⚙️ Generator-Einstellungen</button>
        </section>
  
        <!-- 🔍 2 Поиск -->
        <section id="searchBlock" class="space-y-4">
          <div class="relative">
            <h2 class="text-xl font-bold mb-2">🔍 Artikel suchen & hinzufügen</h2>
            <input id="searchInput" type="text" placeholder="Artikelnummer oder Name oder Ort..." class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" />
            <div id="suggestions" class="absolute top-full left-0 w-full rounded-xl shadow border bg-white mt-2 hidden z-50">
                <ul id="suggestionsList" class="max-h-60 overflow-y-auto"></ul>
              </div>
          </div>
          <button id="openQRButton" onclick="window.openQRScanner()" class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">
            📷 Qr/Barcode scannen
          </button>
          
          <!-- ZXing Browser сканер — МОДУЛЬНО! -->
          <script type="module" id="zxingScript">
            // Оставляем пустым — подключится позже динамически
          </script>



          <!-- Модальное окно для сканера цифр -->
            <div id="barcodeScannerModal" class="fixed inset-0 z-[1200] flex items-center justify-center bg-black bg-opacity-70 hidden">
                <div class="relative bg-white rounded-2xl shadow-xl p-4 w-[360px] max-w-full flex flex-col items-center">
                <h2 class="text-lg font-bold mb-4">Digitaler Scanner</h2>
                <div id="barcodeVideo"
                        class="mx-auto rounded-2xl overflow-hidden bg-gray-200 flex items-center justify-center relative aspect-square"
                        style="width: 260px; max-width: 90vw;">

                        <!-- Квадратный оверлей для видео -->
                        <div id="qrOverlay"
                            style="position:absolute;left:0;top:0;width:100%;height:100%;
                                border: 3px solid #FFF;
                                border-radius: 24px;
                                box-sizing: border-box;
                                pointer-events:none;
                                z-index:2;">
                        </div>

                        <!-- Оверлей для наведения по штрихкоду (тонкая полоса/линия) -->
                        <div
                            style="position:absolute;left:10%;width:80%;top:48%;height:4%;background:rgba(255,255,255,0.19);border-radius:4px;
                            border:1.5px dashed #B0B0B0;z-index:3;pointer-events:none;"></div>
                    </div>
                        <div class="flex gap-2 w-full mt-2 mb-0 items-stretch">
                        <button id="photoOCRButton"
                        class="flex-1 min-w-0 px-4 py-2 bg-green-400 text-white rounded-xl hover:bg-green-600 whitespace-nowrap min-h-12">
                        Foto erkennen
                        </button>
                        <button id="switchCameraButton"
                          class="flex-1 min-w-0 px-4 py-2 bg-blue-400 text-white rounded-xl hover:bg-blue-600 whitespace-nowrap min-h-12">
                          Kamera wechseln
                        </button>
                        <button id="closeBarcodeScanner"
                        class="flex-1 min-w-0 px-4 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 whitespace-nowrap min-h-12">
                        Schließen
                        </button>
                        </div>
                <p class="text-xs text-gray-500 mt-2">Richten Sie die Kamera auf eine 13-stellige Zahlenreihe</p>
                <p class="text-xs text-gray-500 mt-2">Vergessen Sie nicht, diesem wunderbaren Menschen zu lächeln.</p> 
                </div>
            </div>

        </section>

        <!-- 📋 3. Результаты поиска -->
        <section id="searchResultsBlock">
          <label class="flex items-center gap-2 mb-2 select-none">
            <input type="checkbox" id="sortByOrtCheckbox" class="h-4 w-4" checked>
            <span>Sortieren nach Ort</span>
            </label>
        </section>
        <!-- Dev: Переключатель индикатора заполненности -->
        <div id="volumeToggleContainer" class="flex items-center gap-2 mb-2 select-none">
            <input type="checkbox" id="toggleVolumeBlock" class="h-4 w-4" checked />
            <label for="toggleVolumeBlock" class="text-sm text-gray-600 cursor-pointer">
            📦 
            </label>
        </div>
        <!-- 🛒 4 Корзина -->
        <section id="cartBlock" class="space-y-2">
          <h2 class="text-xl font-bold mb-2">🧾 Ausgewählte Artikel</h2>
          <div id="cartItems"><p class="text-gray-500 italic">Noch keine Artikel</p></div>
          <div id="cartItems" style="min-height: 8px;"></div>
        </section>
  
        <!-- 📦 5 Заполняемость -->
        <section id="volumeInfoBlock" class="text-sm text-gray-600">
          <div id="boxSummary">📦 Mittel Box – 0% voll</div>
          <div id="initialBoxInfo">📦 Geschätzte Box – 0% geplant</div>
        </section>
  
        <!-- 🚚 6. Кнопки действий -->
        <section id="actionButtonsBlock">
            <div class="flex justify-between gap-2 mb-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ➕ Automatisch auffüllen
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                🗑️ Unreservierte Artikel entfernen
              </button>
            </div>
            <div class="flex justify-between gap-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ✔️ Prüfen & reservieren
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                🚫 Alle Reservierungen aufheben
              </button>
            </div>
          </section>
  
      </section>
    </div>

        <!-- ➕ 7. Модалка Menge -->
        <div id="mengeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- Контент модалки -->
      </div>
  
      <!-- ❗ 8. Подтверждения -->
      <div id="confirmationModals" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- TODO: Всплывающие окна -->
      </div>
  
      <!-- 💬 9. UI-сообщения -->
      <div id="notificationArea" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-300 text-red-800 p-3 rounded-xl shadow-md hidden">
    <!-- TODO: Ошибки / подтверждения -->
  </div>
  <div class="bg-orange-400 hidden">purge-keep</div>

  <script type="module">
    
    // авто менялка версии
    window.appVersion = " 6.36"; // ← Меняешь только тут

    const FC64 = "TEFHRVIyMDI1"; 

    function decodeBase64(str) {
    try {
        return atob(str);
    } catch {
        return "";
    }
    }


    // Глобальный слушатель клика для автозакрытия меню
document.addEventListener("click", function (e) {
  const menu = document.getElementById("menu");
  const toggleBtn = document.querySelector("button[onclick*='toggleMenu']");
  if (
    menu &&
    !menu.classList.contains("hidden") &&
    !menu.contains(e.target) &&
    e.target !== toggleBtn
  ) {
    menu.classList.add("hidden");
  }
});

    // === ИНИЦИАЛИЗАЦИЯ СИНХРОНИЗАЦИИ ===
  // Флаги для отслеживания готовности данных и пользователя
  window.isCatalogReady = false;       // Справочник товаров (Google Таблица)
  window.isUserReady = false;          // Авторизация пользователя
  window.tryRestoreExecuted = false;   // Защита от повторного вызова

  // Центральная функция: восстанавливаем корзину, только когда ВСЁ готово!
  window.tryRestoreCart = function () {
    //консоль
    console.warn("💡 ВХОД в tryRestoreCart", {
  isCatalogReady: window.isCatalogReady,
  isUserReady: window.isUserReady,
  currentUser: window.currentUser
    });


    if (window.tryRestoreExecuted) return; // Уже запускали
    if (window.isCatalogReady && window.isUserReady && window.currentUser) {
      console.log("✅ Все готово. Восстанавливаем корзину...");
      window.tryRestoreExecuted = true;
      window.restoreCartFromFirestore(window.currentUser.uid)
      .then(() => window.hideGlobalLoading());
    } else {
      console.log("⏳ Ждем готовности: ", {
        isCatalogReady: window.isCatalogReady,
        isUserReady: window.isUserReady,
        currentUser: window.currentUser
      });
    }
  };



    // ================================
    // 🧭 JS 0. Хедер и Навигация
    // ================================
  
    

    /*
  ===============================================
  ❗️ Памятка для команды: Локальные модалки и кнопки OK/Cancel

  - В этом проекте каждая модалка (логин, подтверждение, редактирование Menge и др.)
  реализуется автономно — со своими собственными обработчиками кнопок OK и Cancel.
  - Универсализация и вынос в общие функции НЕ требуются до отдельного согласования!
  - Если обработчики или имена функций (например, ok/cancel) повторяются в разных
  модалках, это НЕ считается дублированием и НЕ требует объединения.
  - Приоритет: устойчивая локальная работа каждой модалки, даже с частичным дублированием кода.
  - Если потребуется общая логика для всех модалок — обсуждаем отдельно.
  ===============================================
  */

  /*
  “В любой функции, где меняется содержимое корзины, после renderCart() должен быть вызов updateCartButtons(). 
  Не экономим строчки, не выносим в общий renderCart, не доверяем автоматике!” не меняем и не оптимизируем этот момент! 
  Эти строки вместе, идут логично друг за другом. оставляем так, если что обсуждаем!
*/
/*
❗️ Памятка для команды:
корзина подгружается теперь через firebase setup.JS
*/

//=============================================================================
// === флаг сортировать по орт true
//=============================================================================
window.sortByOrt = true;

//функция локеров
window.showGlobalLoading = function (msg) {
  const overlay = document.getElementById("globalLoadingOverlay");
  const status = document.getElementById("globalLoadingStatus");
  if (overlay) overlay.classList.remove("hidden");
  if (status && msg) status.textContent = msg || "";
};
window.hideGlobalLoading = function () {
  const overlay = document.getElementById("globalLoadingOverlay");
  if (overlay) overlay.classList.add("hidden");
};


window.toggleMenu = function () {
  // Перед показом меню — расставляем видимость кнопок по авторизации
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");

  if (window.currentUser) {
    loginBtn?.classList.add("hidden");
    logoutBtn?.classList.remove("hidden");
  } else {
    loginBtn?.classList.remove("hidden");
    logoutBtn?.classList.add("hidden");
  }

  // Потом открываем/закрываем само меню
  const menu = document.getElementById("menu");
  if (menu) menu.classList.toggle("hidden");
};


// Переключение меню авторизации работает ТОЛЬКО при открытом меню!
// Управляем кнопками "Anmelden"/"Abmelden" только внутри toggleMenu,
// иначе элементы могут быть не в DOM (menu еще скрыто).


  // ========================
  // 🔒 JS 1. Авторизация
  // ========================
  // === Глобальный флаг "уходить в минус" по складу ===
    window.infiniteMode = true; // true — включено (можно уходить в минус), false — обычный режим

  window.appState = window.appState || {};
    //=============================================================================
    // === глобальный наблюдалк
    //=============================================================================
    Object.defineProperty(window.appState, 'selectedItems', {
        set(value) {
            console.warn('selectedItems SET:', value);
            this._selectedItems = value;
        },
        get() {
            return this._selectedItems;
        },
        configurable: true
        });
        window.appState._selectedItems = [];


  window.login = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const remember = document.getElementById("rememberMe").checked;
  const persistence = remember ? window.browserSessionPersistence : window.inMemoryPersistence;

  try {
    await window.setPersistence(window.auth, persistence);
    const result = await window.signInWithEmailAndPassword(window.auth, email, password);
    document.getElementById("authStatus").textContent = `✅ Eingeloggt als ${result.user.email}`;


    // ⬇️ Чистим поля
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";


  } catch (err) {
    document.getElementById("authStatus").textContent = `❌ Fehler: ${err.message}`;
  }
};

window.logout = async function () {
  try {
    await window.signOut(window.auth);
    console.info("🚪 Benutzer wurde abgemeldet.");
    document.getElementById("authStatus").textContent = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";

    const menu = document.getElementById("menu");
    if (menu) menu.classList.add("hidden");
  } catch (err) {
    console.error("Fehler beim Logout:", err);
  }
};

// консоль к корзине при загрузке и явно что то еще 
window.restoreCartFromFirestore = async function(userId) {
  console.warn("=== ВХОД в restoreCartFromFirestore, userId:", userId);
  // вот сюда вставляем ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓

  console.log('selectedItems после восстановления:', window.appState.selectedItems);
  const userCartRef = window.doc(window.db, "user_cart", userId);
  const cartSnap = await window.getDoc(userCartRef);

  if (cartSnap.exists()) {
    console.log('Корзина из Firestore:', cartSnap.data());
    window.appState.selectedItems = cartSnap.data().items || [];
    // === ВОТ СЮДА ВСТАВЬ КОНСОЛЬ! ===
    console.log('selectedItems после восстановления:', window.appState.selectedItems);
  } else {
    console.log('Корзина из Firestore: пусто');
    window.appState.selectedItems = [];
    // И сюда тоже для пустой корзины:
    console.log('selectedItems после восстановления:', window.appState.selectedItems);
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};

// Удаляет из объекта все поля с пустым ключом
function cleanItem(item) {
  return Object.fromEntries(
    Object.entries(item).filter(([key]) => key && key.trim() !== "")
  );
}


window.saveReservedCartToFirestore = async function(userId) {
  const reservedItems = window.appState.selectedItems
    .filter(item => item.status === 'reserved')
    .map(cleanItem); // <--- вот это обязательно!

  const userCartRef = window.doc(window.db, "user_cart", userId);
  console.log('→ reservedItems:', reservedItems);
reservedItems.forEach((item, idx) => {
  console.log('item', idx, item);
});
  await window.setDoc(userCartRef, {
    items: reservedItems
  });
};

// Переключает между формой входа и формой регистрации
window.toggleAuthForm = function () {
  // 🚦 Защита: если юзер залогинен, запрещаем открывать любые формы авторизации/регистрации!
  if (window.currentUser) {
    // Можно добавить информирование пользователя — например, "Вы уже авторизованы".
    return;
  }
  const authBlock = document.getElementById('authBlock');
  const registerBlock = document.getElementById('registerBlock');
  if (!authBlock || !registerBlock) return;

  authBlock.classList.toggle('hidden');
  registerBlock.classList.toggle('hidden');
  // Чистим статусы ошибок/успеха
  const authStatus = document.getElementById('authStatus');
  const registerStatus = document.getElementById('registerStatus');
  if (authStatus) authStatus.textContent = "";
  if (registerStatus) registerStatus.textContent = "";
};

// 🌟 Регистрация нового пользователя через Firebase Auth
window.doRegister = async function () {
  const email = document.getElementById("reg_email").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const code = document.getElementById("reg_code").value.trim();

  const FIRMA_CODE = decodeBase64(FC64);
  if (code !== FIRMA_CODE) {
    document.getElementById("registerStatus").textContent = "❌ Ungültiger Firmen-Code!";
    return;
  }

  if (!email || !password) {
    document.getElementById("registerStatus").textContent = "❌ Email und Passwort erforderlich";
    return;
  }
  try {
    const result = await window.createUserWithEmailAndPassword(window.auth, email, password);
    // После успешной регистрации — выдаём права в user_meta
    const userMetaRef = window.doc(window.db, "user_meta", result.user.uid);
    await window.setDoc(userMetaRef, { allowed: true });
    document.getElementById("registerStatus").textContent = "✅ Registrierung erfolgreich! Bitte einloggen.";
    // Сброс полей
    document.getElementById("reg_email").value = "";
    document.getElementById("reg_password").value = "";
    document.getElementById("reg_code").value = "";
    
    // Закрываем форму регистрации (показываем форму логина)
    window.toggleAuthForm();

  } catch (err) {
    document.getElementById("registerStatus").textContent = "❌ Fehler: " + err.message;
  }
};


// ========================
// 🧾 JS 1.1 Поведение Enter в форме логина
// ========================
document.addEventListener("keydown", function (e) {
  const authBlock = document.getElementById("authBlock");
  const isVisible = authBlock && !authBlock.classList.contains("hidden");

  if (!isVisible) return;

  const activeElement = document.activeElement;

  if (e.key === "Enter") {
    if (activeElement.id === "email") {
      e.preventDefault();
      document.getElementById("password")?.focus();
    } else if (activeElement.id === "password") {
      e.preventDefault();
      window.login();
    }
  }
});
    
    // ============================
    // 🎲 JS 1.5 Генератор заказов
    // ============================
    window.handleRandomButtonClick = function () {
  // Если корзина не пуста, показываем модалку-подтверждение
  const items = window.appState.selectedItems || [];
  if (items.length > 0) {
    // Показываем модалку с тремя вариантами
    const modal = document.getElementById("confirmationModals");
    if (modal) {
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen">
          <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
            <h2 class="text-xl font-bold mb-3">Warenkorb ist nicht leer!</h2>
            <div class="text-lg text-gray-800 mb-4">
              Neue Bestellung generieren?<br>
              <span class="text-xs text-gray-500">Die alten Artikel werden entfernt.</span>
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="window.generateSmartOrder(true)" class="px-4 py-2 rounded-xl bg-blue-500 text-white hover:bg-blue-600">Überschreiben</button>
              <button onclick="window.generateSmartOrder(false)" class="px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">Zum Warenkorb hinzufügen</button>
              <button onclick="window.hideDeleteConfirm()" class="px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove("hidden");
      window.appState.modalOpen = true;
    }
  } else {
    // Корзина пуста — сразу запускаем генератор
    window.generateSmartOrder(true);
  }
};

// === JS 1.6 Генератор заказов — черновик выбора коробки, структуры и групп ===
window.generateSmartOrder = function (replace) {
  window.hideDeleteConfirm?.();

  // 1. Очищаем корзину если replace
  if (replace) {
    window.appState.selectedItems = [];
    console.log("🔄 Корзина очищена перед генерацией заказа");
  } else {
    console.log("➕ Генератор добавит товары к текущей корзине");
  }

  if (!window.artikelListe || window.artikelListe.length === 0) {
    window.showNotification?.("Список товаров не загружен!", "error");
    return;
  }

  // 2. Случайно выбираем коробку: gross или mittel
  const boxType = Math.random() < 0.5 ? "gross" : "mittel";
  const boxVolumes = { gross: 31635, mittel: 9720 };
  const boxNames = { gross: "Große Box", mittel: "Mittel Box" };
  const boxVol = boxVolumes[boxType];
  console.log("🟩 Выбрана коробка:", boxType, "| объём:", boxVol);

  // 3. Структура заполнения (пока фиксированные проценты, потом сделаем рандом)
  const structure = boxType === "gross"
    ? { big: 0.6, mittel: 0.3, klein: 0.1 }
    : { big: 0.4, mittel: 0.4, klein: 0.2 };
  console.log("🧩 Структура заполнения (big/mittel/klein):", structure);

  // 4. Разбиваем товары по группам
  const groups = window.splitArtikelByGroups(boxType);


  // 5. Заготовка — вывести info по группам и структуре
  console.log("📦 Товаров по группам:", {
    big: groups.big.length,
    mittel: groups.mittel.length,
    klein: groups.klein.length
  });
  // === 5. Генерация черновика заказа по структуре ===

  // Вспомогалка: взять случайный элемент из массива
  function getRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  // 1. Черновик заказа (будущий массив для selectedItems)
  let draft = [];
  console.log("Черновик draft ИЗНАЧАЛЬНО:", draft);
  let usedArtikelNummern = new Set();

  // 2. Считаем нужные объёмы для каждой группы
  const targetBig = boxVol * structure.big;
  const targetMittel = boxVol * structure.mittel;
  const targetKlein = boxVol * structure.klein;

  // 3. Счётчик набранного объёма (по группам)
  let volBig = 0, volMittel = 0, volKlein = 0;

  // === BIG ===
  let tryBig = [...groups.big];
  while (tryBig.length && volBig < targetBig) {
    let artikel = getRandom(tryBig);
    tryBig = tryBig.filter(x => x.Artikelnummer !== artikel.Artikelnummer); // без повторов
    let menge = 1 + Math.floor(Math.random() * 3); // 1–3
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volBig + sumVol > targetBig * 1.12) break; // не переполняем!
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // если нужно
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volBig += sumVol;
  }

  // === MITTEL ===
  let tryMittel = [...groups.mittel];
  while (tryMittel.length && volMittel < targetMittel) {
    let artikel = getRandom(tryMittel);
    tryMittel = tryMittel.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = 2 + Math.floor(Math.random() * 3); // 2–4
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volMittel + sumVol > targetMittel * 1.15) break;
    if (usedArtikelNummern.has(artikel.Artikelnummer)) continue; // уже есть в заказе
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // если нужно
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volMittel += sumVol;
  }

  // === KLEIN ===
  let tryKlein = [...groups.klein];
  while (tryKlein.length && volKlein < targetKlein) {
    let artikel = getRandom(tryKlein);
    tryKlein = tryKlein.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = 3 + Math.floor(Math.random() * 5); // 3–7
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    if (volKlein + sumVol > targetKlein * 1.3) break;
    if (usedArtikelNummern.has(artikel.Artikelnummer)) continue;
    draft.push({
        Artikelnummer: artikel.Artikelnummer,
        Artikelbezeichnung: artikel.Artikelbezeichnung,
        Menge: menge,
        Ort: artikel.Ort,
        Volumen: artikel.Volumen, // если нужно
        status: "unverified"
        });
    usedArtikelNummern.add(artikel.Artikelnummer);
    volKlein += sumVol;
  }
  // === Итоговый расчет заполненности ===
  let totalVol = draft.reduce((sum, x) => sum + x.Volumen * x.Menge, 0);
    let filledPercent = Math.round((totalVol / boxVol) * 100);

  /// === ДОЗАПОЛНЯЕМ корзину до 90% mittel/klein, если не хватило, НО не больше 12 позиций ===
if (filledPercent < 90 && draft.length < 12) {
  // Сначала mittel, потом klein, оба только новые артикулы
  let tryExtra = [
    ...[...groups.mittel, ...groups.klein].filter(x => !draft.some(y => y.Artikelnummer === x.Artikelnummer))
  ];
  while (filledPercent < 110 && tryExtra.length && draft.length < 12) {
    let artikel = getRandom(tryExtra);
    tryExtra = tryExtra.filter(x => x.Artikelnummer !== artikel.Artikelnummer);
    let menge = artikel.Volumen > 600
      ? (1 + Math.floor(Math.random() * 2))
      : (2 + Math.floor(Math.random() * 4));
    const v = parseFloat(String(artikel.Volumen || "").replace(",", "."));
    const sumVol = v * menge;
    draft.push({
      Artikelnummer: artikel.Artikelnummer,
      Artikelbezeichnung: artikel.Artikelbezeichnung,
      Menge: menge,
      Ort: artikel.Ort,
      Volumen: artikel.Volumen,
      status: "unverified"
    });
    totalVol += sumVol;
    filledPercent = Math.round((totalVol / boxVol) * 100);
  }
}
  // 6. Кладём draft в корзину
  if (!replace && window.appState.selectedItems.length > 0) {
    // Добавляем к существующему
    draft = [...window.appState.selectedItems, ...draft];
  }
  window.appState.selectedItems = draft;

  // 7. Обновляем нижний блок с заполненностью коробки
  const boxSummary = document.getElementById("boxSummary");
  if (boxSummary) {
    boxSummary.textContent = `📦 ${boxNames[boxType]} – ${filledPercent}% voll (запланировано: big ${Math.round(volBig)}, mittel ${Math.round(volMittel)}, klein ${Math.round(volKlein)})`;
  }
  console.log("Черновик draft ПОСЛЕ НАПОЛНЕНИЯ:", draft);
  window.appState.selectedItems = draft;

  window.renderCart?.();
  window.updateCartButtons?.(window.appState.selectedItems);
  window.renderActionButtons?.();
};


// === JS 1.7 Генератор заказов — разметка по группам ===
window.splitArtikelByGroups = function (boxType) {
  // boxType: 'gross' или 'mittel'
  const TOO_BIG_LIMITS = { gross: 31635, mittel: 9720 };
  const LIMITS = {
    gross: { big: 3500, mittel: 800 },
    mittel: { big: 1166, mittel: 583 }
  };

  // Фильтруем только валидные товары (есть Volumen > 0, нет oversize)
  const artikelValid = window.artikelListe.filter(row => {
    const v = parseFloat(String(row.Volumen || "").replace(",", "."));
    const isOversize = String(row.L || "").toLowerCase() === "true";
    return v > 0 && !isOversize &&
      (!TOO_BIG_LIMITS[boxType] || v <= TOO_BIG_LIMITS[boxType]);
  });

  // Разбиваем по группам
  let groups = { big: [], mittel: [], klein: [] };
  for (const row of artikelValid) {
    const v = parseFloat(String(row.Volumen || "").replace(",", "."));
    if (boxType === "gross") {
      if (v > LIMITS.gross.big) groups.big.push(row);
      else if (v > LIMITS.gross.mittel) groups.mittel.push(row);
      else groups.klein.push(row);
    } else {
      if (v > LIMITS.mittel.big) groups.big.push(row);
      else if (v > LIMITS.mittel.mittel) groups.mittel.push(row);
      else groups.klein.push(row);
    }
  }
  // Лог для дебага
  console.log(`📦 ${boxType} разметка: big=${groups.big.length}, mittel=${groups.mittel.length}, klein=${groups.klein.length}`);
  return groups;
};
/*
// === JS 1.8 Генератор заказов — черновик выбора коробки, структуры и групп ===
window.generateSmartOrderv666 = function (replace) {
  window.hideDeleteConfirm?.();

  // 1. Очищаем корзину если replace
  if (replace) {
    window.appState.selectedItems = [];
    console.log("🔄 Корзина очищена перед генерацией заказа");
  } else {
    console.log("➕ Генератор добавит товары к текущей корзине");
  }

  if (!window.artikelListe || window.artikelListe.length === 0) {
    window.showNotification?.("Список товаров не загружен!", "error");
    return;
  }

  // 2. Случайно выбираем коробку: gross или mittel
  const boxType = Math.random() < 0.5 ? "gross" : "mittel";
  const boxVolumes = { gross: 31635, mittel: 9720 };
  const boxNames = { gross: "Große Box", mittel: "Mittel Box" };
  const boxVol = boxVolumes[boxType];
  console.log("🟩 Выбрана коробка:", boxType, "| объём:", boxVol);

  // 3. Структура заполнения (пока фиксированные проценты, потом сделаем рандом)
  const structure = boxType === "gross"
    ? { big: 0.6, mittel: 0.3, klein: 0.1 }
    : { big: 0.4, mittel: 0.4, klein: 0.2 };
  console.log("🧩 Структура заполнения (big/mittel/klein):", structure);

  // 4. Разбиваем товары по группам
  const groups = window.splitArtikelByGroups(boxType);

  // 5. Заготовка — вывести info по группам и структуре
  console.log("📦 Товаров по группам:", {
    big: groups.big.length,
    mittel: groups.mittel.length,
    klein: groups.klein.length
  });
  // --- дальше будет логика генерации (НА СЛЕДУЮЩЕМ ШАГЕ!) ---

  // 6. Внизу выводим выбранную коробку и структуру (тестовый вывод)
  const boxSummary = document.getElementById("boxSummary");
  if (boxSummary) {
    boxSummary.textContent = `📦 ${boxNames[boxType]} – 0% voll (структура: ${Math.round(structure.big*100)}/${Math.round(structure.mittel*100)}/${Math.round(structure.klein*100)})`;
  }
  // Можно вывести ещё debug-строку, если надо
  window.renderCart?.();
  window.renderActionButtons?.();
};

*/





// === Вешаем обработчик на кнопку генератора (randomButton) ===
document.addEventListener("DOMContentLoaded", function () {
  const randomBtn = document.getElementById("randomButton");
  if (randomBtn) {
    randomBtn.onclick = window.handleRandomButtonClick;
  }
  // обработчик обработчик на кнопку "❌ Закрыть" для сканера штрихкодов
  const closeBtn = document.getElementById('closeBarcodeScanner');
  if (closeBtn) {
    closeBtn.onclick = window.closeBarcodeScanner;
  }
});
    // TODO: generateOrder(), openSettingsPanel(), applyRandomOrder()

    // ========================
    // 🔍 JS 2. Поиск + QR
    // ========================
    // TODO: handleSearchInput(), openQRScanner(), onQRScanResult()
    window.openQRScanner = async function () {
  if (window._qrTransitioning) return;
  window._qrTransitioning = true;

  // Disable кнопку открытия (если есть)
  const openBtn = document.getElementById('openQRButton');
  if (openBtn) openBtn.disabled = true;

  try {
    const modal = document.getElementById('barcodeScannerModal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    const videoElem = document.getElementById('barcodeVideo');
    videoElem.innerHTML = "";
    videoElem.style.display = 'block';

    // Если есть предыдущий экземпляр — аккуратно останавливаем
    if (window._html5QrcodeScanner) {
      try {
        await window._html5QrcodeScanner.stop();
        await window._html5QrcodeScanner.clear();
      } catch (e) {
        // даже если stop неуспешен — пробуем очистить
        try { await window._html5QrcodeScanner.clear(); } catch {}
      }
      window._html5QrcodeScanner = null;
    }

    // Поднимаем флаг только здесь, перед стартом нового сканера
    let started = false;
    window._html5QrcodeScanner = new Html5Qrcode("barcodeVideo");
    if (!window._qrCameras) window._qrCameras = [];
    if (typeof window._qrCurrentCamIndex !== 'number') window._qrCurrentCamIndex = 0;

    await Html5Qrcode.getCameras().then(async cameras => {
      window._qrCameras = cameras || [];
      if (!cameras.length) throw new Error("Не найдена ни одна камера!");

      if (typeof window._qrCurrentCamIndex !== 'number' || window._qrCurrentCamIndex >= cameras.length) {
        window._qrCurrentCamIndex = 0;
      }

      let camId = cameras[window._qrCurrentCamIndex].id;

      await window._html5QrcodeScanner.start(
        camId,
        { fps: 12, qrbox: 220 },
        (decodedText, decodedResult) => {
          // ... 
        },
        (errorMessage) => { /* ignore */ }
      ).then(() => {
        started = true;
        window._qrTransitioning = false;
        if (openBtn) openBtn.disabled = false;
      }).catch(err => {
        window._qrTransitioning = false;
        if (openBtn) openBtn.disabled = false;
        alert("Ошибка запуска сканера: " + (err?.message || err));
        window.closeBarcodeScanner();
      });

      const switchBtn = document.getElementById('switchCameraButton');
      if (switchBtn) {
        switchBtn.onclick = async function () {
          try {
            if (window._html5QrcodeScanner) {
              await window._html5QrcodeScanner.stop();
              await window._html5QrcodeScanner.clear();
            }
          } catch (e) {}
          window._html5QrcodeScanner = null;
          window._qrCurrentCamIndex = (window._qrCurrentCamIndex + 1) % cameras.length;
          window.openQRScanner();
        };
      }
    }).catch(err => {
      window._qrTransitioning = false;
      if (openBtn) openBtn.disabled = false;
      alert("Не удалось получить камеру");
      window.closeBarcodeScanner();
    });
    // <<-- ЭТА СКОБКА ЗАКРЫВАЕТ .then().catch()

  } catch (err) {
    window._qrTransitioning = false;
    const openBtn = document.getElementById('openQRButton');
    if (openBtn) openBtn.disabled = false;
    alert("Ошибка сканера: " + (err?.message || err));
    window.closeBarcodeScanner();
  }
};


/// ===========================
// Корректная закрывалка сканера с блокировкой кнопки "Закрыть"
// ===========================
window.closeBarcodeScanner = async function () {
  if (window._qrClosing) return;
  window._qrClosing = true;

  // Блокируем кнопку "Закрыть" и показываем кулдаун
  const closeBtn = document.getElementById('closeBarcodeScanner');
  let cooldown = 5;
  if (closeBtn) {
    closeBtn.disabled = true;
    closeBtn.classList.add('opacity-60', 'cursor-not-allowed');
    const origText = closeBtn.textContent;
    closeBtn.textContent = `⏳ Bitte warten  (${cooldown})`;
    // Таймер обратного отсчёта
    const timer = setInterval(() => {
      cooldown--;
      if (cooldown > 0) {
        closeBtn.textContent = `⏳ Bitte warten  (${cooldown})`;
      } else {
        clearInterval(timer);
        closeBtn.textContent = origText || "❌ Schließen";
        closeBtn.disabled = false;
        closeBtn.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    }, 1000);
  }

  // Останавливаем и очищаем сканер
  try {
    if (window._html5QrcodeScanner) {
      await window._html5QrcodeScanner.stop();
      await window._html5QrcodeScanner.clear();
      window._html5QrcodeScanner = null;
    }
  } catch (e) {
    try { await window._html5QrcodeScanner.clear(); } catch {}
    window._html5QrcodeScanner = null;
  }

  // Скрываем модалку и сбрасываем стиль
  const modal = document.getElementById('barcodeScannerModal');
  if (modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
  const videoElem = document.getElementById('barcodeVideo');
  if (videoElem) {
    videoElem.innerHTML = "";
    videoElem.style.display = 'none';
  }

  // После 5 секунд снимаем флаги
  setTimeout(() => {
    window._qrTransitioning = false;
    window._qrClosing = false;
    const openBtn = document.getElementById('openQRButton');
    if (openBtn) openBtn.disabled = false;
  }, 5000);
};



    //выравнивалка поисковую строку
    if (searchInput) {
        searchInput.addEventListener("click", function () {
            setTimeout(() => {
            // Скроллим так, чтобы строка поиска была ~32px ниже верхней границы экрана
            const rect = searchInput.getBoundingClientRect();
            const absoluteY = window.scrollY + rect.top;
            window.scrollTo({
                top: absoluteY - 32, // 32px — желаемый отступ сверху
                behavior: "smooth"
            });
            }, 50);
        });
        }


    const suggestionsBox = document.getElementById("suggestions");
    const suggestionsList = document.getElementById("suggestionsList");

    searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase().replace(/\//g, "").trim();
  if (!query || !window.appState.artikelListe) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const matches = window.appState.artikelListe.filter(row => {
  if (!row.Artikelnummer || !row.Artikelbezeichnung || !row.Ort) return false;

  const ort = String(row.Ort).toLowerCase().replace(/\//g, '');
  const nummer = String(row.Artikelnummer).toLowerCase();
  const name = String(row.Artikelbezeichnung).toLowerCase();
  return ort.includes(query) || nummer.includes(query) || name.includes(query);
});


  if (matches.length === 0) {
    suggestionsList.innerHTML = `<li class="px-4 py-2 text-gray-500 italic">Keine Ergebnisse</li>`;
  } else {
    suggestionsList.innerHTML = matches.map(row => `
      <li class="flex justify-between items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
        <span>${row.Ort} — ${row.Artikelnummer} — ${row.Artikelbezeichnung}</span>
        <button onclick="window.openMengeModal(${JSON.stringify(row).replace(/"/g, '&quot;')})" class="text-green-600 text-xl ml-2">➕</button>
      </li>
    `).join("");
  }

  suggestionsBox.classList.remove("hidden");
  document.addEventListener("click", (e) => {
  const inside = searchInput.contains(e.target) || suggestionsBox.contains(e.target);
  if (!inside && !window.appState.modalOpen) {
    suggestionsBox.classList.add("hidden");
    searchInput.value = "";
  }
});


});
    // ========================
    // 📋 JS 3. Отображение результатов
    // ========================
    // TODO: renderSearchResults()

    // ========================
    // 🛒 JS 4. Корзина
    // ========================

    // Возвращает эмодзи по статусу товара (для корзины)
    function getStatusIcon(status) {
  if (status === 'reserved') return '🟢'; // зарезервирован
  if (status === 'unavailable') return '⚪️'; // нет в наличии
  return '🟡'; // только что добавлен (unverified)
    }
    // статусный фон изменяется от статуса. новый, отложенный, обратить внимание
    function getBgClassByStatus(status) {
  if (status === 'reserved') return 'bg-green-100';       // нежно-зелёный
  if (status === 'unavailable') return 'bg-yellow-100';   // мягкий жёлтый
  return 'bg-gray-100';                                   // обычный серый (новый)
    }
    //============================
    //функция добавления в корзину
    //============================
    window.addItemToCart = async function () {
  const mengeInput = document.getElementById("mengeInput");
  const menge = parseInt(mengeInput?.value, 10);
  const item = window.appState.selectedItem;

  if (!item || isNaN(menge) || menge < 1) {
    console.warn("❌ Ungültige Eingabe oder kein Artikel ausgewählt.");
    return;
  }

  // 🧠 Проверка: есть ли такой товар уже в корзине со статусом "reserved" и вызывает модалку нет/да
  const existingReservedItem = window.appState.selectedItems.find(
  (el) => el.Artikelnummer === item.Artikelnummer && el.status === "reserved"
);

if (existingReservedItem) {
  // === МОДАЛЬНОЕ ПОДТВЕРЖДЕНИЕ ПРИ ДОБАВЛЕНИИ УЖЕ ЗАРЕЗЕРВИРОВАННОГО ТОВАРА ===
  window.appState.pendingAddItem = {
    artikel: item,
    menge: menge,
    oldMenge: existingReservedItem.Menge
  };
  window.showAddReservedConfirm();
  return;
}

  // 🆕 Если такого товара не было — добавляем как новый
  const existing = window.appState.selectedItems.find(
    (i) =>
        i.Artikelnummer === item.Artikelnummer &&
        i.Artikelbezeichnung === item.Artikelbezeichnung &&
        i.Ort === item.Ort
    );

  if (existing) {
    existing.Menge += menge;
    existing.status = 'unverified'; // <--- сбрасываем статус при изменении
  } else {
    window.appState.selectedItems.push({
      ...item,
      Menge: menge,
      status: 'unverified' // <--- новый товар всегда unverified
    });
  }

  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};
// Эклисп ) серединовырезалка middeelelips    
window.middleEllipsis = function(str, maxLen = 22) {
  if (!str || str.length <= maxLen) return str;
  const sep = '…';
  const keep = Math.floor((maxLen - sep.length) / 2);
  return str.slice(0, keep) + sep + str.slice(-keep);
}


    // Генерирует уникальный ключ для товара в корзине
window.getCartItemKey = function(item) {
  return `${item.Artikelnummer}__${item.Artikelbezeichnung}__${item.Ort}`;
}

window.renderCart = function () {
  const cart = document.getElementById("cartItems");
  const items = window.appState.selectedItems;
  if (!cart) return;

  if (items.length === 0) {
    cart.innerHTML = `<p class="text-gray-500 italic">Noch keine Artikel</p>`;
    window.updateBoxInfo();
    return;
  }

/* // Сортировка: сначала не reserved, потом reserved
  const sortedItems = [...items].sort((a, b) => {
    if (a.status === 'reserved' && b.status !== 'reserved') return 1;
    if (a.status !== 'reserved' && b.status === 'reserved') return -1;
    return 0;
  }); */ //всплытие разрезервированного
  const sortedItems = window.sortByOrt
  ? [...items].sort((a, b) => (a.Ort || '').localeCompare(b.Ort || ''))
  : [...items]; 

  // 🧪 Вставка для логов:
  items.forEach((item, i) => {
    if (!String(item.Artikelnummer || "").trim()) {
      console.warn(`❗ Нет артикула у позиции ${i}:`, item);
    } else {
      console.log(`✅ Артикул ${i}:`, item.Artikelnummer);
    }
    
  });


// 🛒 window.checkAndReserveAll
// Проверяет остатки по всем товарам в корзине и проставляет им статус:
// reserved — хватает на складе, unavailable — не хватает


//=============================================================================================
// 🟢 После резервирования — обновляем количество на складе (lager) для всех reserved
//=============================================================================================
window.checkAndReserveAll = async function () {
// === Делаем кнопку "Prüfen & reservieren" неактивной и показываем индикатор ===
const actionBlock = document.getElementById("actionButtonsBlock");
    if (actionBlock) {
    // Находим именно кнопку "Prüfen & reservieren" по содержимому (или по классу если назначено!)
    const reserveBtn = Array.from(actionBlock.getElementsByTagName('button')).find(
        btn => btn.textContent.includes("Prüfen") || btn.textContent.includes("reservieren")
    );
    if (reserveBtn) {
        reserveBtn.disabled = true;
        reserveBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        reserveBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        reserveBtn.innerHTML = `<span class="animate-pulse mr-1">⏳</span>Bitte warten...`;
      }
    }

    //Собираем список всех Artikelnummer из корзины для batch-запроса к Firestore
    const artikelNummern = window.appState.selectedItems.map(item => String(item.Artikelnummer));

    // Чтение всех товаров из Firestore по списку артикулов
    // Запрос к коллекции 'lager' по списку артикулов (where in ...)
    // (В одну партию Firestore поддерживает до 10 элементов в in-запросе, так что делим на чанки если что)

    const db = window.db;
    const CHUNK_SIZE = 10;
    const artikelChunks = [];
    for (let i = 0; i < artikelNummern.length; i += CHUNK_SIZE) {
    artikelChunks.push(artikelNummern.slice(i, i + CHUNK_SIZE));
    }

    let firestoreItems = [];
    for (const chunk of artikelChunks) {
    const q = window.query(
        window.collection(db, "lager"),
        window.where("Artikelnummer", "in", chunk)
    );
    const querySnapshot = await window.getDocs(q);
    querySnapshot.forEach((doc) => {
        firestoreItems.push({ id: doc.id, ...doc.data() });
    });
    }

    // 🟢 МИКРОШАГ 3: Проверка остатков и статусов товаров по Firestore
    window.appState.selectedItems.forEach(cartItem => {
    // Ищем stockItem в Firestore по артикулу
    const stockItem = firestoreItems.find(
        a => String(a.Artikelnummer) === String(cartItem.Artikelnummer)
    );
    cartItem.stock = stockItem ? Number(stockItem.Menge) : 0;

    if (stockItem) {
    // Получаем объект Reserviert
    const reserviertObj = stockItem.Reserviert && typeof stockItem.Reserviert === "object"
      ? { ...stockItem.Reserviert }
      : {};
    const uid = window.currentUser?.uid || "testuid";
    const oldReserve = Number(reserviertObj[uid]) || 0;
    // Доступно для резервирования: остаток + своя бронь
    const available = Number(stockItem.Menge) + oldReserve;

    // === Новая логика: если бесконечный режим — резерв всегда разрешён ===
    if (window.infiniteMode || available >= cartItem.Menge) {
      cartItem.status = 'reserved';
    } else {
      cartItem.status = 'unavailable';
    }
    } else {
        cartItem.status = 'unavailable';
    }
    });



  // === Новый блок: обновляем Firestore для всех reserved ===
  for (const item of window.appState.selectedItems) {
  if (item.status === 'reserved') {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();

      // 1. Текущий объект Reserviert или пустой объект
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};

      // 2. Определяем UID пользователя
      const uid = window.currentUser?.uid || "testuid";
      const oldReserve = Number(reserviertObj[uid]) || 0;
      const newReserve = Number(item.Menge);
      const diff = newReserve - oldReserve;

      // 3. Вычитаем только diff! В режиме бесконечности можно уходить в минус
    const neueMenge = window.infiniteMode
    ? (Number(artikelData.Menge) || 0) - diff
    : Math.max((Number(artikelData.Menge) || 0) - diff, 0);

      // 4. Перезаписываем резерв
      if (newReserve > 0) {
        reserviertObj[uid] = newReserve;
      } else {
        delete reserviertObj[uid];
      }

      // 5. Сохраняем объект Reserviert и Menge
      await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMenge,
        Reserviert: reserviertObj,
      });
      }
    }
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // Сохраняем только зарезервированные товары в user_cart
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }
}; // ←←← вот здесь конец функции, всего одна скобка!

//==========================================
//допфункция для снятия с товаров резервации
//==========================================
window.showUnreserveAllConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Reservierungen aufheben?</h2>
        <div class="text-lg text-gray-800 mb-4">
          Wirklich <b>alle Reservierungen</b> im Warenkorb entfernen und Waren zurück auf Lager geben?
        </div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmUnreserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};
//==========================================
//еще одна доп функция
//==========================================
window.confirmUnreserveAll = async function () {
  // Скрываем модалку
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;

  // Запускаем твою длинную функцию!
  await window.unreserveAll();
};


// 🚫 Снять резерв со всех товаров и вернуть их на склад в базе
window.unreserveAll = async function () {
  // 1. Собираем список reserved до сброса
  const reservedItems = window.appState.selectedItems.filter(item => item.status === 'reserved');

  // 2. Снимаем статус локально
  window.appState.selectedItems.forEach(cartItem => {
    cartItem.status = 'unverified';
  });

  // 3. Перерисовываем корзину и кнопки
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. Очищаем user_cart (резервы)
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. Для каждого reserved товара увеличиваем Menge и обнуляем Reserviert на складе
  for (const item of reservedItems) {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    // Получаем текущие значения
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();
      const neueMenge = (Number(artikelData.Menge) || 0) + Number(item.Menge);
      // Обновляем только Menge и Reserviert
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};
        const uid = window.currentUser?.uid || "testuid";
        // Уменьшаем только свою бронь
        const altMenge = Number(reserviertObj[uid]) || 0;
        const neueMengeFinal = (Number(artikelData.Menge) || 0) + altMenge;
        delete reserviertObj[uid]; // Снимаем бронь только для себя

        await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMengeFinal,
        Reserviert: reserviertObj,
        });
    }
  }
};


// 🛒 window.unreserveItem
// 🚫 Снять резерв только с одного товара, обновить корзину и склад
window.unreserveItem = async function (artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item || item.status !== 'reserved') return;

  // 1. Сохраняем параметры для обновления склада
  const menge = item.Menge;

  // 2. Меняем статус на unverified
  item.status = 'unverified';

  // 3. Обновляем корзину и кнопки
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. Сохраняем только reserved в Firestore
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. Обновляем количество на складе (lager)
  const artikelRef = window.doc(window.db, "lager", String(artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
      ? { ...artikelData.Reserviert }
      : {};
    const uid = window.currentUser?.uid || "testuid";
    // Сколько было зарезервировано этим пользователем
    const altMenge = Number(reserviertObj[uid]) || 0;
    const neueMenge = (Number(artikelData.Menge) || 0) + altMenge;
    // Удаляем свой резерв
    delete reserviertObj[uid];

    await window.setDoc(artikelRef, {
      ...artikelData,
      Menge: neueMenge,
      Reserviert: reserviertObj,
    });
  }
};



// Удаляет все товары из корзины, кроме тех, у которых статус 'reserved'
window.clearUnavailable = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Nicht reservierte Artikel entfernen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle nicht reservierten Artikel</b> aus dem Warenkorb löschen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmClearUnavailable()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
//  старыйГенерация LieferscheinNummer: LS-TAGMONATJAHR-XYZ
//=============================================================================
window.generateLieferscheinNummer = function () {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, "0");
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const year = String(now.getFullYear()).slice(-2);
  const random3 = String(Math.floor(Math.random() * 1000)).padStart(3, "0");
  const seconds = String(now.getSeconds()); // 0..59
  const lastSec = seconds.length > 1 ? seconds[seconds.length - 1] : seconds; // последняя цифра секунд

  return `L-${day}${month}${year}-${random3}${lastSec}`;
};

/*
//=============================================================================
// === Генерация superLieferscheinNummer: LS-TAGMONATJAHR-XYZSecunde
//=============================================================================
window.generateUniqueLieferscheinNummer = async function () {
    let numAttempts = 0;
  let lieferscheinNummer = "";
  while (numAttempts < 5) {
    // 4 случайные цифры
    lieferscheinNummer = "L-" + String(Math.floor(Math.random() * 10000)).padStart(4, "0");
    // Проверка уникальности в базе
    const docRef = window.doc(window.db, "lieferscheine", lieferscheinNummer);
    const docSnap = await window.getDoc(docRef);
    if (!docSnap.exists()) {
      return lieferscheinNummer;
    }
    numAttempts++;
  }
  // Если после 5 попыток всё занято — возвращаем последний вариант (вероятность < 0.001%)
  return lieferscheinNummer;
};
*/
//=============================================================================
// отправки заказа 
//=============================================================================
window.sendOrder = async function () {
  const user = window.currentUser;
  const uid = user?.uid || "unbekannt";

  const lieferscheinNummer = window.generateLieferscheinNummer();

  const versendeteArtikel = (window.appState.selectedItems || []).filter(
    (item) => item.status === "reserved"
  ).map(item => ({
    Artikelnummer: item.Artikelnummer,
    Artikelbezeichnung: item.Artikelbezeichnung,  
    Menge: item.Menge
  }));

  const docRef = window.doc(window.db, "lieferscheine", lieferscheinNummer);
  await window.setDoc(docRef, {
    lieferscheinNummer,
    user: uid,
    createdAt: new Date(),
    status: "versendet",
    items: versendeteArtikel
  });


  // 🧹 Полностью очищаем user_cart для текущего пользователя
    if (window.auth.currentUser) {
    const userId = window.auth.currentUser.uid;
    const userRef = window.doc(window.db, "user_cart", userId);
    await window.setDoc(userRef, { items: [] }); // <--- вот эта строка ОЧИЩАЕТ корзину напрочь!
    console.log("🧹 user_cart очищен после отправки заказа");
    }

// 🧹 Снимаем резерв только для текущего пользователя в каждом товаре на складе
const userId = window.currentUser?.uid || "testuid";
const reservedItems = (window.appState.selectedItems || []).filter(item => item.status === "reserved");

for (const item of reservedItems) {
  const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
      ? { ...artikelData.Reserviert }
      : {};

    // Удаляем только свою бронь
    delete reserviertObj[userId];

    await window.setDoc(artikelRef, {
      ...artikelData,
      Reserviert: reserviertObj,
    });
  }
}


  // ✅ Чистим интерфейс
  window.appState.selectedItems = [];
  window.renderCart();
  window.updateCartButtons([]);

  // ✅ Сообщение
    const modal = document.getElementById("confirmationModals");
    if (modal) {
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-green-200">
            <h2 class="text-xl font-bold mb-3">Bestellung abgeschickt!</h2>
            <div class="text-lg text-gray-800 mb-4">
            Ihr Lieferschein:<br>
            <b class="text-green-700 text-xl">${lieferscheinNummer}</b>
            </div>
            <div class="flex justify-center pt-2 gap-2">
            <button onclick="document.getElementById('confirmationModals').classList.add('hidden')" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
            </div>
        </div>
        </div>
    `;
    modal.classList.remove("hidden");
    window.appState.modalOpen = true;
}
};

//==========================
//  Создание карточек
//==========================
console.log("Рендер корзины, пример item:", sortedItems && sortedItems[0]);
cart.innerHTML = sortedItems
.map((item, i) => {
const isSelected = item._selected;
const selectedClass = isSelected ? 'ring-2 ring-blue-400' : '';
const bgClass = getBgClassByStatus(item.status);
const key = window.getCartItemKey(item);

return `
  <div class="${bgClass} ${selectedClass} cart-card rounded-xl px-4 py-2 mb-2 flex justify-between items-start gap-2"
    data-key="${key}" onclick="window.toggleCartSelection('${key}')">

    <div class="grid grid-cols-[56px_16px_1fr] gap-y-1">
      <!-- Первая строка -->
      <div class="text-lg text-gray-800 col-start-1 font-semibold row-start-1 flex justify-center items-center">${item.Ort}</div>
      <div class="col-start-2 row-start-1 w-4 h-px"></div>
      <div class="text-lg text-gray-800 font-semibold col-start-3 row-start-1">
        ${String(item.Artikelnummer || '').trim().match(/^\d/) ? window.formatArtikelnummer(item.Artikelnummer) : '—'}
      </div>
      <!-- Вторая строка -->
      <div class="col-start-1 row-start-2 flex justify-center items-center">
        <span class="inline-block align-middle text-sm" style="line-height: 1;">${getStatusIcon(item.status)}</span>
      </div>
      <div class="col-start-2 row-start-2 w-4 h-px"></div>
      <div class="col-start-3 row-start-2 flex items-center gap-2 min-w-0">
        <span 
          class="text-lg text-gray-800 hyphenated min-w-0 cursor-pointer"
          style="max-width:100%; ${(item._expanded ? 'white-space:normal; word-break:break-word; hyphens:auto;' : 'text-overflow: ellipsis; overflow: hidden; white-space: nowrap; direction: ltr;')}"
          title="${item.Artikelbezeichnung || ''}"
          onclick="window.toggleCartExpand('${key}'); event.stopPropagation();"
          tabindex="0"
        >
          ${item._expanded ? item.Artikelbezeichnung : window.middleEllipsis(item.Artikelbezeichnung || '', 22)}
        </span>
      </div>
    </div>
    <div class="flex flex-col items-end text-right ml-2">
      <div class="font-semibold text-base flex items-center gap-2 justify-end">
        ${item.status === 'unavailable'
          ? `<span class="text-base text-red-600">Auf Lager: ${item.stock ?? 0}</span>`
          : ''
        }
        <span class="ml-2">× ${item.Menge}</span>
      </div>
      <div class="flex gap-1 mt-1">
        ${
          item.status === 'reserved'
            ? `<button onclick="event.stopPropagation(); unreserveItem('${item.Artikelnummer}')" title="Reservierung aufheben" class="text-yellow-600 text-lg">🚫</button>`
            : `
              <button onclick="event.stopPropagation(); window.editItem('${item.Artikelnummer}')" title="Bearbeiten" class="text-blue-600 text-lg">✏️</button>
              <button onclick="event.stopPropagation(); window.showDeleteConfirm('${item.Artikelnummer}')" title="Löschen" class="text-red-600 text-lg">🗑️</button>
            `
        }
      </div>
    </div>
  </div>
`;
})
.join("");
  window.updateBoxInfo();
  window.updateCartButtons(window.appState.selectedItems);
};

//редактировать количество
window.editItem = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // Показываем модалку, но в поле value подставляем текущее Menge
  const modal = document.getElementById("mengeModal");
  if (!modal) return;

  window.appState.modalOpen = true;
  window.appState.selectedItem = item;

  modal.innerHTML = `
  <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-200px;">
    <h2 class="text-xl font-bold">Artikel hinzufügen</h2>
    <div class="text-left px-2">
      <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
      <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
    </div>
    <input id="mengeInput" type="number" min="1" value="${item.Menge || 1}"
          class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
    <div class="flex justify-between pt-2 px-2 gap-2">
      <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
      <button onclick="saveEditedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
    </div>
  </div>
`;

  modal.classList.remove("hidden");
  setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input) {
    input.focus();
    input.select();
    input.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}, 200);




//для Ios

setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input && document.activeElement !== input) {
      input.focus();
      input.select();
    }
  }, 500);
};



window.hideDeleteConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.confirmDeleteArtikelnummer = null;
};

window.confirmDeleteItem = function () {
  const artikelnummer = window.appState.confirmDeleteArtikelnummer;
  if (!artikelnummer) return;
  const index = window.appState.selectedItems.findIndex(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (index !== -1) {
    window.appState.selectedItems.splice(index, 1);
  }
  window.hideDeleteConfirm();
  window.updateCartButtons(window.appState.selectedItems);
  window.renderCart();
  window.appState.confirmDeleteArtikelnummer = null;
};
//================================
// удалялка в карточках товара
//================================
window.showDeleteConfirm = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // Сохраняем Artikelnummer для дальнейшего удаления
  window.appState.confirmDeleteArtikelnummer = item.Artikelnummer;

  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Artikel löschen?</h2>
        <div class="text-lg text-gray-800 mb-4">"${item.Artikelbezeichnung}" wirklich entfernen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmDeleteItem()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};
//=============================================================================
// функция сохранения отредактированного количества товаров в карточке
//=============================================================================
window.saveEditedItem = function () {
  const input = document.getElementById("mengeInput");
  if (!input) return;

  const neueMenge = parseInt(input.value, 10);

  // Проверка валидности
  if (!Number.isInteger(neueMenge) || neueMenge < 1) {
    input.classList.add("border-red-400");
    input.focus();
    return;
  }

  // 🟢 Меняем Menge у выбранного товара!
  if (window.appState.selectedItem) {
    window.appState.selectedItem.Menge = neueMenge;
  }

  // Сброс состояния и закрытие модалки
  window.appState.selectedItem = null;
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};
//=============================================================================
//  удаление незарезервированных товаров из корзины красной кнопкой
//=============================================================================
window.confirmClearUnavailable = function () {
  // Оставляем только зарезервированные товары в корзине
  window.appState.selectedItems = (window.appState.selectedItems || []).filter(item => item.status === "reserved");
  window.renderCart();

  // Прячем модалку и снимаем флаг
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;
};

//Эта функция отвечает только за выделение/снятие выделения карточки (синий
window.toggleCartSelection = function(key) {
  const items = window.appState.selectedItems || [];
  const item = items.find(i => window.getCartItemKey(i) === key);
  if (!item) return;
  item._selected = !item._selected;
  window.renderCart?.();
};

// === Обработка выделения карточек по тапу (визуальное выделение синим)
window.toggleCartExpand = function(key) {
  const items = window.appState.selectedItems || [];
  const item = items.find(i => window.getCartItemKey(i) === key);
  if (!item) return;
      // Тогглим _selected: если уже раскрыто — скрываем, если нет — раскрываем
  item._expanded = !item._expanded;
  window.renderCart?.();
};




//=============================================================================
    // ========================
    // 📦 JS 5. Заполняемость коробки
    // ========================

  // ==================================================== 
  // Функция расчёта объёма и выбора коробки
  // ==================================================== 
  // Новый метод: считает заполняемость одновременно для gross и mittel
window.calculateBoxVolumes = function () {
  // Актуальные размеры коробок (можешь подставить актуальные значения)
  const boxSizes = {
    mittel: { name: "Mittel Box", maxVolumen: 10260 },
    gross: { name: "Große Box", maxVolumen: 31635 }
  };

  const items = window.appState.selectedItems || [];

  // Общий объём товаров
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    if (!v) {
      const l = Number(item.Länge || item.Länge_cm || item.L);
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.Höhe || item.Höhe_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // Проверка — есть ли товары без объёма
  if (missingVolumen.length > 0) {
  alert("Не удалось определить объём у " + missingVolumen.length + " позиций! Смотри консоль для деталей.");
    console.warn("Товары без объёма:", missingVolumen);
  }

  // 95% объёма — доступно для товаров
  const mittelMax = boxSizes.mittel.maxVolumen * 0.95;
  const grossMax = boxSizes.gross.maxVolumen * 0.95;

  // Считаем проценты заполненности
  const mittelPercent = mittelMax ? Math.round((totalVol / mittelMax) * 100) : 0;
  const grossPercent = grossMax ? Math.round((totalVol / grossMax) * 100) : 0;

  return {
    mittel: {
      boxName: boxSizes.mittel.name,
      percent: Math.min(mittelPercent, 100),
      totalVol,
      maxVolumeForBox: mittelMax
    },
    gross: {
      boxName: boxSizes.gross.name,
      percent: Math.min(grossPercent, 100),
      totalVol,
      maxVolumeForBox: grossMax
    }
  };
};
  
/*
  window.calculateCurrentBoxVolume = function () {
  // 1. Коробки и их объёмы
  const boxSizes = {
    klein: { name: "Kleine Box", maxVolumen: 1728 },
    mittel: { name: "Mittel Box", maxVolumen: 9720 },
    gross: { name: "Große Box", maxVolumen: 29970 }
  };

  // 2. Берём только товары из корзины
  const items = window.appState.selectedItems || [];

  // 3. Суммируем общий объём всех товаров (volumen * menge)
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    // Если Volumen нет, пробуем посчитать
    if (!v) {
      const l = Number(item.Länge || item.Länge_cm || item.L); // пробуем разные варианты поля
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.Höhe || item.Höhe_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // 4. Если не у всех товаров есть Volumen — показываем alert (один раз)
  if (missingVolumen.length > 0) {
    alert("Не удалось определить объём у " + missingVolumen.length + " позиций! Смотри консоль для деталей.");
    console.warn("Товары без объёма:", missingVolumen);
  }

  // 5. Для расчёта: только 95% объёма коробки используем под товары
  function fitBoxKey(vol) {
    if (vol <= boxSizes.mittel.maxVolumen * 0.95) return "mittel";
    if (vol <= boxSizes.gross.maxVolumen * 0.95) return "gross";
    return "gross"; // больше gross — всё равно gross
  }

  // 6. Выбор коробки
  let boxKey = fitBoxKey(totalVol);

  // 7. Логика переключения mittel ↔ gross (границы)
  if (boxKey === "gross" && totalVol <= boxSizes.mittel.maxVolumen * 0.85) {
    boxKey = "mittel";
  }

  // 8. % заполненности
  const maxVolumeForBox = boxSizes[boxKey].maxVolumen * 0.95;
  const percent = maxVolumeForBox === 0 ? 0 : Math.round((totalVol / maxVolumeForBox) * 100);

  // 9. Возвращаем объект
  return {
    boxKey,
    boxName: boxSizes[boxKey].name,
    percent: Math.min(percent, 100),
    totalVol,
    maxVolumeForBox
  };
};
*/


//===================================================
// Функция обновления блока с заполненностью коробки
//===================================================
window.updateBoxInfo = function () {
  const volumeSection = document.getElementById("volumeInfoBlock");
  if (!volumeSection) return;

  // Управление показом по флагу
  if (window.appState.showVolumeBlock === false) {
    volumeSection.classList.add("hidden");
    return;
  } else {
    volumeSection.classList.remove("hidden");
  }

  const infoBlock = document.getElementById("boxSummary");
  if (!infoBlock) return;

  const result = window.calculateBoxVolumes();

  // Показываем оба индикатора (gross и mittel)
  infoBlock.innerHTML =
    `📦 ${result.gross.boxName} – ${result.gross.percent}% voll<br>` +
    `<span style="color:#a3a3a3;">📦 ${result.mittel.boxName} – ${result.mittel.percent}% voll</span>`;

  // --- "Запланированный" расчёт тоже выводим двумя строками, если есть ---
  const initialBox = document.getElementById("initialBoxInfo");
  if (!initialBox) return;

  const initial = window.appState.initialVolumeInfo;
  if (
    initial &&
    typeof initial.gross === "object" &&
    typeof initial.mittel === "object"
  ) {
    initialBox.innerHTML =
      `📦 ${initial.gross.boxName} – ${initial.gross.percent}% geplant<br>` +
      `<span style="color:#bdbdbd;">📦 ${initial.mittel.boxName} – ${initial.mittel.percent}% geplant</span>`;
  } else {
    initialBox.textContent = "";
  }
};



    // ========================
    // 🚚 JS 6. Действия с корзиной
    // ========================

    // TODO: reserveItems(), confirmShipment(), 

    // Функция очистки корзины (удаляет все товары и закрывает модалку)
window.clearCart = function () {
  window.appState.selectedItems = [];
  window.renderCart();
  window.hideClearCartConfirm();
  window.updateCartButtons(window.appState.selectedItems);
};

// Функция автоматического управления кнопками под корзиной
window.updateCartButtons = function (cartItems) {
  const actionBlock = document.getElementById("actionButtonsBlock");
  if (!actionBlock) return;

  // === 1. Считаем статусы
  const allUnverified = cartItems.length > 0 && cartItems.every(item => item.status === 'unverified');
  const allReserved = cartItems.length > 0 && cartItems.every(item => item.status === 'reserved');
  const anyReserved = cartItems.some(item => item.status === 'reserved');
  const anyUnreserved = cartItems.some(item => item.status !== 'reserved');
  const onlyUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const anyUnavailable = cartItems.some(item => item.status === 'unavailable');
  const allUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const cartIsEmpty = cartItems.length === 0;
  
    // === 2. Определяем активность кнопок
  // "Alle Reservierungen aufheben" — активна, если есть reserved
  const unreserveActive = anyReserved;
  // "Nicht reservierte Artikel entfernen" — активна, если есть не-reserved и есть хотя бы один reserved
  const clearUnreservedActive = anyReserved && anyUnreserved;
  // "Warenkorb leeren" — активна всегда, кроме пустой корзины
  const clearCartActive = !cartIsEmpty;
  // "Bestellung abschicken" — только если все reserved
  const sendOrderActive = allReserved && !cartIsEmpty;
  // "Prüfen & reservieren" — если есть не-reserved
  const checkActive = anyUnreserved;



  // === 3. Кнопки — первый ряд
  let row1 = `
  <button class="flex-1 bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300"
    onclick="window.autoFillCart()">➕ Automatisch auffüllen</button>
  <button class="flex-1 ${anyUnreserved ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
    ${anyUnreserved ? 'onclick="window.clearUnavailable()"' : 'disabled'}>🗑️ Unreservierte Artikel entfernen</button>
`;

  // === 4. Кнопки — второй ряд
  let row2 = "";

if (cartIsEmpty) {
  // Корзина пуста: слева "Prüfen & reservieren", справа — разрезервировать (оба неактивны)
  row2 = `
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      ✔️ Prüfen & reservieren
    </button>
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      🚫 Alle Reservierungen aufheben
    </button>
  `;
} else if (allReserved) {
  // Всё reserved: слева отправка заказа, справа разрезервировать
  row2 = `
    <button class="flex-1 bg-blue-500 text-white hover:bg-blue-600 py-2 rounded-xl"
      onclick="window.sendOrder()">📦 Bestellung abschicken</button>
    <button class="flex-1 bg-yellow-500 text-white hover:bg-yellow-600 py-2 rounded-xl"
      onclick="window.showUnreserveAllConfirm()">🚫 Alle Reservierungen aufheben</button>
  `;
} else {
  // Любые другие случаи: слева проверить, справа — разрезервировать
  row2 = `
    <button class="flex-1 bg-green-500 text-white hover:bg-green-600 py-2 rounded-xl"
      onclick="window.checkAndReserveAll()">✔️ Prüfen & reservieren</button>
    <button class="flex-1 ${unreserveActive ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
      ${unreserveActive ? 'onclick="window.showUnreserveAllConfirm()"' : 'disabled'}>🚫 Alle Reservierungen aufheben</button>
  `;
}

  // === 6. Итоговая вёрстка
  actionBlock.innerHTML = `
    <div class="flex justify-between gap-2 mb-2">${row1}</div>
    <div class="flex justify-between gap-2">${row2}</div>
  `;
};

// кнопка добавить еще товары  в поисковом меню
window.addMoreItems = function () {
  // Пока только скроллит к поиску, потом будет подключён генератор
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => searchInput.focus(), 400);
  }
};

    // ========================
    // ➕ JS 7. Модалка Menge
    // ========================
    window.openMengeModal = function (item) {
  const modal = document.getElementById("mengeModal");
  if (!modal) return;
  
  window.appState.selectedItem = item;

  modal.innerHTML = `
  <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-200px;">
    <h2 class="text-xl font-bold">Artikel hinzufügen</h2>
    <div class="text-left px-2">
      <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
      <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
    </div>
    <input id="mengeInput" type="number" min="1" value="1"
          class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
    <div class="flex justify-between pt-2 px-2 gap-2">
      <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
      <button onclick="window.addItemToCart()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
    </div>
  </div>
`;


  modal.classList.remove("hidden");

  setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input) {
    input.blur();    // 👈 иногда помогает сбросить прошлый фокус
    input.focus();
    input.select();
  }
}, 200);
// чуть больше задержка для iOS
setTimeout(() => {
  const input = document.getElementById("mengeInput");
  if (input && document.activeElement !== input) {
    input.blur();
    input.focus();
    input.select();
  }
}, 500);
};



    window.closeMengeModal = function () {
    const modal = document.getElementById("mengeModal");
    if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
    window.appState.modalOpen = false;
      window.appState.selectedItem = null;
      }
    };

    document.addEventListener("keydown", (e) => {
  const mengeModal = document.getElementById("mengeModal");
  const confirmModal = document.getElementById("confirmationModals");

  // Если модалка Menge открыта
  if (mengeModal && !mengeModal.classList.contains("hidden")) {
  if (e.key === "Escape") window.closeMengeModal();
  if (e.key === "Enter") {
    if (window.appState.selectedItem && window.appState.modalOpen) {
      window.saveEditedItem();
    } else {
      window.addItemToCart();
    }
  }
  return;
}
// При фокусе на Menge — модалка "прилипает" к низу.
const mengeInput = document.getElementById("mengeInput");


  // Если открыта модалка подтверждения
  if (confirmModal && !confirmModal.classList.contains("hidden")) {
    if (e.key === "Escape") window.hideDeleteConfirm();
    if (e.key === "Enter") window.confirmDeleteItem();
  }
});
  
    // ========================
    // ❗️ JS 8. Модальные подтверждения
    // ========================
    // TODO: showConfirmation(type), handleConfirm()

// Показывает модальное окно с подтверждением полной очистки корзины ("Alles löschen")
// Вызывается при клике на кнопку 🗑️ Alles löschen
window.showClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Artikel löschen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle Artikel aus der Liste entfernen</b>?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.clearCart()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

window.hideClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
};

//=====================================================================================
// Показывает модалку  для объединения зарезервированного товара и не зарезервированного
//=====================================================================================
window.showAddReservedConfirm = function () {
  window.closeMengeModal();
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  // Достаём параметры из window.appState.pendingAddItem
  const { artikel, menge, oldMenge } = window.appState.pendingAddItem || {};

  // Если вдруг чего-то нет — закрываем модалку
  if (!artikel || !menge || !oldMenge) {
    window.hideAddReservedConfirm();
    return;
  }

  const artikelName = artikel.Artikelbezeichnung || "Artikel";
  const total = Number(menge) + Number(oldMenge);

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
        <div class="block text-center text-lg font-bold mb-2">${artikelName}</div>
        <div class="text-gray-700 mb-2">ist bereits im Warenkorb.</div>
        <div class="text-gray-800 mb-2">Möchten Sie noch <b>${menge} Stück</b> hinzufügen?<br/>
        Insgesamt wird es <b>${total} Stück</b> sein.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideAddReservedConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmAddReservedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

// скрывалка уточнить
window.hideAddReservedConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.pendingAddItem = null;
};

// кусок модалки резерв+новый"ОК"
// Обработчик кнопки OK — объединяет и пересоздаёт резерв
window.confirmAddReservedItem = async function () {
  const data = window.appState.pendingAddItem;
  if (!data) {
    window.hideAddReservedConfirm();
    return;
  }
  // 🟢 Disable OK-кнопку + визуальный фидбек
  const modal = document.getElementById("confirmationModals");
    if (modal) {
      const okBtn = modal.querySelector('button.bg-green-500');
      if (okBtn) {
        okBtn.disabled = true;
        okBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        okBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        okBtn.innerHTML = `<span class="animate-pulse mr-1">⏳</span>Bitte warten...`;
      }
    }
  const { artikel, menge, oldMenge } = data;

  // 1. Найти существующий reserved-элемент
  const existingReservedItem = window.appState.selectedItems.find(
    (el) => el.Artikelnummer === artikel.Artikelnummer && el.status === "reserved"
  );
  if (!existingReservedItem) {
    // Нет такого — аварийно просто закрыть
    window.hideAddReservedConfirm();
    return;
  }

  // 2. Снять резерв через уже существующую функцию
  await window.unreserveItem(existingReservedItem.Artikelnummer);

  // 3. Обновить количество
  existingReservedItem.Menge = Number(oldMenge) + Number(menge);
  // 4. Сбросить статус на "new"
  existingReservedItem.status = "new";

  // 5. Обновить интерфейс и скрыть модалку
  window.hideAddReservedConfirm();
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
    }

    // ========================
    // 💬 JS 9. UI-сообщения / Ошибки
    // пока не реализовано — добавлен блок заранее
    // ========================

    // ========================
    // 🌐 JS 10. Глобальные переменные
    // ========================

    // ========================
    // 🌐 JS 10.05 умнй поиск разбивалка номера
    // ========================
    window.formatArtikelnummer = function (nummer) {
  const str = String(nummer).trim();
  const thinSpace = "\u2009";

  const prefixMatch = str.match(/^[A-Z]+/i); // Префикс из букв в начале
  const prefix = prefixMatch ? prefixMatch[0] + " " : "";

  const raw = str.replace(/\D/g, ""); // только цифры

  if (raw.length === 13) {
    return prefix + raw.replace(/(\d{3})(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3${thinSpace}$4`);
  }

  if (raw.length === 12) {
    return prefix + raw.replace(/(\d{4})(\d{4})(\d{4})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 10) {
    return prefix + raw.replace(/(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 8) {
    return prefix + raw.replace(/(\d{4})(\d{4})/, `$1${thinSpace}$2`);
  }

  if (raw.length === 6) {
    return prefix + raw.replace(/(\d{3})(\d{3})/, `$1${thinSpace}$2`);
  }

  // fallback: каждые 3–4 цифры
  return prefix + raw.replace(/(\d{3,4})(?=\d)/g, `$1${thinSpace}`);
};



    // ========================
    // 🌐 JS 10.1 Загрузка данных из Google Таблицы
    // ========================
    
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzKtilIhFbMNl5zlQL5XsQHI7WPKnTNmgzh3xgniyPx49pJJ1OjwbfuViFm86y0zYQ/exec";
    
    fetch(GOOGLE_SHEET_URL)
  .then((res) => res.json())
  .then((data) => {
    window.appState.artikelListe = data;
    window.artikelListe = data;
    console.info("📥 Google Tabelle geladen:", data.length, "Einträge");
    window.isCatalogReady = true;        // поднимаем флаг "справочник готов"
    window.tryRestoreCart();             // проверяем — можно ли восстановить корзину
  })
    .catch((err) => {
        console.error("❌ Fehler beim Laden der Google Tabelle:", err);
        const notification = document.getElementById("notificationArea");
    if (notification) {
        notification.textContent = "❌ Fehler beim Laden der Artikelliste";
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 4000);
    }
  });


// window.renderCart(); // начальная отрисовка при запуске
//менялка версии
document.addEventListener("DOMContentLoaded", function() {
  // Меняем <title>
  const pageTitle = document.getElementById("pageTitle");
  if (pageTitle) {
    pageTitle.textContent = `📦 LagerApp v${window.appVersion} Reset`;
  } else {
    document.title = `📦 LagerApp v${window.appVersion} Reset`;
  }

  // Меняем h1
  const verElem = document.getElementById("ver");
  if (verElem) verElem.textContent = window.appVersion;

// восстанавливалка чекбоксов
  const sortCheckbox = document.getElementById("sortByOrtCheckbox");
if (sortCheckbox) {
// Восстанавливаем состояние из localStorage, если было
const saved = localStorage.getItem("sortByOrt");
if (saved !== null) {
  window.sortByOrt = saved === "true";
  sortCheckbox.checked = window.sortByOrt;
} else {
  window.sortByOrt = true;
  sortCheckbox.checked = true;
}
sortCheckbox.addEventListener("change", function () {
  window.sortByOrt = sortCheckbox.checked;
  localStorage.setItem("sortByOrt", window.sortByOrt ? "true" : "false");
  window.renderCart?.();
});
}

});



function waitForFirebaseAuth(cb) {
  if (window.onAuthStateChanged && window.auth) {
    cb();
  } else {
    setTimeout(() => waitForFirebaseAuth(cb), 30);
  }
}
// ====================================================== 
// === Переключатель видимости индикатора заполненности ===
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("toggleVolumeBlock");
  if (!toggle) return;

  // Инициализация состояния чекбокса из appState
  toggle.checked = window.appState.showVolumeBlock !== false;

  // Обработчик смены галочки
  toggle.addEventListener("change", function () {
    window.appState.showVolumeBlock = toggle.checked;
    window.updateBoxInfo();
  });
});

// ======================================================
// Глобальный слушатель клика для автозакрытия меню



document.addEventListener("DOMContentLoaded", function() {
  waitForFirebaseAuth(function() {
    window.onAuthStateChanged(window.auth, function(user) {
      console.warn("💥 ВХОД в waitForFirebaseAuth CB!");

      console.log("user в onAuthStateChanged:", user);
      window.isUserReady = !!user;
      console.log("isUserReady после присваивания:", window.isUserReady);

      //функция запуска локера
      window.showGlobalLoading("Bitte warten…");

      window.currentUser = user || null;
      window.isUserReady = !!user;
      window.tryRestoreExecuted = false;
      window.tryRestoreCart();

      console.warn("==> AUTH STATE CHANGED, user:", user ? user.uid : null);

      // === ВСТАВЬ ВОТ ЗДЕСЬ ===
      const authBlock = document.getElementById("authBlock");
      const mainUI = document.getElementById("mainUI");

      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");
      const registerBlock = document.getElementById("registerBlock");

      if (user) {
        authBlock?.classList.add("hidden");
        registerBlock?.classList.add("hidden");
        mainUI?.classList.remove("hidden");
        window.showGlobalLoading("Bitte warten…");

      } else {
        window.hideGlobalLoading();
        authBlock?.classList.remove("hidden");
        registerBlock?.classList.add("hidden"); // Регистрация только по ручному клику
        mainUI?.classList.add("hidden");
      }
      // === КОНЕЦ ВСТАВКИ ===

      if (!user) {
        window.appState.selectedItems = [];
        window.renderCart();
        window.updateCartButtons([]);
      }
    });
  });
});
//=============================================================================
// === ➕ Automatisch auffüllen автоматическое дополнение
//=============================================================================
window.autoFillCart = function () {
  const MAX_ITEMS = 12;
  const MIN_FILL = 0.95;
  const MAX_FILL = 1.10;

  let current = [...(window.appState.selectedItems || [])];
  const currentArtikels = new Set(current.map(i => i.Artikelnummer));

  const BOXES = {
    mittel: { name: "Mittel Box", max: 9720 },
    gross: { name: "Große Box", max: 31635 }
  };

  let totalVol = current.reduce((sum, x) => sum + (Number(x.Volumen) || 0) * Number(x.Menge || 1), 0);

  // === Автоматически определяем нужную коробку по объёму
  function pickBoxByVolume(vol) {
    if (vol <= BOXES.mittel.max * 0.95) return "mittel";
    return "gross";
  }

  const boxType = pickBoxByVolume(totalVol);
  const boxVol = BOXES[boxType].max;

  let fill = totalVol / boxVol;

  if (fill >= MIN_FILL) {
    alert(`Корзина уже заполнена на ${Math.round(fill * 100)}% (${BOXES[boxType].name})!`);
    return;
  }

  const allItems = window.artikelListe || [];
  const candidates = allItems.filter(
  row =>
    !currentArtikels.has(row.Artikelnummer) &&
    Number(row.Volumen) > 0
);
  const shuffled = candidates.sort(() => Math.random() - 0.5);

  let i = 0;
  while (fill < MIN_FILL && current.length < MAX_ITEMS && i < shuffled.length) {
  const row = shuffled[i];
  // Автоматически подбираем количество в зависимости от объёма товара:
  let menge = 1;
  const v = Number(row.Volumen) || 0;
  if (v > 3000) menge = 1;           // очень крупный — только 1
  else if (v > 800) menge = 2;       // средний — 2
  else if (v > 300) menge = 3;       // мелкий — 3
  else menge = 4;                    // очень мелкий — 4

  // Не выходим за границы коробки!
  let addVol = v * menge;
  // Если перебор, уменьшаем количество до допустимого
  while (addVol > 0 && (totalVol + addVol) / boxVol > MAX_FILL) {
    menge--;
    addVol = v * menge;
  }
  if (menge < 1) { i++; continue; }

  current.push({
    Artikelnummer: row.Artikelnummer,
    Artikelbezeichnung: row.Artikelbezeichnung,
    Ort: row.Ort,
    Volumen: row.Volumen,
    Menge: menge,
    status: "unverified"
  });

  totalVol += addVol;
  fill = totalVol / boxVol;
  i++;
}

  window.appState.selectedItems = current;
  window.renderCart();
};
  // Позже здесь будет логика подбора товаров до полной коробки.


/* 
// Главная функция для запуска сканера
window._startZXingBarcodeScan = async function () {
  const ZXing = window._zxingLoaded;
  if (!ZXing) return;

  const videoElem = document.getElementById('barcodeVideo');
  if (!videoElem) return;

  // Если уже есть предыдущий сканер — останавливаем!
  if (window._barcodeScanner) {
    try { window._barcodeScanner.stop(); } catch {}
    window._barcodeScanner = null;
  }

  // Весь UI делаем видимым
  videoElem.style.display = 'block';

  // Создаём сканер
  const codeReader = new ZXing.BrowserMultiFormatReader();
  window._barcodeScanner = codeReader;

  // Ищем первую доступную камеру
  let devices = [];
  try {
    devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
  } catch (e) {
    alert("Нет доступа к камере");
    window.closeBarcodeScanner();
    return;
  }

  const deviceId = devices && devices[0] ? devices[0].deviceId : null;
  if (!deviceId) {
    alert("Не найдена камера");
    window.closeBarcodeScanner();
    return;
  }

  // Запускаем декодер
  codeReader.decodeFromVideoDevice(deviceId, videoElem, (result, err, controls) => {
    if (result && result.getText) {
      const code = result.getText();
      // Только если EAN-13 (13 цифр)
      if (/^\d{13}$/.test(code)) {
        // Вставляем в поле поиска!
        const input = document.getElementById('searchInput');
        if (input) {
          input.value = code;
          // Можно сразу запустить поиск, если у тебя есть такая функция:
          // window.handleSearchInput?.();
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
        // Остановить сканер и закрыть модалку
        setTimeout(() => {
          window.closeBarcodeScanner();
        }, 300);
      }
    }
  });
};
*/
// Остановка сканера при закрытии модалки
const prevCloseBarcodeScanner = window.closeBarcodeScanner;
window.closeBarcodeScanner = function () {
  // Остановить сканер
  if (window._barcodeScanner) {
    try { window._barcodeScanner.reset(); } catch {}
    window._barcodeScanner = null;
  }
  // Спрятать видео
  const videoElem = document.getElementById('barcodeVideo');
  if (videoElem) {
    videoElem.srcObject = null;
    videoElem.style.display = 'none';
  }
  // Вызвать оригинальный close
  if (prevCloseBarcodeScanner) prevCloseBarcodeScanner();
};

/* менгемодал оверлей пока ненужная
//еще одна менге модал уже для сканеров
window.showMengeModal = function (artikelnummer, item) {
  // Создаём оверлей, если его нет
  let modal = document.getElementById('mengeModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'mengeModal';
    modal.style = 'position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:#fff;padding:20px 28px 16px 28px;border-radius:18px;min-width:230px;box-shadow:0 8px 24px #0002">
        <div style="font-weight:bold;margin-bottom:10px;">Товар: ${item?.Artikelbezeichnung || artikelnummer}</div>
        <input id="mengeInput" type="number" min="1" max="999" value="1" style="font-size:18px;padding:6px 12px;width:80px;border-radius:8px;border:1px solid #ccc;" autofocus>
        <div style="margin-top:12px;display:flex;gap:10px;">
          <button id="mengeOk" style="background:#22c55e;color:#fff;padding:7px 14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">OK</button>
          <button id="mengeCancel" style="background:#eee;padding:7px 14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">Отмена</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  } else {
    modal.style.display = "flex";
    modal.querySelector('input#mengeInput').value = "1";
  }

  // Обработчики
  modal.querySelector('#mengeOk').onclick = function () {
    const menge = parseInt(modal.querySelector('#mengeInput').value) || 1;
    // Добавить в корзину — вызывай свою функцию:
    window.addToCart?.(artikelnummer, menge, item);
    modal.style.display = "none";
  };
  modal.querySelector('#mengeCancel').onclick = function () {
    modal.style.display = "none";
  };
};
*/

</script>

<!-- 
//=============================================================================
// ====== Модалка менге ===
//================================================================================ -->
<div id="mengeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white p-6 rounded-2xl shadow-xl w-[320px] flex flex-col items-stretch">
    <h3 class="text-lg font-bold mb-2" id="mengeModalTitle">Artikel</h3>
    <label class="mb-2 text-sm text-gray-600">Menge:
      <input id="mengeInput" type="number" min="1" value="1"
            class="w-full mt-1 px-3 py-2 border rounded-xl text-lg" />
    </label>
    <div class="flex gap-2 mt-4 justify-end">
      <button onclick="window.closeMengeModal()" class="px-4 py-1 bg-gray-200 rounded-xl">Abbrechen</button>
      <button onclick="window.confirmMenge()" class="px-4 py-1 bg-blue-500 text-white rounded-xl">OK</button>
    </div>
  </div>
</div>

<!-- 
//=============================================================================
// ====== Глобальное модальное окно загрузки ===
//================================================================================ -->
<div id="globalLoadingOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-60 transition-opacity duration-300 hidden">
    <div class="rounded-2xl bg-white/80 px-6 py-8 shadow-2xl flex flex-col items-center">
      <div class="animate-spin h-10 w-10 mb-4 border-4 border-blue-500 border-t-transparent rounded-full"></div>
      <div class="text-lg font-semibold text-gray-800">Loading...</div>
      <div class="text-sm text-gray-500 mt-2" id="globalLoadingStatus"></div>
    </div>
  </div>

  

  




</div> <!-- закрывающий див -->
<footer class="text-center text-sm text-gray-300 mt-4">
  🔩 Alle Rechte an Muttern und Schrauben vorbehalten :) 
</footer>
<script src="firebase-setup.js" type="module"></script>
<!-- Tesseract.js-читалка текста -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<!-- HTML5 QR + BARCODE -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

</body>
</html>
