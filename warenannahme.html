<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="pageTitle">üì¶ Warenannahme</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script type="module" src="firebase-setup.js"></script>

  <style>
    #notificationArea {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 10px 24px;
      min-width: 200px;
      max-width: 90vw;
      border-radius: 16px;
      font-size: 1rem;
      box-shadow: 0 2px 18px 2px rgba(0,0,0,0.08);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.28s;
      text-align: center;
    }
    #notificationArea.active {
      opacity: 1;
      pointer-events: all;
    }
    </style>
    
</head>
<body class="bg-gray-100 text-gray-800">
<!-- üí† 0. –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="mainCardContainer" class="relative z-10 max-w-xl mx-auto bg-white rounded-2xl shadow p-6 mt-2 space-y-6">

  <!-- üß≠ 0. –•–µ–¥–µ—Ä –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div id="loginHeader" class="relative z-50 flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-center w-full">üì¶ Warenannahme v<span id="ver"></span></h1>
    <div class="absolute top-0 right-0">
      <button class="text-gray-600 text-2xl" onclick="window.toggleMenu()">‚ãÆ</button>
      <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-lg hidden z-60" id="menu">
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='index.html'">üîç Waren Suche</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='bestellungen.html'">üìÑ Bestellungen</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='warenannahme.html'">üì¶ Warenannahme</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="loginButton" onclick="window.toggleAuthForm()">üîê Anmelden</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 hidden" id="logoutButton" onclick="window.logout()">üö™ Abmelden</button>
      </div>
    </div>
  </div>

  <!-- üîí 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <section id="authBlock" class="space-y-4">
    <input id="email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
    <input id="password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
    <label class="flex items-center mb-2 ml-2 ">
      <input id="rememberMe" type="checkbox" class="mr-2" />
      Eingeloggt bleiben
    </label>
    <div class="h-2"></div>
    <button onclick="window.login()" class="w-full bg-blue-500 text-white py-2 rounded-xl hover:bg-blue-600">
      Einloggen
    </button>
    <div class="text-center text-sm text-blue-600 cursor-pointer hover:underline"
         id="switchAuthForms" onclick="window.toggleAuthForm()">
      Noch kein Konto? Registrieren
    </div>
    <p id="authStatus" class="mt-2 text-sm text-gray-500"></p>
  </section>
  <!-- –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <section id="registerBlock" class="space-y-4 hidden">
    <input id="reg_email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
    <input id="reg_password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
    <input id="reg_code" type="text" placeholder="Firmen-Code" class="w-full px-4 py-2 border rounded-xl mb-2" />
    <div class="h-2"></div>
    <button onclick="window.doRegister()" class="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600">
      Registrieren
    </button>
    <div class="mt-2 text-center text-sm text-blue-600 cursor-pointer hover:underline"
         onclick="window.toggleAuthForm()">
      Bereits registriert? Einloggen
    </div>
    <p id="registerStatus" class="mt-2 text-sm text-gray-500"></p>
  </section>
  <!--
  //=============================================================================
  –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  //=============================================================================
  -->
  <section id="mainUI" class="hidden space-y-6">
    <!-- 
    //=============================================================================
         2. –ü–æ–∏—Å–∫ –∏ QR 
     //=============================================================================
     -->
     <section id="searchBlock" class="mb-4">
        <div class="relative z-40">
          <h2 class="text-xl font-bold mb-2" id="searchTitle">üîç Artikel suchen & hinzuf√ºgen</h2>
          <input id="searchInput" type="text" placeholder="Artikelnummer oder Name oder Ort..." class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" />
          <div id="suggestions" class="absolute top-full left-0 w-full rounded-xl z-50 bg-white mt-2 hidden">
            <ul id="suggestionsList" class="max-h-60 overflow-y-auto"></ul>
          </div>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ Lieferschein geben (–≤—Å–µ–≥–¥–∞ –ø–æ–¥ –ø–æ–∏—Å–∫–æ–º) -->
        <button id="lieferscheinModeBtn" class="text-xs bg-gray-100 hover:bg-blue-100 px-2 py-1 rounded mt-2" onclick="window.toggleLieferscheinMode()">üìÑ Lieferschein geben</button>
        
        <!-- Lieferschein input-–±–ª–æ–∫, —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
        <div id="lieferscheinInputBlock" class="hidden mb-4">
            <div class="flex flex-row gap-2 items-center">
              <input id="lieferscheinInput" type="text" placeholder="Lieferschein-Nummer (z. B. LS-180625-001)" class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" />
              <button id="showLieferscheinBtn" class="bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 whitespace-nowrap" onclick="window.loadLieferschein()">anzeigen</button>
            </div>
            <button id="backToSearchBtn" class="text-xs bg-gray-100 hover:bg-blue-100 px-2 py-1 rounded mt-2" onclick="window.toggleLieferscheinMode()">
                <span class="mr-1">‚Üê</span> Zur√ºck zur Artikelsuche
              </button>
          </div>
      </section>
      
      
      

    <!-- 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–∂–µ) -->
    <section id="searchResultsBlock"></section>

    <!-- 4. –ö–æ—Ä–∑–∏–Ω–∞ -->
    <section id="cartBlock" class="space-y-2">
      <h2 class="text-xl font-bold mb-2">üßæ Ausgew√§hlte Artikel</h2>
      <div id="cartItems"><p class="text-gray-500 italic">Noch keine Artikel</p></div>
    </section>

     <!-- 4.1 –ß–µ–∫ –±–æ–∫—Å Ich habe alle Artikel und Mengen sorgf√§ltig gepr√ºft -->
     <label class="flex items-center mb-2 text-gray-700 ml-7" id="verifiedBlock" style="display: none;">
      <input type="checkbox" id="checkVerified" class="mr-2 scale-125" />
      Ich habe alle Artikel und Mengen sorgf√§ltig gepr√ºft.
    </label>

    <!-- 5. –ü–æ–∫–∞–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –∫–æ—Ä–æ–±–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–∏—ë–º–∫–∏, –æ—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –ø—É—Å—Ç—ã–º) -->
    <section id="volumeInfoBlock" class="text-sm text-gray-600"></section>

    <!-- 6. –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <section id="actionButtonsBlock"></section>
  </section>
</div>

<!-- 7. –ú–æ–¥–∞–ª–∫–∞ Menge -->
<div id="mengeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"></div>
<!-- 8. –ú–æ–¥–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmationModals" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"></div>
<!-- 9. UI-—Å–æ–æ–±—â–µ–Ω–∏—è / –æ—à–∏–±–∫–∏ -->
<div id="notificationArea" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-300 text-red-800 p-3 rounded-xl shadow-md hidden"></div>
<footer class="text-center text-sm text-gray-300 mt-4">
  üì¶ Alle Rechte an Kartons und Regalen vorbehalten
</footer>
<script type="module" src="firebase-setup.js"></script>
<script>


  //=============================================================================
  //=== JS 0. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —É—Ç–∏–ª–∏—Ç—ã ===
  //=============================================================================

  // –∞–≤—Ç–æ –º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
  window.appVersion = " 6.34"; // ‚Üê –ú–µ–Ω—è–µ—à—å —Ç–æ–ª—å–∫–æ —Ç—É—Ç

//=============================================================================
// === –†–∞–∑–±–∏–≤–∞–ª–∫–∞ –∞—Ä—Ç–∏–∫—É–ª–∞ –Ω–∞ —á–∞—Å—Ç–∏
//=============================================================================
window.formatArtikelnummer = function (nummer) {
  const str = String(nummer).trim();
  const thinSpace = "\u2009";

  const prefixMatch = str.match(/^[A-Z]+/i); // –ü—Ä–µ—Ñ–∏–∫—Å –∏–∑ –±—É–∫–≤ –≤ –Ω–∞—á–∞–ª–µ
  const prefix = prefixMatch ? prefixMatch[0] + " " : "";

  const raw = str.replace(/\D/g, ""); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

  if (raw.length === 13) {
    return prefix + raw.replace(/(\d{3})(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3${thinSpace}$4`);
  }

  if (raw.length === 12) {
    return prefix + raw.replace(/(\d{4})(\d{4})(\d{4})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 10) {
    return prefix + raw.replace(/(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 8) {
    return prefix + raw.replace(/(\d{4})(\d{4})/, `$1${thinSpace}$2`);
  }

  if (raw.length === 6) {
    return prefix + raw.replace(/(\d{3})(\d{3})/, `$1${thinSpace}$2`);
  }

  // fallback: –∫–∞–∂–¥—ã–µ 3‚Äì4 —Ü–∏—Ñ—Ä—ã
  return prefix + raw.replace(/(\d{3,4})(?=\d)/g, `$1${thinSpace}`);
};


//=============================================================================
// === –≥—É–≥–ª –∑–∞–≥–ª—É—à–∫–∞
//=============================================================================
window.appState = window.appState || {};
window.appState.selectedItems = [
  {
    Ort: 'R2/A3',
    Artikelnummer: '404 2277 111 467',
    Artikelbezeichnung: 'F√ºhrungsleiste 2st',
    Menge: 1,
    // –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å—Ç–∞—Ç—É—Å–Ω–∞—è –∏–∫–æ–Ω–∫–∞ ‚Äî –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ status
    // status: 'new'
  }
];

//=============================================================================
// === –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
//=============================================================================
  const searchInput = document.getElementById("searchInput");
  const suggestionsBox = document.getElementById("suggestions");
  const suggestionsList = document.getElementById("suggestionsList");
  window.searchInput = document.getElementById("searchInput");
  window.suggestionsBox = document.getElementById("suggestions");
//=============================================================================
// === –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∞–≤–∏—à –¥–ª—è Menge –∏ –¥—Ä—É–≥–æ–π –º–æ–¥–∞–ª–∫–∏
//=============================================================================
document.addEventListener("keydown", function (e) {
  const mengeModal = document.getElementById("mengeModal");
  const confirmModal = document.getElementById("confirmationModals");

  // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ Menge –æ—Ç–∫—Ä—ã—Ç–∞
  if (mengeModal && !mengeModal.classList.contains("hidden")) {
    if (e.key === "Escape") window.closeMengeModal();
    if (e.key === "Enter") {
      if (typeof window.appState.editIndex === "number") {
        window.saveEditedCartItem();
      } else {
        const mengeInput = document.getElementById("mengeInput");
        if (mengeInput && document.activeElement === mengeInput) {
          window.confirmMenge();
        }
      }
    }
    return;
  }

  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  if (confirmModal && !confirmModal.classList.contains("hidden")) {
    if (e.key === "Escape") window.hideDeleteConfirm();
    if (e.key === "Enter") window.confirmDeleteItem();
  }
});

  //=============================================================================
  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ–∏—Å–∫–∞
    window.hideSuggestions = function () {
  const suggestions = document.getElementById("suggestions");
  if (suggestions) suggestions.classList.add("hidden");
  if (suggestionsList) suggestionsList.innerHTML = "";
};
//=============================================================================
// === –ú–µ—Ä–¥–∂ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É (selectedItems), –æ–±—ä–µ–¥–∏–Ω—è—è Menge –ø–æ Artikelnummer
//=============================================================================
window.mergeItemsToCart = function(items) {
  if (!Array.isArray(items)) return;
  if (!window.appState) window.appState = {};
  if (!window.appState.selectedItems) window.appState.selectedItems = [];

  const normalizeNum = num => String(num).replace(/\s/g, '').trim();

  items.forEach(newItem => {
    // –ù–∞–π—Ç–∏ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ (artikelListe) –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
    const ref = window.artikelListe?.find(row =>
        normalizeNum(row.Artikelnummer) === normalizeNum(newItem.Artikelnummer) &&
        (row.Artikelbezeichnung || "") === (newItem.Artikelbezeichnung || "")
    );
    // –ë–µ—Ä—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ Ort –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
    const artikel = {
      ...newItem,
      Artikelbezeichnung: ref?.Artikelbezeichnung || "–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è",
      Ort: ref?.Ort || "-"
    };
    const existing = window.appState.selectedItems.find(
    it =>
        normalizeNum(it.Artikelnummer) === normalizeNum(artikel.Artikelnummer) &&
        (it.Artikelbezeichnung || "") === (artikel.Artikelbezeichnung || "")
    );
    if (existing) {
      if (existing.status === 'reserved') {
        window.unreserveItem(existing.Artikelnummer); // —Ç—É—Ç –º–æ–∂–Ω–æ existing, –æ–Ω —É–∂–µ —Ç–æ—á–Ω–æ –Ω–∞–π–¥–µ–Ω
      }
      existing.Menge += artikel.Menge;
      existing.status = 'unverified';
      console.log("–ù–∞–π–¥–µ–Ω –∏ –æ–±–Ω–æ–≤–ª–µ–Ω:", existing);
    } else {
        const menge = artikel.Menge || 0;
        const status = menge === 0 ? 'empty' : 'unverified';
        window.appState.selectedItems.push({...artikel, status});
    }
  });
  window.renderCart?.();
};

//=============================================================================
// === —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ Lieferschein:
//=============================================================================
window.loadLieferschein = async function () {
  const input = document.getElementById("lieferscheinInput");
  const btn = document.getElementById("showLieferscheinBtn");

  const nummer = input.value.trim();
  if (!nummer) {
    window.showNotification?.("Bitte Lieferschein-Nummer eingeben!", "error");
    return;
  }

  const docRef = window.doc(window.db, "lieferscheine", nummer);
  const snap = await window.getDoc(docRef);

  if (!snap.exists()) {
    window.showNotification?.("Lieferschein nicht gefunden!", "error");
    return;
  }
  const data = snap.data();

  // === –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ===
  if (data.status === "fertig") {
    window.showNotification?.("Dieser Lieferschein ist bereits abgeschlossen.", "info", 5000);
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –Ω–æ–º–µ—Ä –ª–∏—Ñ–µ—Ä—à–∞–π–Ω–∞
  window.currentLieferscheinNummer = nummer;
  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è  
  input.value = "";

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
  if (btn) {
    btn.disabled = true;
    btn.classList.add("opacity-60", "pointer-events-none");
    setTimeout(() => {
      btn.disabled = false;
      btn.classList.remove("opacity-60", "pointer-events-none");
    }, 2000);
  }

  // –ò—â–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'lieferscheine' –ø–æ –Ω–æ–º–µ—Ä—É
  try {
    const docRef = window.doc(window.db, "lieferscheine", nummer);
    const snap = await window.getDoc(docRef);
    if (!snap.exists()) {
      window.showNotification?.("Lieferschein nicht gefunden!", "error");
      return;
    }
    const data = snap.data();
    if (!Array.isArray(data.items)) {
      window.showNotification?.("Ung√ºltiges Format im Lieferschein!", "error");
      return;
    }
    window.mergeItemsToCart(
  data.items.map(item => ({
    ...item,
    Menge: 0 // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—Å–µ–º Menge = 0
  }))
);
    window.renderCart?.();
    window.showNotification?.("Lieferschein geladen und Artikel zur Liste hinzugef√ºgt.", "success");
  } catch (e) {
    window.showNotification?.("Fehler beim Laden: " + e.message, "error");
  }
};
//=============================================================================
//  —É–≤–µ–¥–æ–º–ª—è–Ω–∏–µ howNotification, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—ë –Ω–µ—Ç –ª–∏—Ñ–µ—Ä—à–∞–π–Ω–∞?
//=============================================================================
window.showNotification = function (msg, type = "info") {
  const el = document.getElementById("notificationArea");
  if (!el) return;
  el.textContent = msg;
  el.className = "active";
  // –¶–≤–µ—Ç–∞ –ø–æ —Ç–∏–ø—É
  if (type === "success") {
    el.style.background = "#d1fae5";
    el.style.color = "#065f46";
    el.style.border = "1px solid #34d399";
  } else if (type === "error") {
    el.style.background = "#fee2e2";
    el.style.color = "#991b1b";
    el.style.border = "1px solid #f87171";
  } else {
    el.style.background = "#bfdbfe";
    el.style.color = "#1e40af";
    el.style.border = "1px solid #3b82f6";
  }
  el.classList.add("active");
  clearTimeout(el._hideTimer);
  el._hideTimer = setTimeout(() => el.classList.remove("active"), 2300);
};



//=============================================================================
// === –æ—Ç–∫—Ä—ã–≤–∞–ª–∫–∞ –º–æ–¥–∞–ª–∫–∏
//=============================================================================
window.openMengeModal = function (item) {
  const modal = document.getElementById("mengeModal");
  if (!modal) return;
  window.selectedArtikel = item; // –∏–ª–∏ window.appState.selectedItem, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ç—Ä–æ–≥—É—é —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—é

  modal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-120px;">
      <h2 class="text-xl font-bold">Artikel hinzuf√ºgen</h2>
      <div class="text-left px-2">
        <p class="text-sm text-gray-500">${item.Artikelnummer || ''}</p>
        <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung || ''}</p>
      </div>
      <input id="mengeInput" type="number" min="1" value="1"
             class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
      <div class="flex justify-between pt-2 px-2 gap-2">
        <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
        <button onclick="window.confirmMenge()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
      </div>
    </div>
  `;

  modal.classList.remove("hidden");
  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input) {
      input.blur();
      input.focus();
      input.select();
    }
  }, 200);
  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input && document.activeElement !== input) {
      input.blur();
      input.focus();
      input.select();
    }
  }, 500);

  // –§–ª–∞–≥ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ UX (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –∏ —Ç.–ø.)
  window.appState = window.appState || {};
  window.appState.modalOpen = true;
};


//=============================================================================
// === –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ 
//=============================================================================
window.closeMengeModal = function () {
  const modal = document.getElementById("mengeModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.selectedArtikel = null;
};


//=============================================================================
// === –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–ª–∞–≤–∏—à–∞–º–∏
//=============================================================================
window.confirmMenge = function () {
  const mengeInput = document.getElementById("mengeInput");
  const menge = parseInt(mengeInput?.value, 10);
  const item = window.selectedArtikel;

  if (!item || isNaN(menge) || menge < 1) {
    if (mengeInput) mengeInput.classList.add("border-red-400");
    return;
  }

  // –ù–æ–≤—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:
  window.mergeItemsToCart([{ ...item, Menge: menge }]);

  window.closeMengeModal();
  // –û–ß–ò–©–ê–ï–ú –ü–û–ò–°–ö –∏ –ü–û–î–°–ö–ê–ó–ö–ò!
  if (window.searchInput) window.searchInput.value = "";
  if (window.suggestionsBox) window.suggestionsBox.classList.add("hidden");
};


//=============================================================================
// === JS 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ ===
//=============================================================================
window.login = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const remember = document.getElementById("rememberMe").checked;
  const persistence = remember ? window.browserSessionPersistence : window.inMemoryPersistence;

  try {
    await window.setPersistence(window.auth, persistence);
    const result = await window.signInWithEmailAndPassword(window.auth, email, password);
    document.getElementById("authStatus").textContent = `‚úÖ Eingeloggt als ${result.user.email}`;
    // ‚¨áÔ∏è –ß–∏—Å—Ç–∏–º –ø–æ–ª—è
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
  } catch (err) {
    document.getElementById("authStatus").textContent = `‚ùå Fehler: ${err.message}`;
  }
};

window.logout = async function () {
  try {
    await window.signOut(window.auth);
    document.getElementById("authStatus").textContent = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    const menu = document.getElementById("menu");
    if (menu) menu.classList.add("hidden");
  } catch (err) {
    console.error("Fehler beim Logout:", err);
  }
};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ª–æ–≥–∏–Ω–æ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
window.toggleAuthForm = function () {
  // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —é–∑–µ—Ä –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –∑–∞–ø—Ä–µ—â–∞–µ–º –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—ã
  if (window.currentUser) return;
  const authBlock = document.getElementById('authBlock');
  const registerBlock = document.getElementById('registerBlock');
  if (!authBlock || !registerBlock) return;
  authBlock.classList.toggle('hidden');
  registerBlock.classList.toggle('hidden');
  // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ç—É—Å—ã –æ—à–∏–±–æ–∫/—É—Å–ø–µ—Ö–∞
  const authStatus = document.getElementById('authStatus');
  const registerStatus = document.getElementById('registerStatus');
  if (authStatus) authStatus.textContent = "";
  if (registerStatus) registerStatus.textContent = "";
};

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Firebase Auth
window.doRegister = async function () {
  const email = document.getElementById("reg_email").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const code = document.getElementById("reg_code").value.trim();
  // –ü–æ–¥—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–≤–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –∫–æ–¥!
  const FIRMA_CODE = "LAGER2025"; // –≤—Ä–µ–º–µ–Ω–Ω–æ —Ç–∞–∫, –ø–æ—Ç–æ–º –≤—Å—Ç–∞–≤–∏—à—å –¥–µ–∫–æ–¥–µ—Ä Base64 –∫–∞–∫ –≤ Bestelung
  if (code !== FIRMA_CODE) {
    document.getElementById("registerStatus").textContent = "‚ùå Ung√ºltiger Firmen-Code!";
    return;
  }
  if (!email || !password) {
    document.getElementById("registerStatus").textContent = "‚ùå Email und Passwort erforderlich";
    return;
  }
  try {
    const result = await window.createUserWithEmailAndPassword(window.auth, email, password);
    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –≤—ã–¥–∞—ë–º –ø—Ä–∞–≤–∞ –≤ user_meta
    const userMetaRef = window.doc(window.db, "user_meta", result.user.uid);
    await window.setDoc(userMetaRef, { allowed: true });
    document.getElementById("registerStatus").textContent = "‚úÖ Registrierung erfolgreich! Bitte einloggen.";
    document.getElementById("reg_email").value = "";
    document.getElementById("reg_password").value = "";
    document.getElementById("reg_code").value = "";
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞)
    window.toggleAuthForm();
  } catch (err) {
    document.getElementById("registerStatus").textContent = "‚ùå Fehler: " + err.message;
  }
};

//=============================================================================
// JS 1.2 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏ (–¥–µ-)–ª–æ–≥–∏–Ω–µ
//=============================================================================
function waitForFirebaseAuth(cb) {
  if (window.onAuthStateChanged && window.auth) {
    cb();
  } else {
    setTimeout(() => waitForFirebaseAuth(cb), 30);
  }
}

document.addEventListener("DOMContentLoaded", function() {
  waitForFirebaseAuth(function() {
    window.onAuthStateChanged(window.auth, function(user) {
      window.currentUser = user || null;
      // === –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏ ===
      const authBlock = document.getElementById("authBlock");
      const registerBlock = document.getElementById("registerBlock");
      const mainUI = document.getElementById("mainUI");
      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");

      if (user) {
        authBlock?.classList.add("hidden");
        registerBlock?.classList.add("hidden");
        mainUI?.classList.remove("hidden");
        loginBtn?.classList.add("hidden");
        logoutBtn?.classList.remove("hidden");
      } else {
        authBlock?.classList.remove("hidden");
        registerBlock?.classList.add("hidden"); // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä—É—á–Ω–æ–º—É –∫–ª–∏–∫—É
        mainUI?.classList.add("hidden");
        loginBtn?.classList.remove("hidden");
        logoutBtn?.classList.add("hidden");
      }
    });
  });
});

//=============================================================================
// JS 2.1 –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏ —Ä–µ–∂–∏–º–æ–º Lieferschein
//=============================================================================
window.toggleLieferscheinMode = function () {
  const suggestions = document.getElementById("suggestions");
  const lieferscheinInputBlock = document.getElementById("lieferscheinInputBlock");
  const lieferscheinModeBtn = document.getElementById("lieferscheinModeBtn");
  window.hideSuggestions(); // ‚Üê –≤–æ—Ç –≠–¢–û –¥–æ–±–∞–≤—å –ü–ï–†–í–´–ú!
  // –ï—Å–ª–∏ —Ä–µ–∂–∏–º Lieferschein —É–∂–µ –≤–∫–ª—é—á—ë–Ω ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫)
  if (!lieferscheinInputBlock.classList.contains("hidden")) {
    lieferscheinInputBlock.classList.add("hidden");
    searchInput.classList.remove("hidden");
    suggestions.classList.remove("hidden");
    lieferscheinModeBtn.classList.remove("hidden");
  } else {
    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º Lieferschein
    lieferscheinInputBlock.classList.remove("hidden");
    searchInput.classList.add("hidden");
    suggestions.classList.add("hidden");
    lieferscheinModeBtn.classList.add("hidden"); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "Lieferschein geben"
  }
};

//=============================================================================
// 2.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:
//=============================================================================
window.artikelListe = [];
window.isCatalogReady = false;
  const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzKtilIhFbMNl5zlQL5XsQHI7WPKnTNmgzh3xgniyPx49pJJ1OjwbfuViFm86y0zYQ/exec";
  console.log("üü¢ –ó–∞–≥—Ä—É–∂–∞—é —Ç–∞–±–ª–∏—Ü—É –∏–∑:", GOOGLE_SHEET_URL);
  fetch(GOOGLE_SHEET_URL)
    .then((res) => res.json())
    .then((data) => {
      window.artikelListe = Array.isArray(data) ? data : (data.data || []);
      window.isCatalogReady = true;           // –ø–æ–¥–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ "—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ç–æ–≤"
      window.tryRestoreCart?.();              // –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
      window.showNotification?.("Katalog erfolgreich geladen!", "success");
      console.log("üü¢ –∑–∞–≥—Ä—É–∑–∫–∞ —É–¥–∞–ª–∞—Å—å:");
      // ...–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –Ω–∞–¥–æ
    })
    .catch((err) => {
      window.isCatalogReady = false;
      window.artikelListe = [];
      window.showNotification?.("‚ùå Fehler beim Laden der Artikelliste", "error");
      console.error("‚ùå Fehler beim Laden der Google Tabelle:", err);
    });

//=============================================================================
// === 2.3 –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏
//=============================================================================
document.addEventListener("DOMContentLoaded", function () {
    
    if (searchInput) {
        searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase().replace(/\//g, "").trim();
    if (!query || !window.artikelListe) {
        suggestionsBox.classList.add("hidden");
        return;
    }

    const matches = window.artikelListe.filter(row => {
        if (!row.Artikelnummer && !row.Artikelbezeichnung && !row.Ort) return false;

        const ort = String(row.Ort || '').toLowerCase().replace(/\//g, '');
        const nummer = String(row.Artikelnummer || '').toLowerCase();
        const name = String(row.Artikelbezeichnung || '').toLowerCase();
        return ort.includes(query) || nummer.includes(query) || name.includes(query);
    }).slice(0, 10);

    if (matches.length === 0) {
        suggestionsList.innerHTML = `<li class="px-4 py-2 text-gray-500 italic">Keine Ergebnisse</li>`;
    } else {
        suggestionsList.innerHTML = matches.map(row => `
        <li class="flex justify-between items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
            <span>${row.Ort || ''} ‚Äî ${row.Artikelnummer || ''} ‚Äî ${row.Artikelbezeichnung || ''}</span>
            <button onclick="window.openMengeModal(${JSON.stringify(row).replace(/"/g, '&quot;')})" class="text-green-600 text-xl ml-2">‚ûï</button>
        </li>
        `).join("");
    }

    suggestionsBox.classList.remove("hidden");
    });
  }
});


// ===============================
// JS 4. –ö–æ—Ä–∑–∏–Ω–∞ (—Ä–µ–Ω–¥–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ)
// ===============================
window.renderCart = function () {
  const cart = document.getElementById("cartItems");
  const items = window.appState.selectedItems || [];
  const sortedItems = [...items].sort((a, b) => {
    if ((a.status === 'reserved') && (b.status !== 'reserved')) return 1;
    if ((a.status !== 'reserved') && (b.status === 'reserved')) return -1;
    return 0;
  });

  if (!cart) return;
  if (items.length === 0) {
    
    cart.innerHTML = `
  <div class="bg-white rounded-xl px-2 py-2 mb-1 flex items-center min-h-[60px]">
    <span class="text-gray-400 italic text-base">Noch keine Artikel...</span>
  </div>
  <div style="height: 100px; pointer-events: none;"></div>
    `;
    return;
  }

  // –®–∞–≥ 1: —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é html
  let html = sortedItems.map((item, i) => {
    let bgClass, statusEmoji;

if (item.status === 'reserved') {
  bgClass = 'bg-green-100';
  statusEmoji = 'üü¢';
} else if (item.status === 'empty') {
  bgClass = 'bg-yellow-200';    // –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å bg-yellow-100 –∏–ª–∏ bg-yellow-300, —Å–º–æ—Ç—Ä–∏ –ø–æ –≤–∫—É—Å—É
  statusEmoji = 'üü†';
} else {
  bgClass = 'bg-gray-100';
  statusEmoji = 'üü°';
}
    return `
      <div class="${bgClass} rounded-xl px-4 py-2 mb-1 flex justify-between items-start gap-2">
        <div class="grid grid-cols-[56px_16px_1fr] gap-y-1">
          <!-- Ort —Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö—É -->
          <div class="text-sm text-gray-500 col-start-1 row-start-1">${item.Ort || '-'}</div>
          <!-- –ü—Ä–æ–±–µ–ª (—á—Ç–æ–±—ã –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–ª–æ—Å—å) -->
          <div class="col-start-2 row-start-1 w-4 h-px"></div>
          <!-- Artikelnummer —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É -->
          <div class="text-sm text-gray-500 col-start-3 row-start-1">
            ${String(item.Artikelnummer || '').trim().match(/^\d/) ? window.formatArtikelnummer(item.Artikelnummer) : '‚Äî'}
          </div>
          <!-- –≠–º–æ–¥–∑–∏ (—Å—Ç–∞—Ç—É—Å) —Å–ª–µ–≤–∞ –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ -->
          <div class="col-start-1 row-start-2 flex justify-center items-center">
            <span class="inline-block align-middle text-sm" style="line-height: 1;">${statusEmoji}</span>
          </div>
          <!-- –ü—Ä–æ–±–µ–ª -->
          <div class="col-start-2 row-start-2 w-4 h-px"></div>
          <!-- Artikelbezeichnung —Å–ø—Ä–∞–≤–∞ –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ -->
          <div class="col-start-3 row-start-2 flex items-center gap-2">
            <span class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</span>
          </div>
        </div>
        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –∫–Ω–æ–ø–∫–∏ -->
        <div class="flex flex-col items-end text-right ml-2">
          <div class="font-semibold text-base flex items-center gap-2 justify-end">
            <span class="ml-2">√ó ${item.Menge}</span>
          </div>
          ${item.status === 'empty'
            ? '<div class="text-xs text-orange-700 mt-1">Bitte Menge eintragen!</div>'
            : ''}
          <div class="flex gap-1 mt-1">
            ${
              item.status === 'reserved'
                ? `<button onclick="window.unreserveItem('${item.Artikelnummer}')" title="Reservierung aufheben" class="text-yellow-600 text-lg">üö´</button>`
                : `
                  <button onclick="window.editCartItem('${item.Artikelnummer}')" title="Bearbeiten" class="text-blue-600 text-lg">‚úèÔ∏è</button>
                  <button onclick="window.showDeleteConfirm('${item.Artikelnummer}')" title="L√∂schen" class="text-red-600 text-lg">üóëÔ∏è</button>
                `
            }
          </div>
        </div>
      </div>
    `;
  }).join("");

  // –®–∞–≥ 2: –µ—Å–ª–∏ –º–∞–ª–æ –∫–∞—Ä—Ç–æ—á–µ–∫, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ–π—Å–µ—Ä
  if (sortedItems.length <= 3) {
    html += '<div style="height: 100px; pointer-events: none;"></div>';
}

  // –®–∞–≥ 3: –≤—Å—Ç–∞–≤–ª—è–µ–º html –≤ cart
  cart.innerHTML = html;

  window.renderActionButtons?.();
  // —á–µ–∫–±–æ–∫—Å –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –±—ã–ª–∞
  const verifiedBlock = document.getElementById("verifiedBlock");
  if (verifiedBlock) {
    const check = document.getElementById("checkVerified");
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π!
    if (window.appState.selectedItems && window.appState.selectedItems.length === 0) {
      if (check) check.checked = false;
    }
    verifiedBlock.style.display = (window.appState.selectedItems && window.appState.selectedItems.length > 0) ? "" : "none";
    if (check && !check._handlerAttached) {
      check.addEventListener("change", function() {
        window.renderActionButtons?.();
      });
      check._handlerAttached = true;
    }
  }
};





// ===============================
// JS 4.1 –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
// ===============================
window.deleteCartItem = function(index) {
  if (!window.appState.selectedItems) return;
  window.appState.selectedItems.splice(index, 1);
  window.renderCart();
};


//=============================================================================
// === JS 4.2 —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
//=============================================================================
window.saveEditedCartItem = function () {
  const index = window.appState.editIndex;
  const input = document.getElementById("mengeInput");
  const neueMenge = parseInt(input?.value, 10);

  if (typeof index !== "number" || !window.appState.selectedItems[index]) {
    window.closeMengeModal();
    return;
  }
  if (!Number.isInteger(neueMenge) || neueMenge < 0) {
    input.classList.add("border-red-400");
    input.focus();
    return;
  }

  // –ú–µ–Ω—è–µ–º Menge
  window.appState.selectedItems[index].Menge = neueMenge;
    // === —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å 0 –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –º–µ–Ω–≥–µ!=
    window.appState.selectedItems[index].status =
    neueMenge === 0 ? 'empty' : 'unverified';



  window.closeMengeModal();
  window.renderCart();
};


// ===============================
// JS 8. –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
// ===============================
window.showDeleteConfirm = function(artikelnummer) {
  const items = window.appState.selectedItems || [];
  const index = items.findIndex(x => String(x.Artikelnummer) === String(artikelnummer));
  if (index === -1) return;
  
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;
  const item = items[index];
  if (!item) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  window.appState.confirmDeleteIndex = index;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Artikel l√∂schen?</h2>
        <div class="text-lg text-gray-800 mb-4">"${item.Artikelbezeichnung}" wirklich entfernen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmDeleteItem()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

// hideDeleteConfirm –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
window.hideDeleteConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.confirmDeleteIndex = null;
};

window.confirmDeleteItem = function () {
  const index = window.appState.confirmDeleteIndex;
  if (typeof index === "number") {
    window.deleteCartItem(index);
  }
  window.hideDeleteConfirm();
};


//=============================================================================
// === –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
//=============================================================================
window.editCartItem = function(artikelnummer) {
  const items = window.appState.selectedItems || [];
  const index = items.findIndex(x => String(x.Artikelnummer) === String(artikelnummer));
  if (index === -1) return;
  const item = items[index]; // –≤–æ—Ç —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω—É–∂–µ–Ω!

  const modal = document.getElementById("mengeModal");
  if (!modal) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  window.appState.editIndex = index;

  modal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2" style="margin-top:-120px;">
      <h2 class="text-xl font-bold">Menge √§ndern</h2>
      <div class="text-left px-2">
        <p class="text-sm text-gray-500">${item.Artikelnummer || ''}</p>
        <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
      </div>
      <input id="mengeInput" type="number" min="1" value="${item.Menge || 1}"
             class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
      <div class="flex justify-between pt-2 px-2 gap-2">
        <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
        <button onclick="window.saveEditedCartItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input) {
      input.blur();
      input.focus();
      input.select();
    }
  }, 200);
  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input && document.activeElement !== input) {
      input.blur();
      input.focus();
      input.select();
    }
  }, 500);

  window.appState.modalOpen = true;
};




//–º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
//=============================================================================
document.addEventListener("DOMContentLoaded", function() {
  // –ú–µ–Ω—è–µ–º <title>
  const pageTitle = document.getElementById("pageTitle");
  if (pageTitle) {
    pageTitle.textContent = `üì¶ Warenannahme v${window.appVersion} Reset`;
  } else {
    document.title = `üì¶ Warenannahme v${window.appVersion} Reset`;
  }

  // –ú–µ–Ω—è–µ–º h1
  const verElem = document.getElementById("ver");
  if (verElem) verElem.textContent = window.appVersion;
});

//=============================================================================
//=== toggleMenu
//=============================================================================
window.toggleMenu = function () {
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");

  if (window.currentUser) {
    loginBtn?.classList.add("hidden");
    logoutBtn?.classList.remove("hidden");
  } else {
    loginBtn?.classList.remove("hidden");
    logoutBtn?.classList.add("hidden");
  }

  const menu = document.getElementById("menu");
  if (menu) menu.classList.toggle("hidden");
};


//=============================================================================
// === —Å–ª—É—à–∞–ª–∫–∞ —Ç–æ–≥–≥–ª –º–µ–Ω—é
// ============================================================================
document.addEventListener("click", function (e) {
  const menu = document.getElementById("menu");
  const toggleBtn = document.querySelector("button[onclick*='toggleMenu']");
  if (
    menu &&
    !menu.classList.contains("hidden") &&
    !menu.contains(e.target) &&
    e.target !== toggleBtn
  ) {
    menu.classList.add("hidden");
  }
});
//=============================================================================
// === –î–û–ú —Ä–∏—Å–æ–≤–∞–ª–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∫–Ω–æ–ø–æ–∫
//=============================================================================
document.addEventListener("DOMContentLoaded", function() {
    window.renderActionButtons?.();
  window.renderCart();
  // —Å–∫—Ä–æ–ª –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–≥–¥–∞ –æ–Ω –≤ —Ñ–æ–∫—É—Å–µ
  const searchInput = document.getElementById("searchInput");
    //–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–ª–∫–∞ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
    if (searchInput) {
        searchInput.addEventListener("click", function () {
            setTimeout(() => {
            // –°–∫—Ä–æ–ª–ª–∏–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –±—ã–ª–∞ ~32px –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const rect = searchInput.getBoundingClientRect();
            const absoluteY = window.scrollY + rect.top;
            window.scrollTo({
                top: absoluteY - 32, // 32px ‚Äî –∂–µ–ª–∞–µ–º—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
                behavior: "smooth"
            });
            }, 50);
        });
        }

});

//=============================================================================
// === —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ ( —É–¥–∞–ª—è–µ—Ç –µ—Å–ª–∏ —Ç–∫–Ω—É–ª –∑–∞ –∑–∞ –ø—Ä–∏–¥–µ–ª–∞–º–∏)
//=============================================================================

document.addEventListener("click", (e) => {
  const inside = searchInput.contains(e.target) || suggestionsBox.contains(e.target);
  if (!inside && !window.appState?.modalOpen) {
    suggestionsBox.classList.add("hidden");
    searchInput.value = ""; // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—á–∏—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞
  }
});

//=============================================================================
// === –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ
//=============================================================================
window.renderActionButtons = function () {
  const block = document.getElementById("actionButtonsBlock");
  if (!block) return;

  const items = window.appState.selectedItems || [];
   const allReserved = items.length > 0 && items.every(item => item.status === 'reserved');
  const allUnverified = items.length > 0 && items.every(item => item.status !== 'reserved');
  const anyReserved = items.some(item => item.status === 'reserved');
  const anyUnreserved = items.some(item => item.status !== 'reserved');
  const cartIsEmpty = items.length === 0;
  const isVerified = document.getElementById("checkVerified")?.checked;

  if (cartIsEmpty) {
    block.innerHTML = `
      <div class="flex flex-col sm:flex-row gap-2 mt-2">
        <button class="flex-1 px-4 py-2 rounded-xl bg-gray-300 text-gray-500 cursor-not-allowed" disabled>‚úîÔ∏è Bearbeitung abschlie√üen</button>
        <button class="flex-1 px-4 py-2 rounded-xl bg-gray-300 text-gray-500 cursor-not-allowed" disabled>üóëÔ∏è Unreservierte entfernen</button>
      </div>
    `;
    return;
  }

  if (allUnverified) {
    block.innerHTML = `
      <div class="flex flex-col sm:flex-row gap-2 mt-2">
        <button onclick="window.checkAndReserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">‚úîÔ∏è Bearbeitung abschlie√üen</button>
        <button onclick="window.showClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-300">üóëÔ∏è Unreservierte entfernen</button>
      </div>
    `;
    return;
  }

  if (allReserved) {
  block.innerHTML = `
    <div class="flex flex-col sm:flex-row gap-2 mt-2">
      <button onclick="window.showConfirmAbschliessen()" 
        class="flex-1 px-4 py-2 rounded-xl ${isVerified ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
        ${isVerified ? '' : 'disabled'}>
        ‚úîÔ∏è Warenannahme abschlie√üen
      </button>
      <button onclick="window.showUnreserveAllConfirm()" 
        class="flex-1 px-4 py-2 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600">
        üö´ Reservierung aufheben
      </button>
    </div>
  `;
  return;
}

  if (anyReserved && anyUnreserved) {
  block.innerHTML = `
    <div class="flex flex-col sm:flex-row gap-2 mt-2">
      <button onclick="window.checkAndReserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">‚úîÔ∏è Bearbeitung abschlie√üen</button>
      <button onclick="window.showClearUnreservedConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">üóëÔ∏è Unreservierte entfernen</button>
      <button onclick="window.showUnreserveAllConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600">üö´ Reservierung aufheben</button>
    </div>
  `;
  return;
}

  // ... –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞–∑–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ—Å—Ç–∞–≤—å –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ –µ—Å—Ç—å, –≤–µ—Ä–Ω–µ–º—Å—è)
};




//=============================================================================
// === –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ
//=============================================================================

// –ó–∞–≥–ª—É—à–∫–∞: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
window.checkAndReserveAll = function () {
  const items = window.appState.selectedItems || [];
  let changed = false;
  items.forEach(item => {
    if (item.status !== 'reserved') {
      item.status = 'reserved';
      changed = true;
    }
  });
  window.renderCart?.();
  window.showNotification?.(changed ? "Alle Artikel reserviert." : "Nichts zu reservieren.", "success");
};




// –ó–∞–≥–ª—É—à–∫–∞: –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏—ë–º–∫—É (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å–µ)
window.confirmAllItems = function () {
  window.showNotification?.("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏—ë–º–∫–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ", "info");
};

// –ó–∞–≥–ª—É—à–∫–∞: –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
window.unreserveAll = function () {
  window.showNotification?.("–°–Ω—è—Ç–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ", "info");
};

// –ó–∞–≥–ª—É—à–∫–∞: –ß–∞—Å—Ç—å –≤ —Ä–µ–∑–µ—Ä–≤–µ —á–∞—Å—Ç—å –Ω–µ—Ç
window.clearUnreservedItems = function () {
  window.showNotification?.("–£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ", "info");
};

//=============================================================================
// === —á—Ç–æ —Ç–æ —Å —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ
//=============================================================================
window.unreserveItem = function (artikelnummer) {
  const items = window.appState.selectedItems || [];
  const item = items.find(x => String(x.Artikelnummer) === String(artikelnummer));
  if (!item) return;
  item.status = 'unverified';
  window.renderCart?.();
  window.showNotification?.("Reservierung aufgehoben.", "success");
};

//=============================================================================
// === –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É (Warenkorb leeren):
//=============================================================================
window.clearCart = function () {
  window.appState.selectedItems = [];
  window.renderCart?.();
  window.showNotification?.("Warenkorb geleert.", "success");
};

//=============================================================================
// === –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
//=============================================================================
window.clearUnreservedItems = function () {
  const items = window.appState.selectedItems || [];
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º reserved
  window.appState.selectedItems = items.filter(item => item.status === 'reserved');
  window.renderCart?.();
  window.showNotification?.("Nur reservierte Artikel bleiben erhalten.", "success");
};

//=============================================================================
// === –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–∏—â–µ–Ω–∏—è 
//=============================================================================
window.showClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Warenkorb wirklich leeren?</h2>
        <div class="text-lg text-gray-800 mb-4">Alle Artikel werden gel√∂scht!</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmClearCart()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
// === —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è 
//=============================================================================
window.confirmClearCart = function () {
  window.hideDeleteConfirm();
  window.clearCart();
};

//=============================================================================
// === –º–æ–¥–∞–ª–∫–∞ –¥–ª—è üö´ Reservierung aufheben
//============================================================================= 
window.showUnreserveAllConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Reservierung aufheben?</h2>
        <div class="text-lg text-gray-800 mb-4">Alle reservierten Artikel werden wieder bearbeitbar.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmUnreserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
// === –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî‚Äú—Å–Ω–∏–º–∞–µ–º‚Äù —Ä–µ–∑–µ—Ä–≤ —É –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
//=============================================================================


window.confirmUnreserveAll = function () {
  const items = window.appState.selectedItems || [];
  items.forEach(item => {
    if (item.status === 'reserved') {
      item.status = 'unverified';
    }
  });
  window.hideDeleteConfirm();
  window.renderCart?.();
  window.showNotification?.("Alle Reservierungen aufgehoben.", "success");
};

//=============================================================================
// === –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
//=============================================================================

window.showClearUnreservedConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Unreservierte Artikel entfernen?</h2>
        <div class="text-lg text-gray-800 mb-4">Alle nicht reservierten Artikel werden gel√∂scht.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmClearUnreserved()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
// === –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
//=============================================================================
window.confirmClearUnreserved = function () {
  const items = window.appState.selectedItems || [];
  window.appState.selectedItems = items.filter(item => item.status === 'reserved');
  window.hideDeleteConfirm();
  window.renderCart?.();
  window.showNotification?.("Nur reservierte Artikel bleiben erhalten.", "success");
};

//=============================================================================
// === –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è ‚ÄúAbschlie√üen‚Äù
//=============================================================================

window.showConfirmAbschliessen = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
        <h2 class="text-xl font-bold mb-3">Warenannahme abschlie√üen?</h2>
        <div class="text-lg text-gray-800 mb-4">Alle reservierten Artikel werden endg√ºltig √ºbernommen und die Liste geleert.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmAbschliessen()" class="flex-1 px-4 py-2 rounded-xl bg-blue-500 text-white hover:bg-blue-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

//=============================================================================
// === –±–µ–∞—Ä–±–∞–π—Ç—É–Ω–≥ –Ω–∞ –∫–Ω–æ–ø–∫–µ –æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏—ë–º–∫–∏ ‚ÄúAbschlie√üen‚Äù
//=============================================================================



//=============================================================================
// === –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏—ë–º–∫–∏ ‚ÄúAbschlie√üen‚Äù –æ—Ç—Å—ã–ª–∫–∞ –∏ –æ—Ç—á–∏—Å—Ç–∫–∞
//=============================================================================
window.confirmAbschliessen = async function () {

// –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É OK + —Å–ø–∏–Ω–Ω–µ—Ä
const modal = document.getElementById("confirmationModals");
if (modal) {
  const okBtn = modal.querySelector("button.bg-blue-500, button.bg-red-500");
  if (okBtn) {
    okBtn.disabled = true;
    okBtn.innerHTML = `<span class="animate-pulse mr-1">‚è≥</span>Bitte warten...`;
    okBtn.classList.remove("bg-blue-500", "hover:bg-blue-600", "bg-red-500", "hover:bg-red-600");
    okBtn.classList.add("bg-gray-300", "text-gray-500", "cursor-not-allowed");
  }
}

// –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ reserved —Ç–æ–≤–∞—Ä–æ–≤
const items = (window.appState.selectedItems || []).filter(item => item.status === 'reserved');
if (items.length === 0) {
  window.showNotification?.("Keine reservierten Artikel.", "error");
  return;
}
// –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
for (const item of items) {
  const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const neueMenge = (Number(artikelData.Menge) || 0) + Number(item.Menge || 0);
    await window.setDoc(artikelRef, { ...artikelData, Menge: neueMenge }, { merge: true });
  }
}
// –ù–ê–î–Å–ñ–ù–û –ø–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –ª–∏—Ñ–µ—Ä—à–∞–π–Ω–∞
let nummer = window.currentLieferscheinNummer;
if (!nummer) {
  const input = document.getElementById("lieferscheinInput");
  nummer = input?.value.trim();
}
if (nummer) {
  const lieferscheinRef = window.doc(window.db, "lieferscheine", nummer);
  await window.setDoc(lieferscheinRef, { status: "fertig", abgeschlossenAm: Date.now() }, { merge: true });
  window.currentLieferscheinNummer = null; // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
}


// –ó–¥–µ—Å—å –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ Firestore –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç!
// –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
window.hideDeleteConfirm();
window.appState.selectedItems = [];
window.renderCart?.();
setTimeout(() => {
  window.renderActionButtons?.();
}, 50);
// –°–±—Ä–æ—Å —á–µ–∫–±–æ–∫—Å–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
const check = document.getElementById("checkVerified");
if (check) check.checked = false;

window.showNotification?.("Warenannahme abgeschlossen. Liste geleert.", "success");
};











</script>
<div id="notificationArea" class="hidden"></div>

<!--
//=============================================================================
// === –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ Menge
//============================================================================= -->


<div id="mengeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-[320px] flex flex-col items-stretch">
      <h3 class="text-lg font-bold mb-2" id="mengeModalTitle">Artikel</h3>
      <label class="mb-2 text-sm text-gray-600">Menge:
        <input id="mengeInput" type="number" min="1" value="1"
               class="w-full mt-1 px-3 py-2 border rounded-xl text-lg" />
      </label>
      <div class="flex gap-2 mt-4 justify-end">
        <button onclick="window.closeMengeModal()" class="px-4 py-1 bg-gray-200 rounded-xl">Abbrechen</button>
        <button onclick="window.confirmMenge()" class="px-4 py-1 bg-blue-500 text-white rounded-xl">OK</button>
      </div>
    </div>
  </div>

</body>
</html>
