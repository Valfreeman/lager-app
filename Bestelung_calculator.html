
<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="pageTitle">üì¶ LagerApp</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<style>
    @media (max-width: 600px) {
      .modal-bottom {
        top: auto !important;
        bottom: 0 !important;
        left: 0;
        right: 0;
        margin: auto;
        transform: none !important;
        max-width: 96vw;
        border-radius: 24px 24px 0 0;
        /* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å background, box-shadow, padding –ø–æ –≤–∫—É—Å—É */
      }
    }
    </style>
<body class="bg-gray-100 text-gray-800">
<!-- üí† –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="mainCardContainer" class="relative z-10 max-w-xl mx-auto bg-white rounded-2xl shadow p-6 mt-2 space-y-6">


<!-- üß≠ 0. –•–µ–¥–µ—Ä –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è -->

<div id="loginHeader" class="relative z-50 flex justify-between items-center mb-4 relative">
    <h1 class="text-2xl font-bold text-center w-full">üì¶ Lager App v<span id="ver"></span></h1>
    <div class="absolute top-0 right-0">
      <button class="text-gray-600 text-2xl" onclick="window.toggleMenu()">‚ãÆ</button>
      <div class="absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow-lg hidden z-60" id="menu">
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='index.html'">üîç Waren Suche</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='bestellungen.html'">üìÑ Bestellungen</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" onclick="window.location.href='Warenannahme.html'">üì¶ Warenannahme</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100" id="loginButton" onclick="window.toggleAuthForm()">üîê Anmelden</button>
        <button class="block w-full text-left px-4 py-2 hover:bg-gray-100 hidden" id="logoutButton" onclick="window.logout()">üö™ Abmelden</button>
      </div>
    </div>
  </div>

  <!-- üì¶ UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
  <div id="mainUIWrapper">

    <!-- üîí 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <section id="authBlock" class="space-y-4">
      <input id="email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <input id="password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
      <label class="flex items-center mb-2">
        <input id="rememberMe" type="checkbox" class="mr-2" />
        Eingeloggt bleiben
      </label>
      <button onclick="window.login()" class="w-full bg-blue-500 text-white py-2 rounded-xl hover:bg-blue-600">
        Einloggen
      </button>
      <!-- üîÑ –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è -->
      <div class="text-center text-sm text-blue-600 cursor-pointer hover:underline"
      id="switchAuthForms" onclick="window.toggleAuthForm()">
        Noch kein Konto? Registrieren
        </div>
      <p id="authStatus" class="mt-2 text-sm text-gray-500"></p>
    </section>

    <!--—Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏  -->
    <section id="registerBlock" class="space-y-4 hidden">
        <input id="reg_email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_password" type="password" placeholder="Passwort" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <input id="reg_code" type="text" placeholder="Firmen-Code" class="w-full px-4 py-2 border rounded-xl mb-2" />
        <button onclick="window.doRegister()" class="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600">
          Registrieren
        </button>
        <div class="mt-2 text-center text-sm text-blue-600 cursor-pointer hover:underline"
             onclick="window.toggleAuthForm()">
          Bereits registriert? Einloggen
        </div>
        <p id="registerStatus" class="mt-2 text-sm text-gray-500"></p>
      </section>



<!-- üéõÔ∏è –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <section id="mainUI" class="hidden space-y-6">

        <!-- üé≤ 1.5 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞) -->
        <section id="orderGeneratorHeader" class="space-y-2">
          <button class="w-full bg-yellow-300 text-black py-2 rounded-xl hover:bg-yellow-400">üé≤ Zuf√§lliger Auftrag</button>
          <button class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">‚öôÔ∏è Generator-Einstellungen</button>
        </section>
  
        <!-- üîç 2 –ü–æ–∏—Å–∫ -->
        <section id="searchBlock" class="space-y-4">
          <div class="relative z-40">
            <h2 class="text-xl font-bold mb-2">üîç Artikel suchen & hinzuf√ºgen</h2>
            <input id="searchInput" type="text" placeholder="Artikelnummer oder Name oder Ort..." class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" />
            <div id="suggestions" class="absolute top-full left-0 w-full rounded-xl shadow z-50 border bg-white mt-2 hidden">
              <ul id="suggestionsList" class="max-h-60 overflow-y-auto"></ul>
            </div>
          </div>
          <button id="openQRButton" onclick="window.openQRScanner()" class="w-full bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300">
            üì∑ QR-Scanner (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
          </button>
        </section>

        <!-- üìã 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
        <section id="searchResultsBlock">
        <!-- TODO: –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        </section>
        <!-- Dev: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ -->
        <div id="volumeToggleContainer" class="flex items-center gap-2 mb-2 select-none">
            <input type="checkbox" id="toggleVolumeBlock" class="h-4 w-4" checked />
            <label for="toggleVolumeBlock" class="text-sm text-gray-600 cursor-pointer">
            üì¶ 
            </label>
        </div>
        <!-- üõí 4 –ö–æ—Ä–∑–∏–Ω–∞ -->
        <section id="cartBlock" class="space-y-2">
          <h2 class="text-xl font-bold mb-2">üßæ Ausgew√§hlte Artikel</h2>
          <div id="cartItems"><p class="text-gray-500 italic">Noch keine Artikel</p></div>
          <div id="cartItems" style="min-height: 8px;"></div>
        </section>
  
        <!-- üì¶ 5 –ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å -->
        <section id="volumeInfoBlock" class="text-sm text-gray-600">
          <div id="boxSummary">üì¶ Mittel Box ‚Äì 0% voll</div>
          <div id="initialBoxInfo">üì¶ Gesch√§tzte Box ‚Äì 0% geplant</div>
        </section>
  
        <!-- üöö 6. –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <section id="actionButtonsBlock">
            <div class="flex justify-between gap-2 mb-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ‚ûï Automatisch auff√ºllen
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                üóëÔ∏è Unreservierte Artikel entfernen
              </button>
            </div>
            <div class="flex justify-between gap-2">
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                ‚úîÔ∏è Pr√ºfen & reservieren
              </button>
              <button class="flex-1 bg-gray-200 text-gray-400 py-2 rounded-xl cursor-not-allowed" disabled>
                üö´ Alle Reservierungen aufheben
              </button>
            </div>
          </section>
  
      </section>
    </div>

        <!-- ‚ûï 7. –ú–æ–¥–∞–ª–∫–∞ Menge -->
        <div id="mengeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ -->
      </div>
  
      <!-- ‚ùó 8. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
      <div id="confirmationModals" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- TODO: –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ -->
      </div>
  
      <!-- üí¨ 9. UI-—Å–æ–æ–±—â–µ–Ω–∏—è -->
      <div id="notificationArea" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-300 text-red-800 p-3 rounded-xl shadow-md hidden">
    <!-- TODO: –û—à–∏–±–∫–∏ / –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  </div>
  <div class="bg-orange-400 hidden">purge-keep</div>

  <script type="module">
    // –∞–≤—Ç–æ –º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
    window.appVersion = " 5.95"; // ‚Üê –ú–µ–Ω—è–µ—à—å —Ç–æ–ª—å–∫–æ —Ç—É—Ç

    const FC64 = "TEFHRVIyMDI1"; 

    function decodeBase64(str) {
    try {
        return atob(str);
    } catch {
        return "";
    }
    }


    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
  // –§–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.isCatalogReady = false;       // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ (Google –¢–∞–±–ª–∏—Ü–∞)
  window.isUserReady = false;          // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.tryRestoreExecuted = false;   // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞

  // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –í–°–Å –≥–æ—Ç–æ–≤–æ!
  window.tryRestoreCart = function () {
    //–∫–æ–Ω—Å–æ–ª—å
    console.warn("üí° –í–•–û–î –≤ tryRestoreCart", {
  isCatalogReady: window.isCatalogReady,
  isUserReady: window.isUserReady,
  currentUser: window.currentUser
    });


    if (window.tryRestoreExecuted) return; // –£–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏
    if (window.isCatalogReady && window.isUserReady && window.currentUser) {
      console.log("‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É...");
      window.tryRestoreExecuted = true;
      window.restoreCartFromFirestore(window.currentUser.uid);
    } else {
      console.log("‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ", {
        isCatalogReady: window.isCatalogReady,
        isUserReady: window.isUserReady,
        currentUser: window.currentUser
      });
    }
  };



    // ================================
    // üß≠ JS 0. –•–µ–¥–µ—Ä –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è
    // ================================
    

    /*
  ===============================================
  ‚ùóÔ∏è –ü–∞–º—è—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã: –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ OK/Cancel

  - –í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∫–∞–∂–¥–∞—è –º–æ–¥–∞–ª–∫–∞ (–ª–æ–≥–∏–Ω, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Menge –∏ –¥—Ä.)
  —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ ‚Äî —Å–æ —Å–≤–æ–∏–º–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∫–Ω–æ–ø–æ–∫ OK –∏ Cancel.
  - –£–Ω–∏–≤–µ—Ä—Å–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤—ã–Ω–æ—Å –≤ –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è!
  - –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–ª–∏ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ok/cancel) –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö
  –º–æ–¥–∞–ª–∫–∞—Ö, —ç—Ç–æ –ù–ï —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è.
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —É—Å—Ç–æ–π—á–∏–≤–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∂–¥–æ–π –º–æ–¥–∞–ª–∫–∏, –¥–∞–∂–µ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–¥–∞.
  - –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–∞–ª–æ–∫ ‚Äî –æ–±—Å—É–∂–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ.
  ===============================================
  */

  /*
  ‚Äú–í –ª—é–±–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –≥–¥–µ –º–µ–Ω—è–µ—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã, –ø–æ—Å–ª–µ renderCart() –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–æ–≤ updateCartButtons(). 
  –ù–µ —ç–∫–æ–Ω–æ–º–∏–º —Å—Ç—Ä–æ—á–∫–∏, –Ω–µ –≤—ã–Ω–æ—Å–∏–º –≤ –æ–±—â–∏–π renderCart, –Ω–µ –¥–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫–µ!‚Äù –Ω–µ –º–µ–Ω—è–µ–º –∏ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç! 
  –≠—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–µ, –∏–¥—É—Ç –ª–æ–≥–∏—á–Ω–æ –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º. –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–∫, –µ—Å–ª–∏ —á—Ç–æ –æ–±—Å—É–∂–¥–∞–µ–º!
*/
/*
‚ùóÔ∏è –ü–∞–º—è—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã:
–∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ firebase setup.JS
*/

window.toggleMenu = function () {
  // –ü–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é ‚Äî —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");

  if (window.currentUser) {
    loginBtn?.classList.add("hidden");
    logoutBtn?.classList.remove("hidden");
  } else {
    loginBtn?.classList.remove("hidden");
    logoutBtn?.classList.add("hidden");
  }

  // –ü–æ—Ç–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–º–æ –º–µ–Ω—é
  const menu = document.getElementById("menu");
  if (menu) menu.classList.toggle("hidden");
};
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é!
// –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∞–º–∏ "Anmelden"/"Abmelden" —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ toggleMenu,
// –∏–Ω–∞—á–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≤ DOM (menu –µ—â–µ —Å–∫—Ä—ã—Ç–æ).


  // ========================
  // üîí JS 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  // ========================
  window.login = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const remember = document.getElementById("rememberMe").checked;
  const persistence = remember ? window.browserSessionPersistence : window.inMemoryPersistence;

  try {
    await window.setPersistence(window.auth, persistence);
    const result = await window.signInWithEmailAndPassword(window.auth, email, password);
    document.getElementById("authStatus").textContent = `‚úÖ Eingeloggt als ${result.user.email}`;


    // ‚¨áÔ∏è –ß–∏—Å—Ç–∏–º –ø–æ–ª—è
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";


  } catch (err) {
    document.getElementById("authStatus").textContent = `‚ùå Fehler: ${err.message}`;
  }
};

window.logout = async function () {
  try {
    await window.signOut(window.auth);
    console.info("üö™ Benutzer wurde abgemeldet.");
    document.getElementById("authStatus").textContent = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";

    const menu = document.getElementById("menu");
    if (menu) menu.classList.add("hidden");
  } catch (err) {
    console.error("Fehler beim Logout:", err);
  }
};

// –∫–æ–Ω—Å–æ–ª—å –∫ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ —è–≤–Ω–æ —á—Ç–æ —Ç–æ –µ—â–µ 
window.restoreCartFromFirestore = async function(userId) {
  console.warn("=== –í–•–û–î –≤ restoreCartFromFirestore, userId:", userId);
  // –≤–æ—Ç —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì
 
  console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  const userCartRef = window.doc(window.db, "user_cart", userId);
  const cartSnap = await window.getDoc(userCartRef);

  if (cartSnap.exists()) {
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ –∏–∑ Firestore:', cartSnap.data());
    window.appState.selectedItems = cartSnap.data().items || [];
    // === –í–û–¢ –°–Æ–î–ê –í–°–¢–ê–í–¨ –ö–û–ù–°–û–õ–¨! ===
    console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  } else {
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ –∏–∑ Firestore: –ø—É—Å—Ç–æ');
    window.appState.selectedItems = [];
    // –ò —Å—é–¥–∞ —Ç–æ–∂–µ –¥–ª—è –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã:
    console.log('selectedItems –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', window.appState.selectedItems);
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};

// –£–¥–∞–ª—è–µ—Ç –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –≤—Å–µ –ø–æ–ª—è —Å –ø—É—Å—Ç—ã–º –∫–ª—é—á–æ–º
function cleanItem(item) {
  return Object.fromEntries(
    Object.entries(item).filter(([key]) => key && key.trim() !== "")
  );
}


window.saveReservedCartToFirestore = async function(userId) {
  const reservedItems = window.appState.selectedItems
    .filter(item => item.status === 'reserved')
    .map(cleanItem); // <--- –≤–æ—Ç —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!

  const userCartRef = window.doc(window.db, "user_cart", userId);
  console.log('‚Üí reservedItems:', reservedItems);
reservedItems.forEach((item, idx) => {
  console.log('item', idx, item);
});
  await window.setDoc(userCartRef, {
    items: reservedItems
  });
};

// –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–µ–∂–¥—É —Ñ–æ—Ä–º–æ–π –≤—Ö–æ–¥–∞ –∏ —Ñ–æ—Ä–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
window.toggleAuthForm = function () {
  // üö¶ –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —é–∑–µ—Ä –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –∑–∞–ø—Ä–µ—â–∞–µ–º –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ª—é–±—ã–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!
  if (window.currentUser) {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, "–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã".
    return;
  }
  const authBlock = document.getElementById('authBlock');
  const registerBlock = document.getElementById('registerBlock');
  if (!authBlock || !registerBlock) return;

  authBlock.classList.toggle('hidden');
  registerBlock.classList.toggle('hidden');
  // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ç—É—Å—ã –æ—à–∏–±–æ–∫/—É—Å–ø–µ—Ö–∞
  const authStatus = document.getElementById('authStatus');
  const registerStatus = document.getElementById('registerStatus');
  if (authStatus) authStatus.textContent = "";
  if (registerStatus) registerStatus.textContent = "";
};

// üåü –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Firebase Auth
window.doRegister = async function () {
  const email = document.getElementById("reg_email").value.trim();
  const password = document.getElementById("reg_password").value.trim();
  const code = document.getElementById("reg_code").value.trim();

  const FIRMA_CODE = decodeBase64(FC64);
  if (code !== FIRMA_CODE) {
    document.getElementById("registerStatus").textContent = "‚ùå Ung√ºltiger Firmen-Code!";
    return;
  }

  if (!email || !password) {
    document.getElementById("registerStatus").textContent = "‚ùå Email und Passwort erforderlich";
    return;
  }
  try {
    const result = await window.createUserWithEmailAndPassword(window.auth, email, password);
    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –≤—ã–¥–∞—ë–º –ø—Ä–∞–≤–∞ –≤ user_meta
    const userMetaRef = window.doc(window.db, "user_meta", result.user.uid);
    await window.setDoc(userMetaRef, { allowed: true });
    document.getElementById("registerStatus").textContent = "‚úÖ Registrierung erfolgreich! Bitte einloggen.";
    // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
    document.getElementById("reg_email").value = "";
    document.getElementById("reg_password").value = "";
    document.getElementById("reg_code").value = "";
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞)
    window.toggleAuthForm();

  } catch (err) {
    document.getElementById("registerStatus").textContent = "‚ùå Fehler: " + err.message;
  }
};


// ========================
// üßæ JS 1.1 –ü–æ–≤–µ–¥–µ–Ω–∏–µ Enter –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞
// ========================
document.addEventListener("keydown", function (e) {
  const authBlock = document.getElementById("authBlock");
  const isVisible = authBlock && !authBlock.classList.contains("hidden");

  if (!isVisible) return;

  const activeElement = document.activeElement;

  if (e.key === "Enter") {
    if (activeElement.id === "email") {
      e.preventDefault();
      document.getElementById("password")?.focus();
    } else if (activeElement.id === "password") {
      e.preventDefault();
      window.login();
    }
  }
});
    
    // ============================
    // üé≤ JS 1.5 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤
    // ============================
    // TODO: generateOrder(), openSettingsPanel(), applyRandomOrder()

    // ========================
    // üîç JS 2. –ü–æ–∏—Å–∫ + QR
    // ========================
    // TODO: handleSearchInput(), openQRScanner(), onQRScanResult()
    window.openQRScanner = function () {
    console.warn("üì∑ QR-Scanner –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω");
    };
    const searchInput = document.getElementById("searchInput");
    //–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–ª–∫–∞ –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
    if (searchInput) {
        searchInput.addEventListener("click", function () {
            setTimeout(() => {
            // –°–∫—Ä–æ–ª–ª–∏–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –±—ã–ª–∞ ~32px –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
            const rect = searchInput.getBoundingClientRect();
            const absoluteY = window.scrollY + rect.top;
            window.scrollTo({
                top: absoluteY - 32, // 32px ‚Äî –∂–µ–ª–∞–µ–º—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
                behavior: "smooth"
            });
            }, 50);
        });
        }


    const suggestionsBox = document.getElementById("suggestions");
    const suggestionsList = document.getElementById("suggestionsList");

    searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase().replace(/\//g, "").trim();
  if (!query || !window.appState.artikelListe) {
    suggestionsBox.classList.add("hidden");
    return;
  }

  const matches = window.appState.artikelListe.filter(row => {
  if (!row.Artikelnummer || !row.Artikelbezeichnung || !row.Ort) return false;

  const ort = String(row.Ort).toLowerCase().replace(/\//g, '');
  const nummer = String(row.Artikelnummer).toLowerCase();
  const name = String(row.Artikelbezeichnung).toLowerCase();
  return ort.includes(query) || nummer.includes(query) || name.includes(query);
});


  if (matches.length === 0) {
    suggestionsList.innerHTML = `<li class="px-4 py-2 text-gray-500 italic">Keine Ergebnisse</li>`;
  } else {
    suggestionsList.innerHTML = matches.map(row => `
      <li class="flex justify-between items-center px-4 py-2 hover:bg-gray-100 cursor-pointer">
        <span>${row.Ort} ‚Äî ${row.Artikelnummer} ‚Äî ${row.Artikelbezeichnung}</span>
        <button onclick="window.openMengeModal(${JSON.stringify(row).replace(/"/g, '&quot;')})" class="text-green-600 text-xl ml-2">‚ûï</button>
      </li>
    `).join("");
  }

  suggestionsBox.classList.remove("hidden");

  document.addEventListener("click", (e) => {
  const inside = searchInput.contains(e.target) || suggestionsBox.contains(e.target);
  if (!inside && !window.appState.modalOpen) {
    suggestionsBox.classList.add("hidden");
    searchInput.value = "";
  }
});

});
    // ========================
    // üìã JS 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    // ========================
    // TODO: renderSearchResults()

    // ========================
    // üõí JS 4. –ö–æ—Ä–∑–∏–Ω–∞
    // ========================

    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–æ–≤–∞—Ä–∞ (–¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã)
    function getStatusIcon(status) {
  if (status === 'reserved') return 'üü¢'; // –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω
  if (status === 'unavailable') return '‚ö™Ô∏è'; // –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
  return 'üü°'; // —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω (unverified)
    }
    // —Å—Ç–∞—Ç—É—Å–Ω—ã–π —Ñ–æ–Ω –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ç—É—Å–∞. –Ω–æ–≤—ã–π, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π, –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ
    function getBgClassByStatus(status) {
  if (status === 'reserved') return 'bg-green-100';       // –Ω–µ–∂–Ω–æ-–∑–µ–ª—ë–Ω—ã–π
  if (status === 'unavailable') return 'bg-yellow-100';   // –º—è–≥–∫–∏–π –∂—ë–ª—Ç—ã–π
  return 'bg-gray-100';                                   // –æ–±—ã—á–Ω—ã–π —Å–µ—Ä—ã–π (–Ω–æ–≤—ã–π)
    }
    //============================
    //—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
     //============================
     window.addItemToCart = async function () {
  const mengeInput = document.getElementById("mengeInput");
  const menge = parseInt(mengeInput?.value, 10);
  const item = window.appState.selectedItem;

  if (!item || isNaN(menge) || menge < 1) {
    console.warn("‚ùå Ung√ºltige Eingabe oder kein Artikel ausgew√§hlt.");
    return;
  }

  // üß† –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "reserved" –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É –Ω–µ—Ç/–¥–∞
  const existingReservedItem = window.appState.selectedItems.find(
  (el) => el.Artikelnummer === item.Artikelnummer && el.status === "reserved"
);

if (existingReservedItem) {
  // === –ú–û–î–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–†–ò –î–û–ë–ê–í–õ–ï–ù–ò–ò –£–ñ–ï –ó–ê–†–ï–ó–ï–†–í–ò–†–û–í–ê–ù–ù–û–ì–û –¢–û–í–ê–†–ê ===
  window.appState.pendingAddItem = {
    artikel: item,
    menge: menge,
    oldMenge: existingReservedItem.Menge
  };
  window.showAddReservedConfirm();
  return;
}

  // üÜï –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –±—ã–ª–æ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—ã–π
  const existing = window.appState.selectedItems.find(
    (i) => i.Artikelnummer === item.Artikelnummer
  );

  if (existing) {
    existing.Menge += menge;
    existing.status = 'unverified'; // <--- —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  } else {
    window.appState.selectedItems.push({
      ...item,
      Menge: menge,
      status: 'unverified' // <--- –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –≤—Å–µ–≥–¥–∞ unverified
    });
  }

  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};


window.renderCart = function () {
  const cart = document.getElementById("cartItems");
  const items = window.appState.selectedItems;

  if (!cart) return;

  if (items.length === 0) {
    cart.innerHTML = `<p class="text-gray-500 italic">Noch keine Artikel</p>`;
    window.updateBoxInfo();
    return;
  }

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –Ω–µ reserved, –ø–æ—Ç–æ–º reserved
  const sortedItems = [...items].sort((a, b) => {
    if (a.status === 'reserved' && b.status !== 'reserved') return 1;
    if (a.status !== 'reserved' && b.status === 'reserved') return -1;
    return 0;
  });


  // üß™ –í—Å—Ç–∞–≤–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤:
  items.forEach((item, i) => {
    if (!String(item.Artikelnummer || "").trim()) {
      console.warn(`‚ùó –ù–µ—Ç –∞—Ä—Ç–∏–∫—É–ª–∞ —É –ø–æ–∑–∏—Ü–∏–∏ ${i}:`, item);
    } else {
      console.log(`‚úÖ –ê—Ä—Ç–∏–∫—É–ª ${i}:`, item.Artikelnummer);
    }
    
  });


// üõí window.checkAndReserveAll
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –≤ –∫–æ—Ä–∑–∏–Ω–µ –∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–º —Å—Ç–∞—Ç—É—Å:
// reserved ‚Äî —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ, unavailable ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç


//=============================================================================================
// üü¢ –ü–æ—Å–ª–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (lager) –¥–ª—è –≤—Å–µ—Ö reserved
//=============================================================================================
window.checkAndReserveAll = async function () {
// === –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É "Pr√ºfen & reservieren" –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ===
const actionBlock = document.getElementById("actionButtonsBlock");
    if (actionBlock) {
    // –ù–∞—Ö–æ–¥–∏–º –∏–º–µ–Ω–Ω–æ –∫–Ω–æ–ø–∫—É "Pr√ºfen & reservieren" –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É (–∏–ª–∏ –ø–æ –∫–ª–∞—Å—Å—É –µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ!)
    const reserveBtn = Array.from(actionBlock.getElementsByTagName('button')).find(
        btn => btn.textContent.includes("Pr√ºfen") || btn.textContent.includes("reservieren")
     );
    if (reserveBtn) {
        reserveBtn.disabled = true;
        reserveBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        reserveBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        reserveBtn.innerHTML = `<span class="animate-pulse mr-1">‚è≥</span>Bitte warten...`;
       }
    }

    //–°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Artikelnummer –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è batch-–∑–∞–ø—Ä–æ—Å–∞ –∫ Firestore
    const artikelNummern = window.appState.selectedItems.map(item => String(item.Artikelnummer));

    // –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Firestore –ø–æ —Å–ø–∏—Å–∫—É –∞—Ä—Ç–∏–∫—É–ª–æ–≤
    // –ó–∞–ø—Ä–æ—Å –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'lager' –ø–æ —Å–ø–∏—Å–∫—É –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (where in ...)
    // (–í –æ–¥–Ω—É –ø–∞—Ä—Ç–∏—é Firestore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ 10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ in-–∑–∞–ø—Ä–æ—Å–µ, —Ç–∞–∫ —á—Ç–æ –¥–µ–ª–∏–º –Ω–∞ —á–∞–Ω–∫–∏ –µ—Å–ª–∏ —á—Ç–æ)

    const db = window.db;
    const CHUNK_SIZE = 10;
    const artikelChunks = [];
    for (let i = 0; i < artikelNummern.length; i += CHUNK_SIZE) {
    artikelChunks.push(artikelNummern.slice(i, i + CHUNK_SIZE));
    }

    let firestoreItems = [];
    for (const chunk of artikelChunks) {
    const q = window.query(
        window.collection(db, "lager"),
        window.where("Artikelnummer", "in", chunk)
    );
    const querySnapshot = await window.getDocs(q);
    querySnapshot.forEach((doc) => {
        firestoreItems.push({ id: doc.id, ...doc.data() });
    });
    }

    // üü¢ –ú–ò–ö–†–û–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ Firestore
    window.appState.selectedItems.forEach(cartItem => {
    // –ò—â–µ–º stockItem –≤ Firestore –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
    const stockItem = firestoreItems.find(
        a => String(a.Artikelnummer) === String(cartItem.Artikelnummer)
    );
    cartItem.stock = stockItem ? Number(stockItem.Menge) : 0;

    if (stockItem) {
        // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç Reserviert
        const reserviertObj = stockItem.Reserviert && typeof stockItem.Reserviert === "object"
        ? { ...stockItem.Reserviert }
        : {};
        const uid = window.currentUser?.uid || "testuid";
        const oldReserve = Number(reserviertObj[uid]) || 0;
        // –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è: –æ—Å—Ç–∞—Ç–æ–∫ + —Å–≤–æ—è –±—Ä–æ–Ω—å
        const available = Number(stockItem.Menge) + oldReserve;
        if (available >= cartItem.Menge) {
        cartItem.status = 'reserved';
        } else {
        cartItem.status = 'unavailable';
        }
    } else {
        cartItem.status = 'unavailable';
    }
    });



  // === –ù–æ–≤—ã–π –±–ª–æ–∫: –æ–±–Ω–æ–≤–ª—è–µ–º Firestore –¥–ª—è –≤—Å–µ—Ö reserved ===
  for (const item of window.appState.selectedItems) {
  if (item.status === 'reserved') {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();

      // 1. –¢–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç Reserviert –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};

      // 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const uid = window.currentUser?.uid || "testuid";
      const oldReserve = Number(reserviertObj[uid]) || 0;
      const newReserve = Number(item.Menge);
      const diff = newReserve - oldReserve;

      // 3. –í—ã—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ diff!
      const neueMenge = (Number(artikelData.Menge) || 0) - diff;

      // 4. –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤
      if (newReserve > 0) {
        reserviertObj[uid] = newReserve;
      } else {
        delete reserviertObj[uid];
      }

      // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç Reserviert –∏ Menge
      await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMenge,
        Reserviert: reserviertObj,
      });
      }
    }
  }

  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ user_cart
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }
}; // ‚Üê‚Üê‚Üê –≤–æ—Ç –∑–¥–µ—Å—å –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏, –≤—Å–µ–≥–æ –æ–¥–Ω–∞ —Å–∫–æ–±–∫–∞!

//==========================================
//–¥–æ–ø—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è —Å —Ç–æ–≤–∞—Ä–æ–≤ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
//==========================================
window.showUnreserveAllConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Reservierungen aufheben?</h2>
        <div class="text-lg text-gray-800 mb-4">
          Wirklich <b>alle Reservierungen</b> im Warenkorb entfernen und Waren zur√ºck auf Lager geben?
        </div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmUnreserveAll()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};
//==========================================
//–µ—â–µ –æ–¥–Ω–∞ –¥–æ–ø —Ñ—É–Ω–∫—Ü–∏—è
//==========================================
window.confirmUnreserveAll = async function () {
  // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;

  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–≤–æ—é –¥–ª–∏–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é!
  await window.unreserveAll();
};


// üö´ –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ –≤–µ—Ä–Ω—É—Ç—å –∏—Ö –Ω–∞ —Å–∫–ª–∞–¥ –≤ –±–∞–∑–µ
window.unreserveAll = async function () {
  // 1. –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ reserved –¥–æ —Å–±—Ä–æ—Å–∞
  const reservedItems = window.appState.selectedItems.filter(item => item.status === 'reserved');

  // 2. –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ç—É—Å –ª–æ–∫–∞–ª—å–Ω–æ
  window.appState.selectedItems.forEach(cartItem => {
    cartItem.status = 'unverified';
  });

  // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∫–Ω–æ–ø–∫–∏
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. –û—á–∏—â–∞–µ–º user_cart (—Ä–µ–∑–µ—Ä–≤—ã)
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ reserved —Ç–æ–≤–∞—Ä–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º Menge –∏ –æ–±–Ω—É–ª—è–µ–º Reserviert –Ω–∞ —Å–∫–ª–∞–¥–µ
  for (const item of reservedItems) {
    const artikelRef = window.doc(window.db, "lager", String(item.Artikelnummer));
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const artikelSnap = await window.getDoc(artikelRef);
    if (artikelSnap.exists()) {
      const artikelData = artikelSnap.data();
      const neueMenge = (Number(artikelData.Menge) || 0) + Number(item.Menge);
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Menge –∏ Reserviert
      const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
        ? { ...artikelData.Reserviert }
        : {};
        const uid = window.currentUser?.uid || "testuid";
        // –£–º–µ–Ω—å—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –±—Ä–æ–Ω—å
        const altMenge = Number(reserviertObj[uid]) || 0;
        const neueMengeFinal = (Number(artikelData.Menge) || 0) + altMenge;
        delete reserviertObj[uid]; // –°–Ω–∏–º–∞–µ–º –±—Ä–æ–Ω—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è

        await window.setDoc(artikelRef, {
        ...artikelData,
        Menge: neueMengeFinal,
        Reserviert: reserviertObj,
        });
    }
  }
};


// üõí window.unreserveItem
// üö´ –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ —Å–∫–ª–∞–¥
window.unreserveItem = async function (artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item || item.status !== 'reserved') return;

  // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞
  const menge = item.Menge;

  // 2. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ unverified
  item.status = 'unverified';

  // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∫–Ω–æ–ø–∫–∏
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);

  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ reserved –≤ Firestore
  if (window.currentUser) {
    await window.saveReservedCartToFirestore(window.currentUser.uid);
  }

  // 5. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (lager)
  const artikelRef = window.doc(window.db, "lager", String(artikelnummer));
  const artikelSnap = await window.getDoc(artikelRef);
  if (artikelSnap.exists()) {
    const artikelData = artikelSnap.data();
    const reserviertObj = artikelData.Reserviert && typeof artikelData.Reserviert === "object"
      ? { ...artikelData.Reserviert }
      : {};
    const uid = window.currentUser?.uid || "testuid";
    // –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    const altMenge = Number(reserviertObj[uid]) || 0;
    const neueMenge = (Number(artikelData.Menge) || 0) + altMenge;
    // –£–¥–∞–ª—è–µ–º —Å–≤–æ–π —Ä–µ–∑–µ—Ä–≤
    delete reserviertObj[uid];

    await window.setDoc(artikelRef, {
      ...artikelData,
      Menge: neueMenge,
      Reserviert: reserviertObj,
    });
  }
};

// —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–ª–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
window.unreserveItemByArtikelnummer = async function (artikelnummer) {
  const index = window.appState.selectedItems.findIndex(
    (el) => el.Artikelnummer === artikelnummer && el.status === "reserved"
  );
  if (index !== -1) {
    await window.unreserveItem(index);
  }
};


// –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã, –∫—Ä–æ–º–µ —Ç–µ—Ö, —É –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç–∞—Ç—É—Å 'reserved'
window.clearUnavailable = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Nicht reservierte Artikel entfernen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle nicht reservierten Artikel</b> aus dem Warenkorb l√∂schen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmClearUnavailable()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ (—Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–∑–∂–µ)
window.sendOrder = function () {
  alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! (–∑–∞–≥–ª—É—à–∫–∞)');
  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Firestore
  // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏–ª–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤—Å–µ –≤ —Å—Ç–∞—Ç—É—Å "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
};

//==========================
//  –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
//==========================
cart.innerHTML = sortedItems
  .map(
    (item, i) => `
  <div class="${getBgClassByStatus(item.status)} rounded-xl px-4 py-2 mb-2 flex justify-between items-start gap-2">
  
    <div class="grid grid-cols-[56px_16px_1fr] gap-y-1">
      <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
      <div class="text-sm text-gray-500 col-start-1 row-start-1">${item.Ort}</div>
      <div class="col-start-2 row-start-1 w-4 h-px"></div>
      <div class="text-sm text-gray-500 col-start-3 row-start-1">
        ${String(item.Artikelnummer || '').trim().match(/^\d/) ? window.formatArtikelnummer(item.Artikelnummer) : '‚Äî'}
      </div>
      <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ -->
      <div class="col-start-1 row-start-2 flex justify-center items-center">
        <span class="inline-block align-middle text-sm" style="line-height: 1;">${getStatusIcon(item.status)}</span>
      </div>
      <div class="col-start-2 row-start-2 w-4 h-px"></div>
      <div class="col-start-3 row-start-2 flex items-center gap-2">
        <span class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</span>
      </div>
    </div>

    <div class="flex flex-col items-end text-right">
        <div class="font-semibold text-base flex items-center gap-2 justify-end">
             ${item.status === 'unavailable'
            ? `<span class="text-base text-red-600">Auf Lager: ${item.stock ?? 0}</span>`
            : ''
            }
            <span class="ml-2">√ó ${item.Menge}</span>
        </div>
        
            <div class="flex gap-1 mt-1">
             ${
                 item.status === 'reserved'
             ? `<button onclick="window.unreserveItem('${item.Artikelnummer}')" title="Reservierung aufheben" class="text-yellow-600 text-lg">üö´</button>`
             : `
             <button onclick="window.editItem('${item.Artikelnummer}')" title="Bearbeiten" class="text-blue-600 text-lg">‚úèÔ∏è</button>
             <button onclick="window.showDeleteConfirm('${item.Artikelnummer}')" title="L√∂schen" class="text-red-600 text-lg">üóëÔ∏è</button>
             `
             }
            </div>
      
    </div>
  </div>
  `
  )
  .join("");
  window.updateBoxInfo();
};

//—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
window.editItem = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –Ω–æ –≤ –ø–æ–ª–µ value –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ Menge
  const modal = document.getElementById("mengeModal");
  if (!modal) return;

  window.appState.modalOpen = true;
  window.appState.selectedItem = item;

  modal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2">
      <h2 class="text-xl font-bold">Menge bearbeiten</h2>
      <div class="text-left px-2">
        <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
        <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
      </div>
      <input id="mengeInput" type="number" min="1" value="${item.Menge}"
             class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
      <div class="flex justify-between pt-2 px-2 gap-2">
        <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
        <button onclick="window.saveEditedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
      </div>
    </div>
  `;

  modal.classList.remove("hidden");

  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
};


window.hideDeleteConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.confirmDeleteArtikelnummer = null;
};

window.confirmDeleteItem = function () {
  const artikelnummer = window.appState.confirmDeleteArtikelnummer;
  if (!artikelnummer) return;
  const index = window.appState.selectedItems.findIndex(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (index !== -1) {
    window.appState.selectedItems.splice(index, 1);
  }
  window.hideDeleteConfirm();
  window.updateCartButtons(window.appState.selectedItems);
  window.renderCart();
  window.appState.confirmDeleteArtikelnummer = null;
};
//================================
// —É–¥–∞–ª—è–ª–∫–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ç–æ–≤–∞—Ä–∞
//================================
window.showDeleteConfirm = function(artikelnummer) {
  const item = window.appState.selectedItems.find(
    x => String(x.Artikelnummer) === String(artikelnummer)
  );
  if (!item) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º Artikelnummer –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  window.appState.confirmDeleteArtikelnummer = item.Artikelnummer;

  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Artikel l√∂schen?</h2>
        <div class="text-lg text-gray-800 mb-4">"${item.Artikelbezeichnung}" wirklich entfernen?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideDeleteConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmDeleteItem()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

window.saveEditedItem = function () {
  const input = document.getElementById("mengeInput");
  if (!input) return;

  const neueMenge = parseInt(input.value, 10);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  if (!Number.isInteger(neueMenge) || neueMenge < 1) {
    input.classList.add("border-red-400");
    input.focus();
    return;
  }

  // üü¢ –ú–µ–Ω—è–µ–º Menge —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞!
  if (window.appState.selectedItem) {
    window.appState.selectedItem.Menge = neueMenge;
  }

  // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  window.appState.selectedItem = null;
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
};
//=============================================================================
//  —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –∫—Ä–∞—Å–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
//=============================================================================
window.confirmClearUnavailable = function () {
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
  window.appState.selectedItems = (window.appState.selectedItems || []).filter(item => item.status === "reserved");
  window.renderCart();

  // –ü—Ä—è—á–µ–º –º–æ–¥–∞–ª–∫—É –∏ —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥
  const modal = document.getElementById("confirmationModals");
  if (modal) modal.classList.add("hidden");
  window.appState.modalOpen = false;
};


    // ========================
    // üì¶ JS 5. –ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –∫–æ—Ä–æ–±–∫–∏
    // ========================

  // ==================================================== 
  // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –æ–±—ä—ë–º–∞ –∏ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–æ–±–∫–∏
  // ==================================================== 
  // –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: —Å—á–∏—Ç–∞–µ—Ç –∑–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è gross –∏ mittel
window.calculateBoxVolumes = function () {
  // –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ—Ä–æ–±–æ–∫ (–º–æ–∂–µ—à—å –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
  const boxSizes = {
    mittel: { name: "Mittel Box", maxVolumen: 10260 },
    gross: { name: "Gro√üe Box", maxVolumen: 31635 }
  };

  const items = window.appState.selectedItems || [];

  // –û–±—â–∏–π –æ–±—ä—ë–º —Ç–æ–≤–∞—Ä–æ–≤
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    if (!v) {
      const l = Number(item.L√§nge || item.L√§nge_cm || item.L);
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.H√∂he || item.H√∂he_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞
  if (missingVolumen.length > 0) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä—ë–º —É " + missingVolumen.length + " –ø–æ–∑–∏—Ü–∏–π! –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
    console.warn("–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞:", missingVolumen);
  }

  // 95% –æ–±—ä—ë–º–∞ ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
  const mittelMax = boxSizes.mittel.maxVolumen * 0.95;
  const grossMax = boxSizes.gross.maxVolumen * 0.95;

  // –°—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
  const mittelPercent = mittelMax ? Math.round((totalVol / mittelMax) * 100) : 0;
  const grossPercent = grossMax ? Math.round((totalVol / grossMax) * 100) : 0;

  return {
    mittel: {
      boxName: boxSizes.mittel.name,
      percent: Math.min(mittelPercent, 100),
      totalVol,
      maxVolumeForBox: mittelMax
    },
    gross: {
      boxName: boxSizes.gross.name,
      percent: Math.min(grossPercent, 100),
      totalVol,
      maxVolumeForBox: grossMax
    }
  };
};
  
/*
  window.calculateCurrentBoxVolume = function () {
  // 1. –ö–æ—Ä–æ–±–∫–∏ –∏ –∏—Ö –æ–±—ä—ë–º—ã
  const boxSizes = {
    klein: { name: "Kleine Box", maxVolumen: 1728 },
    mittel: { name: "Mittel Box", maxVolumen: 9720 },
    gross: { name: "Gro√üe Box", maxVolumen: 29970 }
  };

  // 2. –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  const items = window.appState.selectedItems || [];

  // 3. –°—É–º–º–∏—Ä—É–µ–º –æ–±—â–∏–π –æ–±—ä—ë–º –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ (volumen * menge)
  let totalVol = 0;
  let missingVolumen = [];
  for (const item of items) {
    let v = Number(item.Volumen);
    // –ï—Å–ª–∏ Volumen –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ—Å—á–∏—Ç–∞—Ç—å
    if (!v) {
      const l = Number(item.L√§nge || item.L√§nge_cm || item.L); // –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—è
      const b = Number(item.Breite || item.Breite_cm || item.B);
      const h = Number(item.H√∂he || item.H√∂he_cm || item.H);
      if (l && b && h) {
        v = l * b * h;
      } else {
        missingVolumen.push(item);
        continue;
      }
    }
    totalVol += v * Number(item.Menge || 1);
  }

  // 4. –ï—Å–ª–∏ –Ω–µ —É –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å—Ç—å Volumen ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert (–æ–¥–∏–Ω —Ä–∞–∑)
  if (missingVolumen.length > 0) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä—ë–º —É " + missingVolumen.length + " –ø–æ–∑–∏—Ü–∏–π! –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
    console.warn("–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ–±—ä—ë–º–∞:", missingVolumen);
  }

  // 5. –î–ª—è —Ä–∞—Å—á—ë—Ç–∞: —Ç–æ–ª—å–∫–æ 95% –æ–±—ä—ë–º–∞ –∫–æ—Ä–æ–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥ —Ç–æ–≤–∞—Ä—ã
  function fitBoxKey(vol) {
    if (vol <= boxSizes.mittel.maxVolumen * 0.95) return "mittel";
    if (vol <= boxSizes.gross.maxVolumen * 0.95) return "gross";
    return "gross"; // –±–æ–ª—å—à–µ gross ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ gross
  }

  // 6. –í—ã–±–æ—Ä –∫–æ—Ä–æ–±–∫–∏
  let boxKey = fitBoxKey(totalVol);

  // 7. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è mittel ‚Üî gross (–≥—Ä–∞–Ω–∏—Ü—ã)
  if (boxKey === "gross" && totalVol <= boxSizes.mittel.maxVolumen * 0.85) {
    boxKey = "mittel";
  }

  // 8. % –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
  const maxVolumeForBox = boxSizes[boxKey].maxVolumen * 0.95;
  const percent = maxVolumeForBox === 0 ? 0 : Math.round((totalVol / maxVolumeForBox) * 100);

  // 9. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç
  return {
    boxKey,
    boxName: boxSizes[boxKey].name,
    percent: Math.min(percent, 100),
    totalVol,
    maxVolumeForBox
  };
};
*/
//===================================================
// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å—é –∫–æ—Ä–æ–±–∫–∏
//===================================================
window.updateBoxInfo = function () {
  const volumeSection = document.getElementById("volumeInfoBlock");
  if (!volumeSection) return;

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–æ–º –ø–æ —Ñ–ª–∞–≥—É
  if (window.appState.showVolumeBlock === false) {
    volumeSection.classList.add("hidden");
    return;
  } else {
    volumeSection.classList.remove("hidden");
  }

  const infoBlock = document.getElementById("boxSummary");
  if (!infoBlock) return;

  const result = window.calculateBoxVolumes();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (gross –∏ mittel)
  infoBlock.innerHTML =
    `üì¶ ${result.gross.boxName} ‚Äì ${result.gross.percent}% voll<br>` +
    `<span style="color:#a3a3a3;">üì¶ ${result.mittel.boxName} ‚Äì ${result.mittel.percent}% voll</span>`;

  // --- "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Ä–∞—Å—á—ë—Ç —Ç–æ–∂–µ –≤—ã–≤–æ–¥–∏–º –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å ---
  const initialBox = document.getElementById("initialBoxInfo");
  if (!initialBox) return;

  const initial = window.appState.initialVolumeInfo;
  if (
    initial &&
    typeof initial.gross === "object" &&
    typeof initial.mittel === "object"
  ) {
    initialBox.innerHTML =
      `üì¶ ${initial.gross.boxName} ‚Äì ${initial.gross.percent}% geplant<br>` +
      `<span style="color:#bdbdbd;">üì¶ ${initial.mittel.boxName} ‚Äì ${initial.mittel.percent}% geplant</span>`;
  } else {
    initialBox.textContent = "";
  }
};



    // ========================
    // üöö JS 6. –î–µ–π—Å—Ç–≤–∏—è —Å –∫–æ—Ä–∑–∏–Ω–æ–π
    // ========================

    // TODO: reserveItems(), confirmShipment(), 

    // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã (—É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É)
window.clearCart = function () {
  window.appState.selectedItems = [];
  window.renderCart();
  window.hideClearCartConfirm();
  window.updateCartButtons(window.appState.selectedItems);
};

// –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥ –∫–æ—Ä–∑–∏–Ω–æ–π
window.updateCartButtons = function (cartItems) {
  const actionBlock = document.getElementById("actionButtonsBlock");
  if (!actionBlock) return;

  // === 1. –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
  const allUnverified = cartItems.length > 0 && cartItems.every(item => item.status === 'unverified');
  const allReserved = cartItems.length > 0 && cartItems.every(item => item.status === 'reserved');
  const anyReserved = cartItems.some(item => item.status === 'reserved');
  const anyUnreserved = cartItems.some(item => item.status !== 'reserved');
  const onlyUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const anyUnavailable = cartItems.some(item => item.status === 'unavailable');
  const allUnavailable = cartItems.length > 0 && cartItems.every(item => item.status === 'unavailable');
  const cartIsEmpty = cartItems.length === 0;
  
    // === 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
  // "Alle Reservierungen aufheben" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å reserved
  const unreserveActive = anyReserved;
  // "Nicht reservierte Artikel entfernen" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ-reserved –∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω reserved
  const clearUnreservedActive = anyReserved && anyUnreserved;
  // "Warenkorb leeren" ‚Äî –∞–∫—Ç–∏–≤–Ω–∞ –≤—Å–µ–≥–¥–∞, –∫—Ä–æ–º–µ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã
  const clearCartActive = !cartIsEmpty;
  // "Bestellung abschicken" ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ reserved
  const sendOrderActive = allReserved && !cartIsEmpty;
  // "Pr√ºfen & reservieren" ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ-reserved
  const checkActive = anyUnreserved;



  // === 3. –ö–Ω–æ–ø–∫–∏ ‚Äî –ø–µ—Ä–≤—ã–π —Ä—è–¥
  let row1 = `
  <button class="flex-1 bg-gray-200 text-black py-2 rounded-xl hover:bg-gray-300"
    onclick="window.addMoreItems()">‚ûï Automatisch auff√ºllen</button>
  <button class="flex-1 ${anyUnreserved ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
    ${anyUnreserved ? 'onclick="window.clearUnavailable()"' : 'disabled'}>üóëÔ∏è Unreservierte Artikel entfernen</button>
`;

  // === 4. –ö–Ω–æ–ø–∫–∏ ‚Äî –≤—Ç–æ—Ä–æ–π —Ä—è–¥
  let row2 = "";

if (cartIsEmpty) {
  // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞: —Å–ª–µ–≤–∞ "Pr√ºfen & reservieren", —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å (–æ–±–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã)
  row2 = `
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      ‚úîÔ∏è Pr√ºfen & reservieren
    </button>
    <button class="flex-1 bg-gray-200 text-gray-400 cursor-not-allowed py-2 rounded-xl" disabled>
      üö´ Alle Reservierungen aufheben
    </button>
  `;
} else if (allReserved) {
  // –í—Å—ë reserved: —Å–ª–µ–≤–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞, —Å–ø—Ä–∞–≤–∞ —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
  row2 = `
    <button class="flex-1 bg-blue-500 text-white hover:bg-blue-600 py-2 rounded-xl"
      onclick="window.sendOrder()">üì¶ Bestellung abschicken</button>
    <button class="flex-1 bg-yellow-500 text-white hover:bg-yellow-600 py-2 rounded-xl"
      onclick="window.showUnreserveAllConfirm()">üö´ Alle Reservierungen aufheben</button>
  `;
} else {
  // –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–ª—É—á–∞–∏: —Å–ª–µ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–ø—Ä–∞–≤–∞ ‚Äî —Ä–∞–∑—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
  row2 = `
    <button class="flex-1 bg-green-500 text-white hover:bg-green-600 py-2 rounded-xl"
      onclick="window.checkAndReserveAll()">‚úîÔ∏è Pr√ºfen & reservieren</button>
    <button class="flex-1 ${unreserveActive ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'} py-2 rounded-xl"
      ${unreserveActive ? 'onclick="window.showUnreserveAllConfirm()"' : 'disabled'}>üö´ Alle Reservierungen aufheben</button>
  `;
}

  // === 6. –ò—Ç–æ–≥–æ–≤–∞—è –≤—ë—Ä—Å—Ç–∫–∞
  actionBlock.innerHTML = `
    <div class="flex justify-between gap-2 mb-2">${row1}</div>
    <div class="flex justify-between gap-2">${row2}</div>
  `;
};

// –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ç–æ–≤–∞—Ä—ã  –≤ –ø–æ–∏—Å–∫–æ–≤–æ–º –º–µ–Ω—é
window.addMoreItems = function () {
  // –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ —Å–∫—Ä–æ–ª–ª–∏—Ç –∫ –ø–æ–∏—Å–∫—É, –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => searchInput.focus(), 400);
  }
};

    // ========================
    // ‚ûï JS 7. –ú–æ–¥–∞–ª–∫–∞ Menge
    // ========================
    window.openMengeModal = function (item) {
  const modal = document.getElementById("mengeModal");
  if (!modal) return;
  
  window.appState.selectedItem = item;

  modal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 w-80 space-y-4 shadow-lg text-center mx-2">
      <h2 class="text-xl font-bold">Artikel hinzuf√ºgen</h2>
      <div class="text-left px-2">
        <p class="text-sm text-gray-500">${item.Artikelnummer}</p>
        <p class="text-lg text-gray-800 font-semibold">${item.Artikelbezeichnung}</p>
      </div>
      <input id="mengeInput" type="number" min="1" value="1"
             class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400 text-center text-lg font-medium" />
      <div class="flex justify-between pt-2 px-2 gap-2">
        <button onclick="window.closeMengeModal()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
        <button onclick="window.addItemToCart()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
      </div>
    </div>
  `;

  modal.classList.remove("hidden");

  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);


  setTimeout(() => {
    const input = document.getElementById("mengeInput");
    const modal = document.getElementById("mengeModal");
    if (input && modal) {
      input.addEventListener("focus", () => {
        modal.classList.add("modal-bottom");
      });
      input.addEventListener("blur", () => {
        setTimeout(() => modal.classList.remove("modal-bottom"), 150);
      });
    }
  }, 120);
};
    window.closeMengeModal = function () {
    const modal = document.getElementById("mengeModal");
    if (modal) {
     modal.classList.add("hidden");
     modal.innerHTML = "";
     window.appState.modalOpen = false;
      window.appState.selectedItem = null;
      }
    };

    document.addEventListener("keydown", (e) => {
  const mengeModal = document.getElementById("mengeModal");
  const confirmModal = document.getElementById("confirmationModals");

  // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ Menge –æ—Ç–∫—Ä—ã—Ç–∞
  if (mengeModal && !mengeModal.classList.contains("hidden")) {
  if (e.key === "Escape") window.closeMengeModal();
  if (e.key === "Enter") {
    if (window.appState.selectedItem && window.appState.modalOpen) {
      window.saveEditedItem();
    } else {
      window.addItemToCart();
    }
  }
  return;
}
// –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ Menge ‚Äî –º–æ–¥–∞–ª–∫–∞ "–ø—Ä–∏–ª–∏–ø–∞–µ—Ç" –∫ –Ω–∏–∑—É.
const mengeInput = document.getElementById("mengeInput");


if (mengeInput && mengeModal) {
  mengeInput.addEventListener("focus", () => {
    mengeModal.classList.add("modal-bottom");
  });
  mengeInput.addEventListener("blur", () => {
    setTimeout(() => mengeModal.classList.remove("modal-bottom"), 150); // –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –∑–∞–∫—Ä—ã—Ç–∏—è
  });
}


  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  if (confirmModal && !confirmModal.classList.contains("hidden")) {
    if (e.key === "Escape") window.hideDeleteConfirm();
    if (e.key === "Enter") window.confirmDeleteItem();
  }
});
  
    // ========================
    // ‚ùóÔ∏è JS 8. –ú–æ–¥–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    // ========================
    // TODO: showConfirmation(type), handleConfirm()

// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã ("Alles l√∂schen")
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É üóëÔ∏è Alles l√∂schen
window.showClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-red-200">
        <h2 class="text-xl font-bold mb-3">Alle Artikel l√∂schen?</h2>
        <div class="text-lg text-gray-800 mb-4">Wirklich <b>alle Artikel aus der Liste entfernen</b>?</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideClearCartConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.clearCart()" class="flex-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

window.hideClearCartConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
};

//=====================================================================================
// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É  –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏ –Ω–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
//=====================================================================================
window.showAddReservedConfirm = function () {
  window.closeMengeModal();
  const modal = document.getElementById("confirmationModals");
  if (!modal) return;

  // –î–æ—Å—Ç–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ window.appState.pendingAddItem
  const { artikel, menge, oldMenge } = window.appState.pendingAddItem || {};

  // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  if (!artikel || !menge || !oldMenge) {
    window.hideAddReservedConfirm();
    return;
  }

  const artikelName = artikel.Artikelbezeichnung || "Artikel";
  const total = Number(menge) + Number(oldMenge);

  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-2xl p-6 w-80 shadow-xl text-center mx-2 border-2 border-blue-200">
        <div class="block text-center text-lg font-bold mb-2">${artikelName}</div>
        <div class="text-gray-700 mb-2">ist bereits im Warenkorb.</div>
        <div class="text-gray-800 mb-2">M√∂chten Sie noch <b>${menge} St√ºck</b> hinzuf√ºgen?<br/>
        Insgesamt wird es <b>${total} St√ºck</b> sein.</div>
        <div class="flex justify-between pt-2 gap-2">
          <button onclick="window.hideAddReservedConfirm()" class="flex-1 px-4 py-2 rounded-xl bg-gray-300 hover:bg-gray-400">Abbrechen</button>
          <button onclick="window.confirmAddReservedItem()" class="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">OK</button>
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
  window.appState.modalOpen = true;
};

// —Å–∫—Ä—ã–≤–∞–ª–∫–∞ —É—Ç–æ—á–Ω–∏—Ç—å
window.hideAddReservedConfirm = function () {
  const modal = document.getElementById("confirmationModals");
  if (modal) {
    modal.classList.add("hidden");
    modal.innerHTML = "";
  }
  window.appState.modalOpen = false;
  window.appState.pendingAddItem = null;
};

// –∫—É—Å–æ–∫ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–∑–µ—Ä–≤+–Ω–æ–≤—ã–π"–û–ö"
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ OK ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∑–µ—Ä–≤
window.confirmAddReservedItem = async function () {
  const data = window.appState.pendingAddItem;
  if (!data) {
    window.hideAddReservedConfirm();
    return;
  }
  // üü¢ Disable OK-–∫–Ω–æ–ø–∫—É + –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
  const modal = document.getElementById("confirmationModals");
    if (modal) {
      const okBtn = modal.querySelector('button.bg-green-500');
      if (okBtn) {
        okBtn.disabled = true;
        okBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
        okBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
        okBtn.innerHTML = `<span class="animate-pulse mr-1">‚è≥</span>Bitte warten...`;
      }
    }
  const { artikel, menge, oldMenge } = data;

  // 1. –ù–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π reserved-—ç–ª–µ–º–µ–Ω—Ç
  const existingReservedItem = window.appState.selectedItems.find(
    (el) => el.Artikelnummer === artikel.Artikelnummer && el.status === "reserved"
  );
  if (!existingReservedItem) {
    // –ù–µ—Ç —Ç–∞–∫–æ–≥–æ ‚Äî –∞–≤–∞—Ä–∏–π–Ω–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å
    window.hideAddReservedConfirm();
    return;
  }

  // 2. –°–Ω—è—Ç—å —Ä–µ–∑–µ—Ä–≤ —á–µ—Ä–µ–∑ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
  await window.unreserveItemByArtikelnummer(existingReservedItem.Artikelnummer);

  // 3. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  existingReservedItem.Menge = Number(oldMenge) + Number(menge);
  // 4. –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "new"
  existingReservedItem.status = "new";

  // 5. –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Å–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
  window.hideAddReservedConfirm();
  window.closeMengeModal();
  window.renderCart();
  window.updateCartButtons(window.appState.selectedItems);
    }

    // ========================
    // üí¨ JS 9. UI-—Å–æ–æ–±—â–µ–Ω–∏—è / –û—à–∏–±–∫–∏
    // –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –∑–∞—Ä–∞–Ω–µ–µ
    // ========================

    // ========================
    // üåê JS 10. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    // ========================

     // ========================
    // üåê JS 10.05 —É–º–Ω–π –ø–æ–∏—Å–∫ —Ä–∞–∑–±–∏–≤–∞–ª–∫–∞ –Ω–æ–º–µ—Ä–∞
    // ========================
    window.formatArtikelnummer = function (nummer) {
  const str = String(nummer).trim();
  const thinSpace = "\u2009";

  const prefixMatch = str.match(/^[A-Z]+/i); // –ü—Ä–µ—Ñ–∏–∫—Å –∏–∑ –±—É–∫–≤ –≤ –Ω–∞—á–∞–ª–µ
  const prefix = prefixMatch ? prefixMatch[0] + " " : "";

  const raw = str.replace(/\D/g, ""); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

  if (raw.length === 13) {
    return prefix + raw.replace(/(\d{3})(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3${thinSpace}$4`);
  }

  if (raw.length === 12) {
    return prefix + raw.replace(/(\d{4})(\d{4})(\d{4})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 10) {
    return prefix + raw.replace(/(\d{4})(\d{3})(\d{3})/, `$1${thinSpace}$2${thinSpace}$3`);
  }

  if (raw.length === 8) {
    return prefix + raw.replace(/(\d{4})(\d{4})/, `$1${thinSpace}$2`);
  }

  if (raw.length === 6) {
    return prefix + raw.replace(/(\d{3})(\d{3})/, `$1${thinSpace}$2`);
  }

  // fallback: –∫–∞–∂–¥—ã–µ 3‚Äì4 —Ü–∏—Ñ—Ä—ã
  return prefix + raw.replace(/(\d{3,4})(?=\d)/g, `$1${thinSpace}`);
};



    // ========================
    // üåê JS 10.1 –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã
    // ========================

    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzKtilIhFbMNl5zlQL5XsQHI7WPKnTNmgzh3xgniyPx49pJJ1OjwbfuViFm86y0zYQ/exec";

    fetch(GOOGLE_SHEET_URL)
  .then((res) => res.json())
  .then((data) => {
    window.appState.artikelListe = data;
    console.info("üì• Google Tabelle geladen:", data.length, "Eintr√§ge");
    window.isCatalogReady = true;        // –ø–æ–¥–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ "—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–æ—Ç–æ–≤"
    window.tryRestoreCart();             // –ø—Ä–æ–≤–µ—Ä—è–µ–º ‚Äî –º–æ–∂–Ω–æ –ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
  })
    .catch((err) => {
        console.error("‚ùå Fehler beim Laden der Google Tabelle:", err);
        const notification = document.getElementById("notificationArea");
    if (notification) {
        notification.textContent = "‚ùå Fehler beim Laden der Artikelliste";
        notification.classList.remove("hidden");
        setTimeout(() => notification.classList.add("hidden"), 4000);
    }
  });
 // window.renderCart(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
//–º–µ–Ω—è–ª–∫–∞ –≤–µ—Ä—Å–∏–∏
document.addEventListener("DOMContentLoaded", function() {
  // –ú–µ–Ω—è–µ–º <title>
  const pageTitle = document.getElementById("pageTitle");
  if (pageTitle) {
    pageTitle.textContent = `üì¶ LagerApp v${window.appVersion} Reset`;
  } else {
    document.title = `üì¶ LagerApp v${window.appVersion} Reset`;
  }

  // –ú–µ–Ω—è–µ–º h1
  const verElem = document.getElementById("ver");
  if (verElem) verElem.textContent = window.appVersion;
});



function waitForFirebaseAuth(cb) {
  if (window.onAuthStateChanged && window.auth) {
    cb();
  } else {
    setTimeout(() => waitForFirebaseAuth(cb), 30);
  }
}
// ====================================================== 
// === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ ===
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("toggleVolumeBlock");
  if (!toggle) return;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ –∏–∑ appState
  toggle.checked = window.appState.showVolumeBlock !== false;

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –≥–∞–ª–æ—á–∫–∏
  toggle.addEventListener("change", function () {
    window.appState.showVolumeBlock = toggle.checked;
    window.updateBoxInfo();
  });
});

// ======================================================
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
document.addEventListener("click", function (e) {
  const menu = document.getElementById("menu");
  const toggleBtn = document.querySelector("button[onclick*='toggleMenu']");
  if (
    menu &&
    !menu.classList.contains("hidden") &&
    !menu.contains(e.target) &&
    e.target !== toggleBtn
  ) {
    menu.classList.add("hidden");
  }
});


document.addEventListener("DOMContentLoaded", function() {
  waitForFirebaseAuth(function() {
    window.onAuthStateChanged(window.auth, function(user) {
      console.warn("üí• –í–•–û–î –≤ waitForFirebaseAuth CB!");

      console.log("user –≤ onAuthStateChanged:", user);
      window.isUserReady = !!user;
      console.log("isUserReady –ø–æ—Å–ª–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è:", window.isUserReady);

      window.currentUser = user || null;
      window.isUserReady = !!user;
      window.tryRestoreExecuted = false;
      window.tryRestoreCart();

      console.warn("==> AUTH STATE CHANGED, user:", user ? user.uid : null);

      // === –í–°–¢–ê–í–¨ –í–û–¢ –ó–î–ï–°–¨ ===
      const authBlock = document.getElementById("authBlock");
      const mainUI = document.getElementById("mainUI");

      const loginBtn = document.getElementById("loginButton");
      const logoutBtn = document.getElementById("logoutButton");
      const registerBlock = document.getElementById("registerBlock");

      if (user) {
        authBlock?.classList.add("hidden");
        registerBlock?.classList.add("hidden");
        mainUI?.classList.remove("hidden");

      } else {
        authBlock?.classList.remove("hidden");
        registerBlock?.classList.add("hidden"); // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä—É—á–Ω–æ–º—É –∫–ª–∏–∫—É
        mainUI?.classList.add("hidden");
      }
      // === –ö–û–ù–ï–¶ –í–°–¢–ê–í–ö–ò ===

      if (!user) {
        window.appState.selectedItems = [];
        window.renderCart();
        window.updateCartButtons([]);
      }
    });
  });
});



</script>
</div> <!-- –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π –¥–∏–≤ -->
<footer class="text-center text-sm text-gray-300 mt-4">
  üî© Alle Rechte an Muttern und Schrauben vorbehalten :) 
</footer>
<script src="firebase-setup.js" type="module"></script>

</body>
</html>
